<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
<meta name="baidu-site-verification" content="code-ULv5esGRN0" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lucksun.work","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="凛冬散尽，星河长明">
<meta property="og:type" content="website">
<meta property="og:title" content="Luck_SUN">
<meta property="og:url" content="http://lucksun.work/index.html">
<meta property="og:site_name" content="Luck_SUN">
<meta property="og:description" content="凛冬散尽，星河长明">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Luck_SUN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://lucksun.work/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Luck_SUN</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6cbaa2e8cde5f381abcb1a50f8cdfc86";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Luck_SUN" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Luck_SUN</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">43</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">7</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/sunwenwei" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/c8cb5db9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/c8cb5db9/" class="post-title-link" itemprop="url">【Angular网易云】--30、总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-17 17:23:38 / 修改时间：16:25:33" itemprop="dateCreated datePublished" datetime="2021-01-17T17:23:38+08:00">2021-01-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>462</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="后续修改"><a href="#后续修改" class="headerlink" title="后续修改"></a>后续修改</h1><p>在完成了主要的功能之后，就是准备对环境以及小优化进行修正，比如页面的标题实现动态改变或者刷新页面时添加顶部的进度条，其中最重要的就是实现路由懒加载以及配置proxy跨域。</p>
<h1 id="关于课程"><a href="#关于课程" class="headerlink" title="关于课程"></a>关于课程</h1><p>关于本课程我是在B站中观看的，在刷一波up主的地址</p>
<blockquote>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://space.bilibili.com/142925973?spm_id_from=333.788.b_765f7570696e666f.1">B站视频地址——会js的诸葛村夫</a></strong></li>
</ul>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>刚开始接触angular时是我刚开始实习工作的时候，当时公司主要框架就是使用angular，所以就开始在练手的项目中使用angular，，在之后接手项目的时候，开始接触UI库，主要是使用nz-zorro，实现的也是后台管理系统这种相对比难度较小的项目。但是越是依赖组件库就越是感觉框架的难度。所以在摒弃之前的舒适度后，想着练手与一个真正使用angularAPI的教程，再次感谢up主的教程。</p>
<p>在结束这个教程之后，相对比之前的懵懂，可能现在会比较清晰一点，但是目前该有的问题仍然是存在，比如说api的覆盖率以及原生js的基础知识，可能有些功能让我重新实现一遍仍然是有难度的。所以在之后的打算中要加强对原生js的理解与使用，并且多看一下angularAPI。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/b51902b1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/b51902b1/" class="post-title-link" itemprop="url">【Angular网易云】--29、注册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-15 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-15T17:23:38+08:00">2021-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h1><p>注册功能是此项目中最后一个功能模块，我原本以为注册的逻辑很简单，没想到如此的繁琐，以至于项目频频短路，而且没有测试用的注册账号，所以在真的注册时并没有拿到相应的数据。</p>
<p>其次还有和收藏分享有关的功能，其基本的实现逻辑与登录等类似，区别之处就是数据的交互并不只是单一的接口，有关数据状态的变更还是要依靠ngrx来检测，所以关于分享与收藏并不打算繁琐的总结了。</p>
<hr>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在登录页面和首页头像处有注册的入口，在点击触发后能够将弹窗显示并且类型为事先定义的register类型。在注册页面注入表单组件能够获取手机号码以及设置密码，然后能够根据密码来调用验证码的发送与判断。.</p>
<h2 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h2><ul>
<li>app.component.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">nz-menu-item</span> (<span class="attr">click</span>)=<span class="string">&quot;openModalByMenu(&#x27;register&#x27;)&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;user-add&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>注册</span><br><span class="line"> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>app.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">      private memberBatchActionsServer: MemberBatchActionsService,</span><br><span class="line">  ) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  openModalByMenu (type: <span class="string">&#x27;loginByPhone&#x27;</span> | <span class="string">&#x27;register&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">&#x27;loginByPhone&#x27;</span>) &#123;</span><br><span class="line">          <span class="built_in">this</span>.openModal(ModalTypes.LoginByPhone);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.openModal(ModalTypes.Register);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 打开弹窗</span></span><br><span class="line">  openModal (type: ModalTypes) &#123;</span><br><span class="line">      <span class="built_in">this</span>.memberBatchActionsServer.controlModal(<span class="literal">true</span>, type);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>弹窗的状态逻辑也是根据之前设置的action实现的。而在首页订阅弹框的显隐状态与类型即可动态的添加浮层。</p>
<hr>
<ul>
<li>wy-layer-register.component.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;register modal-content&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-wrap&quot;</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!showCode else code&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">nz-form</span> <span class="attr">nzLayout</span>=<span class="string">&quot;vertical&quot;</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-label</span>&gt;</span>手机号<span class="tag">&lt;/<span class="name">nz-form-label</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span> <span class="attr">nzHasFeedback</span> <span class="attr">nzErrorTip</span>=<span class="string">&quot;请填写正确的手机号&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-input-group</span> <span class="attr">nzPrefixIcon</span>=<span class="string">&quot;mobile&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;tel&quot;</span> <span class="attr">nz-input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;phone&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-input-group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-label</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">nz-form-label</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span> <span class="attr">nzHasFeedback</span> <span class="attr">nzErrorTip</span>=<span class="string">&quot;请输入密码&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-input-group</span> <span class="attr">nzPrefixIcon</span>=<span class="string">&quot;lock&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">nz-input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入密码&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-input-group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">nz-button</span> <span class="attr">nzBlock</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!formModel.valid&quot;</span>&gt;</span>下一步<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">code</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-wrap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">app-wy-check-code</span></span></span><br><span class="line"><span class="tag">          [<span class="attr">phone</span>]=<span class="string">&quot;formModel.get(&#x27;phone&#x27;).value&quot;</span></span></span><br><span class="line"><span class="tag">          [<span class="attr">codePass</span>]=<span class="string">&quot;codePass&quot;</span></span></span><br><span class="line"><span class="tag">          [<span class="attr">timing</span>]=<span class="string">&quot;timing&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">onCheckCode</span>)=<span class="string">&quot;onCheckCode($event)&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">onReatSendCode</span>)=<span class="string">&quot;sendCode()&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">onCheckExist</span>)=<span class="string">&quot;onCheckExist()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">app-wy-check-code</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-footer clearfix&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> (<span class="attr">click</span>)=<span class="string">&quot;changeType()&quot;</span>&gt;</span><span class="symbol">&amp;lt;</span> 其它登陆方式<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://img-blog.csdnimg.cn/20210116165032470.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"><br>打开页面时会显示表单组件，动态响应输入值后点击下一步即是发送验证码，此时页面会改变，因此可以创建新的组件来单独实现验证码的检查。</p>
<ul>
<li>wy-layer-register.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">enum Exist &#123;</span><br><span class="line">    <span class="string">&#x27;存在&#x27;</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;不存在&#x27;</span> = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;app-wy-layer-register&#x27;</span>,</span><br><span class="line">    templateUrl: <span class="string">&#x27;./wy-layer-register.component.html&#x27;</span>,</span><br><span class="line">    styleUrls: [<span class="string">&#x27;./wy-layer-register.component.less&#x27;</span>],</span><br><span class="line">    changeDetection: ChangeDetectionStrategy.OnPush</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WyLayerRegisterComponent</span> <span class="title">implements</span> <span class="title">OnInit</span>, <span class="title">OnChanges</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Input() visible = <span class="literal">false</span>;</span><br><span class="line">    @Output() onChangeModalType = <span class="keyword">new</span> EventEmitter&lt;string&gt;();</span><br><span class="line">    @Output() onRegister = <span class="keyword">new</span> EventEmitter&lt;string&gt;();</span><br><span class="line"></span><br><span class="line">    showCode = <span class="literal">false</span>;</span><br><span class="line">    formModel: FormGroup;</span><br><span class="line">    timing: number;</span><br><span class="line">    codePass: string | boolean = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        private fb: FormBuilder,</span><br><span class="line">        private message: NzMessageService,</span><br><span class="line">        private memberServe: MemberService,</span><br><span class="line">        private cdr: ChangeDetectorRef</span><br><span class="line">    ) &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes.visible &amp;&amp; !changes.visible.firstChange) &#123;</span><br><span class="line">            <span class="built_in">this</span>.formModel.markAllAsTouched();</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.visible) &#123;</span><br><span class="line">                <span class="built_in">this</span>.showCode = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngOnInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.formModel = <span class="built_in">this</span>.fb.group(&#123;</span><br><span class="line">            phone: [<span class="string">&#x27;&#x27;</span>, [Validators.required, Validators.pattern(<span class="regexp">/^1\d&#123;10&#125;$/</span>)]],</span><br><span class="line">            password: [<span class="string">&#x27;&#x27;</span>, [Validators.required, Validators.minLength(<span class="number">6</span>)]]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onSubmit () &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.formModel.valid) &#123;</span><br><span class="line">            <span class="built_in">this</span>.sendCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sendCode () &#123;</span><br><span class="line">      <span class="built_in">this</span>.memberServe.sendCode(<span class="built_in">this</span>.formModel.get(<span class="string">&#x27;phone&#x27;</span>).value).subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.timing = <span class="number">60</span>;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.showCode) &#123;</span><br><span class="line">                <span class="built_in">this</span>.showCode = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">            interval(<span class="number">1000</span>).pipe(take(<span class="number">60</span>)).subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.timing--;</span><br><span class="line">                <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">this</span>.message.error(error.message))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onCheckCode (code: string) &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberServe.checkCode(<span class="built_in">this</span>.formModel.get(<span class="string">&#x27;phone&#x27;</span>).value, <span class="built_in">Number</span>(code))</span><br><span class="line">            .subscribe(</span><br><span class="line">                () =&gt; <span class="built_in">this</span>.codePass = <span class="literal">true</span>,</span><br><span class="line">                () =&gt; <span class="built_in">this</span>.codePass = <span class="literal">false</span>,</span><br><span class="line">                () =&gt; <span class="built_in">this</span>.cdr.markForCheck()</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    onCheckExist () &#123;</span><br><span class="line">        <span class="keyword">const</span> phone = <span class="built_in">this</span>.formModel.get(<span class="string">&#x27;phone&#x27;</span>).value;</span><br><span class="line">        <span class="built_in">this</span>.memberServe.checkExist(<span class="built_in">Number</span>(phone)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;checkExist&#x27;</span>, res);</span><br><span class="line">            <span class="keyword">if</span> (Exist[res] === <span class="string">&#x27;存在&#x27;</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.message.error(<span class="string">&#x27;账号已存在，可直接登陆&#x27;</span>);</span><br><span class="line">                <span class="built_in">this</span>.changeType(ModalTypes.LoginByPhone);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.onRegister.emit(phone);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    changeType (type = ModalTypes.Default) &#123;</span><br><span class="line">        <span class="built_in">this</span>.onChangeModalType.emit(type);</span><br><span class="line">        <span class="built_in">this</span>.showCode = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.formModel.reset()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输入手机号与密码之后点击下一步将会触发onSubmit中sendCode回调，其中有段timer的递减是用来提示重新发送验证码的倒计时，，其中有点问题的就是变更监测的模式是使用了onPush策略，所以timer的递减后传给验证码组件时就会出现停顿的现象，，此时要手动的触发变更监测。就是使用ChangeDelectorRef类型中markForCheck方法。</p>
<hr>
<h2 id="验证码组件"><a href="#验证码组件" class="headerlink" title="验证码组件"></a>验证码组件</h2><ul>
<li>wy-check-code.component.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;check-code&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;js-mobwrap&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;s-fc3&quot;</span>&gt;</span></span><br><span class="line">        你的手机号：</span><br><span class="line">        <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">&quot;s-fc1&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;js-mob&quot;</span>&gt;</span>&#123;&#123;phone&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;s-fc4&quot;</span>&gt;</span>为了安全，我们会给您发送短信验证码<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">nz-form</span> <span class="attr">nzLayout</span>=<span class="string">&quot;vertical&quot;</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">app-wy-code</span> <span class="attr">formControlName</span>=<span class="string">&quot;code&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-code</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;send clearfix&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;err&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!showErrorTip&quot;</span>&gt;</span>验证码不正确<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;txt&quot;</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!showRepeatBtn else repeatBtn&quot;</span>&gt;</span>&#123;&#123;timing&#125;&#125;s<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">repeatBtn</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;txt repeat&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onReatSendCode.emit()&quot;</span>&gt;</span>重新发送<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">nzBlock</span>&gt;</span>下一步<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://img-blog.csdnimg.cn/20210116185731102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<p>此页面是下一步后的跳转页面，其中红色框中的验证码输入内容及逻辑放在了新的组件中。</p>
<ul>
<li>wy-check-code.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">private phoneHideStr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">formModel: FormGroup;</span><br><span class="line">showRepeatBtn = <span class="literal">false</span>;</span><br><span class="line">showErrorTip = <span class="literal">false</span>;</span><br><span class="line">@Input() codePass = <span class="literal">false</span>;</span><br><span class="line">@Input() timing: number;</span><br><span class="line">@Input()</span><br><span class="line">set phone (phone: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> arr = phone.split(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    arr.splice(<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;****&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>.phoneHideStr = arr.join(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get phone () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.phoneHideStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Output() onCheckCode = <span class="keyword">new</span> EventEmitter&lt;string&gt;();</span><br><span class="line">@Output() onReatSendCode = <span class="keyword">new</span> EventEmitter&lt;string&gt;();</span><br><span class="line">@Output() onCheckExist = <span class="keyword">new</span> EventEmitter&lt;<span class="keyword">void</span>&gt;();</span><br><span class="line"><span class="keyword">constructor</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">ngOnInit () &#123;</span><br><span class="line">    <span class="built_in">this</span>.formModel = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">        code: <span class="keyword">new</span> FormControl(<span class="string">&#x27;&#x27;</span>, [Validators.required, Validators.pattern(<span class="regexp">/\d&#123;4&#125;/</span>)])</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> codeControl = <span class="built_in">this</span>.formModel.get(<span class="string">&#x27;code&#x27;</span>);</span><br><span class="line">    codeControl.statusChanges.subscribe(<span class="function"><span class="params">status</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (status === <span class="string">&#x27;VALID&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onCheckCode.emit(<span class="built_in">this</span>.formModel.value.code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (changes.timing) &#123;</span><br><span class="line">        <span class="built_in">this</span>.showRepeatBtn = <span class="built_in">this</span>.timing &lt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changes.codePass &amp;&amp; !changes.codePass.firstChange) &#123;</span><br><span class="line">        <span class="built_in">this</span>.showErrorTip = !<span class="built_in">this</span>.codePass;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">onSubmit () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.formModel.valid &amp;&amp; <span class="built_in">this</span>.codePass) &#123;</span><br><span class="line">        <span class="built_in">this</span>.onCheckExist.emit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>页面初始化时，会创建表单组件，添加表单控制器code。因为在展示手机号的时候要对数据加密，所以添加了对手机号二次处理的set、get方法。然后对表单控制器属性添加状态监测，当表单验证通过时会将输入的验证码发射出去，然后调用验证接口。</p>
<h2 id="处理验证码"><a href="#处理验证码" class="headerlink" title="处理验证码"></a>处理验证码</h2><p>验证码的输入逻辑以及样式放在了单独的组件中。但是验证逻辑仍然在父组件中，所以关于其输入的结构都会在父层做处理。</p>
<ul>
<li>wy-code.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;code-wrap clearfix&quot;</span> #<span class="attr">codeWrap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;u-word&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of inputArr; index as i&quot;</span> [<span class="attr">class.focus</span>]=<span class="string">&quot;result[i]&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span> <span class="attr">maxlength</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>这里是循环了四个输入框，但是样式上有点小复杂，自己尝试实现，未果！</p>
<ul>
<li>wy-code.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CODELEN = <span class="number">4</span>;</span><br><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;app-wy-code&#x27;</span>,</span><br><span class="line">    templateUrl: <span class="string">&#x27;./wy-code.component.html&#x27;</span>,</span><br><span class="line">    styleUrls: [<span class="string">&#x27;./wy-code.component.less&#x27;</span>],</span><br><span class="line">    providers: [</span><br><span class="line">        &#123;</span><br><span class="line">            provide: NG_VALUE_ACCESSOR,</span><br><span class="line">            useExisting: forwardRef(<span class="function">() =&gt;</span> WyCodeComponent),</span><br><span class="line">            multi: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WyCodeComponent</span> <span class="title">implements</span> <span class="title">OnInit</span>, <span class="title">ControlValueAccessor</span> </span>&#123;</span><br><span class="line">    inputArr = [];</span><br><span class="line">    inputsEl: HTMLElement[];</span><br><span class="line">    private code: string;</span><br><span class="line"></span><br><span class="line">    result: string[] = [];</span><br><span class="line">    currentFocusIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    private destory$ = <span class="keyword">new</span> Subject();</span><br><span class="line">    @ViewChild(<span class="string">&#x27;codeWrap&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) private codeWrap: ElementRef;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(private cdr: ChangeDetectorRef) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    ngOnInit () &#123;</span><br><span class="line">        <span class="built_in">this</span>.inputArr = <span class="built_in">Array</span>(CODELEN).fill(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngAfterViewInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.inputsEl = <span class="built_in">this</span>.codeWrap.nativeElement.getElementsByClassName(<span class="string">&#x27;item&#x27;</span>) <span class="keyword">as</span> HTMLElement[];</span><br><span class="line">        <span class="built_in">this</span>.inputsEl[<span class="number">0</span>].focus();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> a = <span class="number">0</span>; a &lt; <span class="built_in">this</span>.inputsEl.length; a++) &#123;</span><br><span class="line">            <span class="keyword">const</span> item = <span class="built_in">this</span>.inputsEl[a];</span><br><span class="line">            fromEvent(item, <span class="string">&#x27;keyup&#x27;</span>).pipe(takeUntil(<span class="built_in">this</span>.destory$)).subscribe(<span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> <span class="built_in">this</span>.listenKeyUp(event));</span><br><span class="line">            fromEvent(item, <span class="string">&#x27;click&#x27;</span>).pipe(takeUntil(<span class="built_in">this</span>.destory$)).subscribe(<span class="function">() =&gt;</span> <span class="built_in">this</span>.currentFocusIndex = a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private listenKeyUp (event: KeyboardEvent) &#123;</span><br><span class="line">        <span class="keyword">const</span> target = event.target <span class="keyword">as</span> HTMLInputElement;</span><br><span class="line">        <span class="keyword">const</span> value = target.value;</span><br><span class="line">        <span class="keyword">const</span> isBackSpace = event.key === <span class="string">&quot;Backspace&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/\D/</span>.test(value)) &#123;</span><br><span class="line">            target.value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="built_in">this</span>.result[<span class="built_in">this</span>.currentFocusIndex] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.result[<span class="built_in">this</span>.currentFocusIndex] = value;</span><br><span class="line">            <span class="built_in">this</span>.currentFocusIndex = (<span class="built_in">this</span>.currentFocusIndex + <span class="number">1</span>) % CODELEN;</span><br><span class="line">            <span class="built_in">this</span>.inputsEl[<span class="built_in">this</span>.currentFocusIndex].focus();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBackSpace) &#123;</span><br><span class="line">            <span class="built_in">this</span>.result[<span class="built_in">this</span>.currentFocusIndex] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="built_in">this</span>.currentFocusIndex = <span class="built_in">Math</span>.max(<span class="built_in">this</span>.currentFocusIndex - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">this</span>.inputsEl[<span class="built_in">this</span>.currentFocusIndex].focus();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.checkResult(<span class="built_in">this</span>.result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private checkResult (result: string[]) &#123;</span><br><span class="line">        <span class="keyword">const</span> codeStr = result.join(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.setValue(codeStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private setValue (code: string) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.onValueChange(code);</span><br><span class="line">        <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private onValueChange (value: string): <span class="keyword">void</span> &#123; &#125;</span><br><span class="line">    private onTouched (): <span class="keyword">void</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    writeValue (code: string): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setValue(code);</span><br><span class="line">    &#125;</span><br><span class="line">    registerOnChange (fn: <span class="function">(<span class="params">value: string</span>) =&gt;</span> <span class="keyword">void</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onValueChange = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    registerOnTouched (fn: <span class="function">() =&gt;</span> <span class="keyword">void</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onTouched = fn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngOnDestroy (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.destory$.next();</span><br><span class="line">        <span class="built_in">this</span>.destory$.complete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当组件视图初始化之后会对四个输入框进行监听，对删除键的交互以及匹配输入值不能为数值以外的其他值。</p>
<p><strong>其中使用了自定义表单控件ControlValueAccessor，关于这个知识点我的能力是解释不清楚的，再看了一些博客和介绍之后，推荐有兴趣的可以去看一下这篇文章：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014129567">别再对 Angular 表单的 ControlValueAccessor 感到迷惑</a></strong></p>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/359b25ac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/359b25ac/" class="post-title-link" itemprop="url">【Angular网易云】--28、个人中心</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-14 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-14T17:23:38+08:00">2021-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="个人中心"><a href="#个人中心" class="headerlink" title="个人中心"></a>个人中心</h1><p>个人中心是展示当前登录人信息的一个模块，关于最近听歌排行以及创建的歌单和收藏的歌单列表等。其入口是在首页登录后头像的展示位置处。</p>
<p><img data-src="https://img-blog.csdnimg.cn/20210115170900933.png"></p>
<hr>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><ul>
<li>app.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">nz-menu-item</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/member&#x27;, user.profile.userId]&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;user&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>我的主页</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">nz-menu-item</span> (<span class="attr">click</span>)=<span class="string">&quot;onLogout()&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;close-circle&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>退出</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
当点击li标签时将当前登录人的ID传给个人中心模块。</li>
</ul>
<hr>
<h2 id="创建个人中心模块"><a href="#创建个人中心模块" class="headerlink" title="创建个人中心模块"></a>创建个人中心模块</h2><p>使用指令在pages目录下创建模块和组件：<br><img data-src="https://img-blog.csdnimg.cn/20210115171421785.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<hr>
<h2 id="为组件添加路由"><a href="#为组件添加路由" class="headerlink" title="为组件添加路由"></a>为组件添加路由</h2><ul>
<li>member-routing.module.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;member/:id&#x27;</span>, <span class="attr">component</span>: CenterComponent, <span class="attr">data</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;个人中心&#x27;</span> &#125;, <span class="attr">resolve</span>: &#123; <span class="attr">user</span>: CenterResolverService &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;records/:id&#x27;</span>, <span class="attr">component</span>: RecordDetailComponent, <span class="attr">data</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;听歌记录&#x27;</span> &#125;, <span class="attr">resolve</span>: &#123; <span class="attr">user</span>: RecordResolverService &#125; &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">    imports: [RouterModule.forChild(routes)],</span><br><span class="line">    <span class="built_in">exports</span>: [RouterModule],</span><br><span class="line">    providers: [CenterResolverService, RecordResolverService]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberRoutingModule</span> </span>&#123; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
其中使用了路由守卫来保证数据的完整。</li>
</ul>
<hr>
<h2 id="调用API"><a href="#调用API" class="headerlink" title="调用API"></a>调用API</h2><p>根据返回值创建返回值类型</p>
<ul>
<li>member.types.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type RecordVal = &#123;</span><br><span class="line">    playCount: number;</span><br><span class="line">    score: number;</span><br><span class="line">    song: Song;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type recordKeys = <span class="string">&#x27;weekData&#x27;</span> | <span class="string">&#x27;allData&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type UserRecord = &#123;</span><br><span class="line">    [key <span class="keyword">in</span> recordKeys]: RecordVal[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type UserSheet = &#123;</span><br><span class="line">    self: SongSheet[];</span><br><span class="line">    subscribed: SongSheet[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>member.service.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> enum RecordType &#123;</span><br><span class="line">    allData,</span><br><span class="line">    weekData,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 获取听歌记录</span></span><br><span class="line">    getUserRecord (uid: string, type = RecordType.weekData): Observable&lt;RecordVal[]&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">&quot;query-string&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromString</span>: querystring.stringify(&#123; uid, type &#125;) &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;user/record&#x27;</span>, &#123; params &#125;).pipe(</span><br><span class="line">            map(<span class="function">(<span class="params">res: UserRecord</span>) =&gt;</span> res[RecordType[type]])</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户歌单</span></span><br><span class="line">    getUserSheets (uid: string): Observable&lt;UserSheet&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;uid&#x27;</span>, uid);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;user/playlist&#x27;</span>, &#123; params &#125;).pipe(</span><br><span class="line">            map(<span class="function">(<span class="params">res: &#123; playlist: SongSheet[] &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> list = res.playlist;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    self: list.filter(<span class="function"><span class="params">item</span> =&gt;</span> !item.subscribed),</span><br><span class="line">                    subscribed: list.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.subscribed)</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h2 id="添加路由守卫"><a href="#添加路由守卫" class="headerlink" title="添加路由守卫"></a>添加路由守卫</h2><p>因为使用了路由守卫，所以可以将需要的数据统一通过守卫来传递。</p>
<ul>
<li>center-resolve.service.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(</span><br><span class="line">    private memberServe: MemberService,</span><br><span class="line">    private router: Router</span><br><span class="line">) &#123; &#125;</span><br><span class="line"></span><br><span class="line">resolve (route: ActivatedRouteSnapshot): Observable&lt;CenterDataType&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> uid = route.paramMap.get(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid) &#123;</span><br><span class="line">        <span class="keyword">return</span> forkJoin([</span><br><span class="line">            <span class="built_in">this</span>.memberServe.getUserInfo(uid),</span><br><span class="line">            <span class="built_in">this</span>.memberServe.getUserRecord(uid),</span><br><span class="line">            <span class="built_in">this</span>.memberServe.getUserSheets(uid),</span><br><span class="line">        ]).pipe(first());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.router.navigate([<span class="string">&#x27;/home&#x27;</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>record-resolve.service.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">type RecordDataType = [User, RecordVal[]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        private memberServe: MemberService,</span><br><span class="line">        private router: Router</span><br><span class="line">    ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    resolve (route: ActivatedRouteSnapshot): Observable&lt;RecordDataType&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> uid = route.paramMap.get(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> forkJoin([</span><br><span class="line">                <span class="built_in">this</span>.memberServe.getUserInfo(uid),</span><br><span class="line">                <span class="built_in">this</span>.memberServe.getUserRecord(uid),</span><br><span class="line">            ]).pipe(first());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.router.navigate([<span class="string">&#x27;/home&#x27;</span>])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h2><ul>
<li>center.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CenterComponent</span> <span class="title">implements</span> <span class="title">OnInit</span>, <span class="title">OnDestroy</span> </span>&#123;</span><br><span class="line">    user: User;</span><br><span class="line">    records: RecordVal[];</span><br><span class="line">    userSheet: UserSheet;</span><br><span class="line">    recordType = RecordType.weekData;</span><br><span class="line"></span><br><span class="line">    private currentSong: Song;</span><br><span class="line">    currentIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    private destory$ = <span class="keyword">new</span> Subject();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        private route: ActivatedRoute,</span><br><span class="line">        private sheetServe: SheetService,</span><br><span class="line">        private playerBatchActionsServer: PlayerBatchActionsService,</span><br><span class="line">        private message: NzMessageService,</span><br><span class="line">        private songServe: SongService,</span><br><span class="line">        private memberServe: MemberService,</span><br><span class="line">        private cdr: ChangeDetectorRef,</span><br><span class="line">        private store$: Store&lt;AppModule&gt;</span><br><span class="line">    ) &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngOnInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.route.data.pipe(map(<span class="function"><span class="params">res</span> =&gt;</span> res.user)).subscribe(<span class="function">(<span class="params">[user, userRecord, userSheet]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.user = user;</span><br><span class="line">            <span class="built_in">this</span>.records = userRecord;</span><br><span class="line">            <span class="built_in">this</span>.userSheet = userSheet;</span><br><span class="line">            <span class="built_in">this</span>.listenCurrentSong();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private listenCurrentSong () &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.pipe(select(getPlayer), select(getCurrentSong), takeUntil(<span class="built_in">this</span>.destory$)).subscribe(<span class="function"><span class="params">song</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.currentSong = song;</span><br><span class="line">            <span class="keyword">if</span> (song) &#123;</span><br><span class="line">                <span class="keyword">const</span> songs = <span class="built_in">this</span>.records.map(<span class="function"><span class="params">res</span> =&gt;</span> res.song);</span><br><span class="line">                <span class="built_in">this</span>.currentIndex = findIndex(songs, song);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.currentIndex = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点击歌单，获取歌单信息</span></span><br><span class="line">    onPlaySheet (id: number) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sheetServe.playSheet(id).subscribe(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.playerBatchActionsServer.selectPlayList(&#123; list, <span class="attr">index</span>: <span class="number">0</span> &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onAddSong ([song, isPlay]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.currentSong || <span class="built_in">this</span>.currentSong.id !== song.id) &#123;</span><br><span class="line">            <span class="built_in">this</span>.songServe.getSongList(song)</span><br><span class="line">                .subscribe(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (list.length) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.playerBatchActionsServer.insertSong(list[<span class="number">0</span>], isPlay);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.message.create(<span class="string">&#x27;warning&#x27;</span>, <span class="string">&#x27;无url!&#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onChangeType (type: RecordType) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.recordType !== type) &#123;</span><br><span class="line">            <span class="built_in">this</span>.recordType = type;</span><br><span class="line">            <span class="built_in">this</span>.memberServe.getUserRecord(<span class="built_in">this</span>.user.profile.userId.toString(), type).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.records = res.slice(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">                <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngOnDestroy (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.destory$.next();</span><br><span class="line">        <span class="built_in">this</span>.destory$.complete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化页面的时候，首先将路由守卫中获取到的数据储存起来，然后开始使用Store监听当前歌曲，根据当前歌曲来获取歌曲索引，并在页面显示高亮。其余逻辑与歌单列表相似，添加到歌单以及播放都是使用封装好的actions进行状态操作。当页面销毁的时候的，能够给监听解绑，此时可以使用生命周期钩子，当销毁钩子触发时，调用多播可观察对象的destory$变量的next方法，当Store中takeUntil检测到该变量触发时，就会解绑监听。</p>
<p><img data-src="https://img-blog.csdnimg.cn/20210115204043476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>子组件的用法很灵活，可以将动作设置在子组件内，也可以让子组件仅当做展示页面所有的事件触发都利用组件之间传值来实现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/a80028c9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/a80028c9/" class="post-title-link" itemprop="url">【Angular网易云】--27、HTTP拦截器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-13 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-13T17:23:38+08:00">2021-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HTTP拦截"><a href="#HTTP拦截" class="headerlink" title="HTTP拦截"></a>HTTP拦截</h1><p>在做请求的时，有时需要对请求做一些配置上的附加或者改变，又或者是对响应值的拦截，这时候就需要拦截器了。</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>签到时需要登录状态，而状态值存在cookies中，所以在每次请求时都需要将cookies一起发送过去，因此添加HTTP拦截器来拦截请求并作出配置上的改变。</p>
<p>XMLHttpRequest类型的 withCredentials属性指示是否使用类似的cookies，因此将其设置为true即可。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-cn/docs/web/api/xmlhttprequest/withcredentials">XMLHttpRequest.withCredentials</a><br>XMLHttpRequest.withCredentials  属性是一个Boolean类型，它指示了是否该使用类似cookies,authorization headers(头部授权)或者TLS客户端证书这一类资格证书来创建一个跨站点访问控制（cross-site Access-Control）请求。在同一个站点下使用withCredentials属性是无效的。</p>
</blockquote>
<blockquote>
<p>此外，这个指示也会被用做响应中cookies 被忽视的标示。默认值是false。</p>
</blockquote>
<blockquote>
<p>如果在发送来自其他域的XMLHttpRequest请求之前，未设置withCredentials 为true，那么就不能为它自己的域设置cookie值。而通过设置withCredentials 为true获得的第三方cookies，将会依旧享受同源策略，因此不能被通过document.cookie或者从头部相应请求的脚本等访问。</p>
</blockquote>
<pre><code>不同域下的XmlHttpRequest 响应
不论其Access-Control- header 设置什么值
都无法为它自身站点设置cookie值
除非它在请求之前将withCredentials 设为true。</code></pre>
<hr>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>创建http-interceptors文件夹，新增common.interceptor.ts文件和index.ts文件</p>
<ul>
<li>common.interceptor.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpErrorResponse, HttpEvent, HttpHandler, HttpInterceptor, HttpRequest &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/internal/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line">    intercept (req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> next.handle(req.clone(&#123;</span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;)).pipe(catchError(<span class="built_in">this</span>.handleError))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 错误处理</span></span><br><span class="line">    private handleError (error: HttpErrorResponse): never &#123;</span><br><span class="line">        <span class="keyword">throw</span> error.error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>intercept 方法会把请求转换成一个最终返回 HTTP 响应体的 Observable。 在这个场景中，每个拦截器都完全能自己处理这个请求。大多数拦截器拦截都会在传入时检查请求，然后把（可能被修改过的）请求转发给 next 对象的 handle() 方法，而 next 对象实现了 HttpHandler 接口。</strong></p>
</blockquote>
<blockquote>
<p><strong>像 intercept() 一样，handle() 方法也会把 HTTP 请求转换成 HttpEvents 组成的 Observable，它最终包含的是来自服务器的响应。 intercept() 函数可以检查这个可观察对象，并在把它返回给调用者之前修改它。</strong></p>
</blockquote>
<p><strong>如果你必须修改一个请求，先把它克隆一份，修改这个克隆体后再把它传给 next.handle()</strong></p>
<p>所以将添加了跨站点访问配置的副本返回出去并且加上一个错误处理就写好了一个拦截器。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>如果拦截器比较多，其建议将其包含在数组中，将数组注入到服务模块中。</p>
<ul>
<li>index.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HTTP_INTERCEPTORS &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CommonInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;./common.interceptor&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> httpInterceptorProvides = [</span><br><span class="line">    &#123; <span class="attr">provide</span>: HTTP_INTERCEPTORS, <span class="attr">useClass</span>: CommonInterceptor, <span class="attr">multi</span>: <span class="literal">true</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>注意 multi: true 选项。 这个必须的选项会告诉 Angular HTTP_INTERCEPTORS 是一个多重提供者的令牌，表示它会注入一个多值的数组，而不是单一的值。</strong></p>
<ul>
<li>services.module.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; InjectionToken, NgModule &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; httpInterceptorProvides &#125; <span class="keyword">from</span> <span class="string">&quot;./http-interceptors&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> API_CONFIG = <span class="keyword">new</span> InjectionToken(<span class="string">&quot;ApiconfigToken&quot;</span>);</span><br><span class="line">@NgModule(&#123;</span><br><span class="line">    declarations: [],</span><br><span class="line">    imports: [],</span><br><span class="line">    providers: [</span><br><span class="line">        &#123; <span class="attr">provide</span>: API_CONFIG, <span class="attr">useValue</span>: <span class="string">&quot;http://localhost:3000/&quot;</span> &#125;,</span><br><span class="line">        httpInterceptorProvides</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ServicesModule</span> </span>&#123; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/d4e2d6d6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/d4e2d6d6/" class="post-title-link" itemprop="url">【Angular网易云】--26、登录/登出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-12 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-12T17:23:38+08:00">2021-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="登录实现"><a href="#登录实现" class="headerlink" title="登录实现"></a>登录实现</h1><p>就目前的进度来看，是没有实现token验证的，所以所有的登录也只是简单的验证账密，即使账密的复写也只是存在localstorage内存中的，所以关于更加安全的登录不知道后面会不会修改。<br><img data-src="https://img-blog.csdnimg.cn/20210114194342967.png" alt="在这里插入图片描述"><br><img data-src="https://img-blog.csdnimg.cn/20210114194352305.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="切换弹窗页面"><a href="#切换弹窗页面" class="headerlink" title="切换弹窗页面"></a>切换弹窗页面</h2><p>开始实现的default页面只是用来判断登录还是注册，所以说这一步的操作还是要更换弹窗内的渲染内容的。</p>
<pre><code>将创建好的登录模块和注册模块添加到
app.component.html中的wy-layer-modal标签内。</code></pre>
<ul>
<li><p>app.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-wy-layer-modal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-wy-layer-login</span> <span class="attr">name</span>=<span class="string">&quot;login&quot;</span> [<span class="attr">wyRememberLogin</span>]=<span class="string">&quot;wyRememberLogin&quot;</span> (<span class="attr">onChangeModalType</span>)=<span class="string">&quot;onChangeModalType($event)&quot;</span> (<span class="attr">onLogin</span>)=<span class="string">&quot;onLogin($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-layer-login</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-wy-layer-default</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span> (<span class="attr">onChangeModalType</span>)=<span class="string">&quot;onChangeModalType($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-layer-default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-wy-layer-register</span> <span class="attr">name</span>=<span class="string">&quot;register&quot;</span> (<span class="attr">onChangeModalType</span>)=<span class="string">&quot;onChangeModalType($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-layer-register</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-wy-layer-modal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样在选择弹框子页面时根据name值来判断。</p>
</li>
<li><p>app.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">nz-menu-item</span> (<span class="attr">click</span>)=<span class="string">&quot;openModalByMenu(&#x27;loginByPhone&#x27;)&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;mobile&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>手机登录</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">nz-menu-item</span> (<span class="attr">click</span>)=<span class="string">&quot;openModalByMenu(&#x27;register&#x27;)&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;user-add&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>注册</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>app.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private memberBatchActionsServer: MemberBatchActionsService,</span><br><span class="line"></span><br><span class="line">openModalByMenu (type: <span class="string">&#x27;loginByPhone&#x27;</span> | <span class="string">&#x27;register&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;loginByPhone&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.openModal(ModalTypes.LoginByPhone);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.openModal(ModalTypes.Register);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开弹窗</span></span><br><span class="line">openModal (type: ModalTypes) &#123;</span><br><span class="line">    <span class="built_in">this</span>.memberBatchActionsServer.controlModal(<span class="literal">true</span>, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当点击登录或者注册时，就会通过参数的不通来判断当前需要设置哪一种状态，当wy-layer-modal中的Store监听到状态的改变就会根据当前改变后的状态改变渲染内容。因此在占位处使用<strong>ngSwitch</strong>指令。</p>
</li>
</ul>
<ul>
<li>wy-layer-modal.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ng-container</span> [<span class="attr">ngSwitch</span>]=<span class="string">&quot;currentModalType&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngSwitchCase</span>=<span class="string">&quot;&#x27;loginByPhone&#x27;&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">ng-content</span> <span class="attr">select</span>=<span class="string">&quot;[name=login]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngSwitchCase</span>=<span class="string">&quot;&#x27;register&#x27;&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">ng-content</span> <span class="attr">select</span>=<span class="string">&quot;[name=register]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngSwitchDefault</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">ng-content</span> &gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><em>有关<a target="_blank" rel="noopener" href="https://angular.cn/api/common/NgSwitch">ngSwitch</a>指令的使用可以点击浏览</em></p>
<hr>
<h2 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h2><ul>
<li>member.service.ts<br>登录后需要显示当前登录人的一些信息，所以也需要获取当前登录人的个别数据。</li>
</ul>
<p><img data-src="https://img-blog.csdnimg.cn/20210114201822368.png" alt="在这里插入图片描述"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录</span></span><br><span class="line"> login (formValue: LoginParams): Observable&lt;User&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">&quot;querystring&quot;</span>);</span><br><span class="line">     <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromString</span>: querystring.stringify(formValue) &#125;);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;stringify:&#x27;</span>, params);</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;login/cellphone&#x27;</span>, &#123; params &#125;).pipe(</span><br><span class="line">         map(<span class="function"><span class="params">res</span> =&gt;</span> res <span class="keyword">as</span> User)</span><br><span class="line">     )</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 获取用户信息</span></span><br><span class="line"> getUserInfo (uid: string): Observable&lt;User&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;uid&#x27;</span>, uid);</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;user/detail&#x27;</span>, &#123; params &#125;).pipe(</span><br><span class="line">         map(<span class="function"><span class="params">res</span> =&gt;</span> res <span class="keyword">as</span> User)</span><br><span class="line">     )</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 退出</span></span><br><span class="line"> logOut (): Observable&lt;SampleBack&gt; &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;logout&#x27;</span>).pipe(</span><br><span class="line">         map(<span class="function"><span class="params">res</span> =&gt;</span> res <span class="keyword">as</span> SampleBack)</span><br><span class="line">     );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里出了一点问题： 在格式化数据的时候，使用query-string类的时候一直报错，虽然使用了一些解决方案，但是都是不起效的。然后就用了最原始的require引用，这点还真是不明白为什么 </p>
</blockquote>
<hr>
<h2 id="响应式表单"><a href="#响应式表单" class="headerlink" title="响应式表单"></a>响应式表单</h2><ul>
<li>wy-layer-login.component.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-phone modal-content&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-wrap&quot;</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">nz-form</span> <span class="attr">class</span>=<span class="string">&quot;login-form&quot;</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span> <span class="attr">nzHasFeedback</span> <span class="attr">nzErrorTip</span>=<span class="string">&quot;请输入正确的手机号&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-input-group</span> <span class="attr">nzPrefixIcon</span>=<span class="string">&quot;mobile&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;tel&quot;</span> <span class="attr">nz-input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;phone&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-input-group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span> <span class="attr">nzHasFeedback</span> <span class="attr">nzErrorTip</span>=<span class="string">&quot;请输入正确的密码&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-input-group</span> <span class="attr">nzPrefixIcon</span>=<span class="string">&quot;lock&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">nz-input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入密码&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-input-group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tools&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">nz-checkbox</span> <span class="attr">class</span>=<span class="string">&quot;remember&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;remember&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>记住密码<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">nz-button</span> <span class="attr">class</span>=<span class="string">&quot;login-form-button&quot;</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!formModel.valid&quot;</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">nzBlock</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nz-form-control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-form-item</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-footer clearfix&quot;</span>&gt;</span></span><br><span class="line">    &lt;a (click)=&quot;onChangeModalType.emit(&#x27;default&#x27;)&quot;&gt; &lt; 其它登陆方式&lt;/a&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> (<span class="attr">click</span>)=<span class="string">&quot;onChangeModalType.emit(&#x27;register&#x27;)&quot;</span>&gt;</span>没有账号？免费注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>wy-layer-login.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type LoginParams = &#123;</span><br><span class="line">    phone: number,</span><br><span class="line">    password: string,</span><br><span class="line">    remember: boolean,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    formModel: FormGroup;</span><br><span class="line">    @Input() wyRememberLogin: LoginParams;</span><br><span class="line"></span><br><span class="line">    @Output() onChangeModalType = <span class="keyword">new</span> EventEmitter&lt;string | <span class="keyword">void</span>&gt;();</span><br><span class="line">    @Output() onLogin = <span class="keyword">new</span> EventEmitter&lt;LoginParams&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(private fb: FormBuilder) &#123; &#125;</span><br><span class="line">    ngOnInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.formModel = <span class="built_in">this</span>.fb.group(&#123;</span><br><span class="line">            phone: [<span class="string">&#x27;&#x27;</span>, [Validators.required, Validators.pattern(<span class="regexp">/^1\d&#123;10&#125;$/</span>)]],</span><br><span class="line">            password: [<span class="string">&#x27;&#x27;</span>, [Validators.required, Validators.minLength(<span class="number">6</span>)]],</span><br><span class="line">            remember: [<span class="literal">false</span>]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userLoginParams = changes.wyRememberLogin;</span><br><span class="line">        <span class="keyword">if</span> (userLoginParams) &#123;</span><br><span class="line">            <span class="keyword">let</span> phone = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> password = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> remember = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (userLoginParams.currentValue) &#123;</span><br><span class="line">                <span class="keyword">const</span> value = codeJson(userLoginParams.currentValue, <span class="string">&#x27;decode&#x27;</span>);</span><br><span class="line">                phone = value.phone;</span><br><span class="line">                password = value.password;</span><br><span class="line">                remember = value.remember;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.setModal(&#123; phone, password, remember &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private setModal (&#123; phone, password, remember &#125;) &#123;</span><br><span class="line">        <span class="built_in">this</span>.formModel = <span class="built_in">this</span>.fb.group(&#123;</span><br><span class="line">            phone: [phone, [Validators.required, Validators.pattern(<span class="regexp">/^1\d&#123;10&#125;$/</span>)]],</span><br><span class="line">            password: [password, [Validators.required, Validators.minLength(<span class="number">6</span>)]],</span><br><span class="line">            remember: [remember]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onSubmit () &#123;</span><br><span class="line">        <span class="keyword">const</span> modal = <span class="built_in">this</span>.formModel;</span><br><span class="line">        <span class="keyword">if</span> (modal.valid) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onLogin.emit(modal.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
使用formbuilder模块能够快速的创建表单类，使用其来创建一个包含手机号，密码和复选框的一个组，然后再DOM中绑定其formname属性即可。<br><img data-src="https://img-blog.csdnimg.cn/20210114203021247.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<pre><code>有一点不得不说，会用正则是真的可以方便很多——但是我不会</code></pre>
<p>此页面只是展示，所有的逻辑都放到了父组件中，所以当点击登录时将表单的值发射给父组件即可。</p>
<hr>
<p>当父组件接收到传来的值后，就会调用登录接口。</p>
<ul>
<li>app.component.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">user: User;</span><br><span class="line">wyRememberLogin: LoginParams;</span><br><span class="line"><span class="keyword">constructor</span>(</span><br><span class="line">    private searchServe: SearchService,</span><br><span class="line">    private store$: Store&lt;AppModule&gt;,</span><br><span class="line">    private memberBatchActionsServer: MemberBatchActionsService,</span><br><span class="line">    private memberServe: MemberService,</span><br><span class="line">    private message: NzMessageService,</span><br><span class="line">    private storageServe: StorageService,</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">const</span> userId = <span class="built_in">this</span>.storageServe.getStorage(<span class="string">&#x27;wyUserId&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId) &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetUserId(&#123; <span class="attr">id</span>: userId &#125;));</span><br><span class="line">        <span class="built_in">this</span>.memberServe.getUserInfo(userId).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.user = res</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wyRememberLogin = <span class="built_in">this</span>.storageServe.getStorage(<span class="string">&#x27;wyRememberLogin&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (wyRememberLogin) &#123;</span><br><span class="line">        <span class="built_in">this</span>.wyRememberLogin = <span class="built_in">JSON</span>.parse(wyRememberLogin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">onLogin (params: LoginParams) &#123;</span><br><span class="line">    <span class="built_in">this</span>.memberServe.login(params).subscribe((<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">        <span class="built_in">this</span>.memberBatchActionsServer.controlModal(<span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.alertMessage(<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;登陆成功&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.storageServe.setStorage(&#123;</span><br><span class="line">            key: <span class="string">&#x27;wyUserId&#x27;</span>,</span><br><span class="line">            value: user.profile.userId</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetUserId(&#123; <span class="attr">id</span>: user.profile.userId.toString() &#125;));</span><br><span class="line">        <span class="keyword">if</span> (params.remember) &#123;</span><br><span class="line">            <span class="built_in">this</span>.storageServe.setStorage(&#123;</span><br><span class="line">                key: <span class="string">&#x27;wyRememberLogin&#x27;</span>,</span><br><span class="line">                value: <span class="built_in">JSON</span>.stringify(codeJson(params))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.storageServe.removeStorage(<span class="string">&#x27;wyRememberLogin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;), (<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.alertMessage(<span class="string">&#x27;error&#x27;</span>, error.message)</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登出</span></span><br><span class="line">onLogout () &#123;</span><br><span class="line">    <span class="built_in">this</span>.memberServe.logOut().subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.storageServe.removeStorage(<span class="string">&#x27;wyUserId&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetUserId(&#123; <span class="attr">id</span>: <span class="string">&#x27;&#x27;</span> &#125;))</span><br><span class="line">        <span class="built_in">this</span>.alertMessage(<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;已退出&#x27;</span>);</span><br><span class="line">    &#125;, (<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.alertMessage(<span class="string">&#x27;error&#x27;</span>, error.message)</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提示信息</span></span><br><span class="line">private alertMessage (type: string, <span class="attr">msg</span>: string) &#123;</span><br><span class="line">    <span class="built_in">this</span>.message.create(type, msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时会将登录信息作为参数调用登录API，将返回值存在全局，使用Store将弹框显隐的状态改为false。然后利用nzMessage弹出提示，最后使用封装的localstorage将登录人的ID存入内存。在使用Store将当前登录人的状态ID改写，如果登录时勾选记住密码，将会把表单的内容存入localstorage，如果没勾选将会删除。</p>
<ul>
<li>member.types.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> type User = &#123;</span><br><span class="line">    level?: number; <span class="comment">// 等级</span></span><br><span class="line">    listenSongs?: number; <span class="comment">// 听歌记录</span></span><br><span class="line">    profile: &#123;</span><br><span class="line">        userId: number, <span class="comment">// ID</span></span><br><span class="line">        nickname: string, <span class="comment">// 昵称</span></span><br><span class="line">        avatarUrl: string, <span class="comment">// 头像</span></span><br><span class="line">        backgroundUrl: string, <span class="comment">// 背景图</span></span><br><span class="line">        signature: string, <span class="comment">// 简介</span></span><br><span class="line">        gender: number, <span class="comment">// 性别</span></span><br><span class="line">        followeds: number, <span class="comment">// 粉丝</span></span><br><span class="line">        follows: number, <span class="comment">// 关注</span></span><br><span class="line">        eventCount: number, <span class="comment">// 动态</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登出返回</span></span><br><span class="line"><span class="keyword">export</span> interface SampleBack <span class="keyword">extends</span> AnyJson &#123;</span><br><span class="line">    code: number;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 加密数据</span></span><br><span class="line"><span class="keyword">export</span> interface AnyJson &#123;</span><br><span class="line">    [key: string]: any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type Signin = &#123;</span><br><span class="line">    code: number;</span><br><span class="line">    point?: number;</span><br><span class="line">    msg?: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>storage.service.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getStorage (key: string, type = <span class="string">&#x27;local&#x27;</span>): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>[type + <span class="string">&#x27;Storage&#x27;</span>].getItem(key)</span><br><span class="line">&#125;</span><br><span class="line">setStorage (param: AnyJson | AnyJson[], type = <span class="string">&#x27;local&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> kv = <span class="built_in">Array</span>.isArray(param) ? param : [param];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> &#123; key, value &#125; <span class="keyword">of</span> kv) &#123;</span><br><span class="line">        <span class="built_in">window</span>[type + <span class="string">&#x27;Storage&#x27;</span>].setItem(key, value.toString())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">removeStorage (param: string | string[], type = <span class="string">&#x27;local&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> kv = <span class="built_in">Array</span>.isArray(param) ? param : [param];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> kv) &#123;</span><br><span class="line">        <span class="built_in">window</span>[type + <span class="string">&#x27;Storage&#x27;</span>].removeItem(item)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是封装了set，能够同时将多组的键值对存储。</p>
<p>其实账密存在内存中本身就不对，应该是利用token来检验，所以就当是拓展学习，也利用了base64插件来对账密进行加密和解密。</p>
<ul>
<li>base64.ts</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Base64 &#125; <span class="keyword">from</span> <span class="string">&quot;js-base64&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密数据</span></span><br><span class="line"><span class="keyword">export</span> interface AnyJson &#123;</span><br><span class="line">    [key: string]: any;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">codeJson</span> (<span class="params">source: AnyJson, type = <span class="string">&#x27;encode&#x27;</span></span>): <span class="title">AnyJson</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> arr <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.hasOwnProperty(arr)) &#123;</span><br><span class="line">            result[Base64[type](arr)] = Base64[type](source[arr])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>有关登录的安全验证还是有点迷惑的，对于token的理解还是不太明确，所以这个还是要好好的功课一下的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/a7b09b4f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/a7b09b4f/" class="post-title-link" itemprop="url">【Angular网易云】--25、登录弹框</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-11 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-11T17:23:38+08:00">2021-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p>当点击首页的登录按钮时，需要有个弹框来满足会员登录的功能。但是考虑到会员功能有一些收藏和转发的功能也需要弹框，所以选择使用复用弹框组件，每次调用弹框组件的时候会传递当前的操作，根据操作的不同来选择渲染进弹框的页面。<br><img data-src="https://img-blog.csdnimg.cn/20210112212233995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<hr>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="创建组件"><a href="#创建组件" class="headerlink" title="创建组件"></a>创建组件</h2><p>将弹窗的组件创建到wy-ui目录下<br><img data-src="https://img-blog.csdnimg.cn/20210112212456147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<p>在会员登录组件中添加点击事件</p>
<ul>
<li>member-card.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">nz-button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;openModal.emit()&quot;</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>当点击按钮后，就会将点击事件发射出去</p>
<ul>
<li>member-card.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Output() openModal = <span class="keyword">new</span> EventEmitter&lt;<span class="keyword">void</span>&gt;();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>home父组件添加接收回调</p>
<ul>
<li>home.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-member-card</span> (<span class="attr">openModal</span>)=<span class="string">&quot;openModal()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-member-card</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>根据之前的设计，因为弹框的内容不一样，但是想要复用弹框组件，所以在触发弹框时会传递参数来判断当前应该渲染哪个页面，所以可以选择ngrx来接受弹框的不同状态。</p>
<h2 id="初始化ngx"><a href="#初始化ngx" class="headerlink" title="初始化ngx"></a>初始化ngx</h2><ul>
<li>member.reducer.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> enum ModalTypes &#123;</span><br><span class="line">    Register = <span class="string">&#x27;register&#x27;</span>,</span><br><span class="line">    LoginByPhone = <span class="string">&#x27;loginByPhone&#x27;</span>,</span><br><span class="line">    Share = <span class="string">&#x27;share&#x27;</span>,</span><br><span class="line">    Like = <span class="string">&#x27;like&#x27;</span>,</span><br><span class="line">    Default = <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type MemberState = &#123;</span><br><span class="line">    modalVisible: boolean, <span class="comment">// 显隐状态</span></span><br><span class="line">    modalType: ModalTypes, <span class="comment">// 弹框方式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始数据格式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initialState: MemberState = &#123;</span><br><span class="line">    modalVisible: <span class="literal">false</span>,</span><br><span class="line">    modalType: ModalTypes.Default,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 注册动作</span></span><br><span class="line"><span class="keyword">const</span> reducer = createReducer(</span><br><span class="line">    initialState,</span><br><span class="line">    on(SetModalVisible, <span class="function">(<span class="params">state, &#123; modalVisible &#125;</span>) =&gt;</span> (&#123; ...state, modalVisible &#125;)),</span><br><span class="line">    on(SetModalType, <span class="function">(<span class="params">state, &#123; modalType &#125;</span>) =&gt;</span> (&#123; ...state, modalType &#125;)),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">memberReducer</span> (<span class="params">state: MemberState, action: Action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reducer(state, action)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>member.actions.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createAction, props &#125; <span class="keyword">from</span> <span class="string">&#x27;@ngrx/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ModalTypes &#125; <span class="keyword">from</span> <span class="string">&#x27;../reducers/member.reducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置动作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SetModalVisible = createAction(<span class="string">&#x27;[member] set modal visible&#x27;</span>, props&lt;&#123; <span class="attr">modalVisible</span>: boolean &#125;&gt;());</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SetModalType = createAction(<span class="string">&#x27;[player] set modal type&#x27;</span>, props&lt;&#123; <span class="attr">modalType</span>: ModalTypes &#125;&gt;());</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>member.selector.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createFeatureSelector, createSelector &#125; <span class="keyword">from</span> <span class="string">&#x27;@ngrx/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MemberState &#125; <span class="keyword">from</span> <span class="string">&quot;../reducers/member.reducer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> selectMemberStates = <span class="function">(<span class="params">state: MemberState</span>) =&gt;</span> state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMember = createFeatureSelector&lt;MemberState&gt;(<span class="string">&#x27;member&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getModalVisible = createSelector(selectMemberStates, <span class="function">(<span class="params">state: MemberState</span>) =&gt;</span> state.modalVisible)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getModalType = createSelector(selectMemberStates, <span class="function">(<span class="params">state: MemberState</span>) =&gt;</span> state.modalType)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="封装action"><a href="#封装action" class="headerlink" title="封装action"></a>封装action</h2><p>为了和之前的播放面板区别，所以选择新建了服务</p>
<ul>
<li>member-batch-actions.service.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; select, Store &#125; <span class="keyword">from</span> <span class="string">&#x27;@ngrx/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppStoreModule &#125; <span class="keyword">from</span> <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SetModalType, SetModalVisible &#125; <span class="keyword">from</span> <span class="string">&#x27;./actions/member.actions&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MemberState, ModalTypes &#125; <span class="keyword">from</span> <span class="string">&#x27;./reducers/member.reducer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getMember &#125; <span class="keyword">from</span> <span class="string">&#x27;./selectors/member.selector&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">    providedIn: AppStoreModule</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberBatchActionsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private memberState: MemberState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        private store$: Store&lt;AppStoreModule&gt;,</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.pipe(select(getMember)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">this</span>.memberState = res)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  会员弹窗显隐/ 类型</span></span><br><span class="line">    controlModal (modalVisible = <span class="literal">true</span>, modalType = ModalTypes.Default) &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetModalType(&#123; modalType &#125;));</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetModalVisible(&#123; modalVisible &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>此时home回调中会向会员actions服务中调用弹框。</p>
<ul>
<li>home.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private memberBatchActionsServer: MemberBatchActionsService,</span><br><span class="line"><span class="comment">// 会员弹窗</span></span><br><span class="line">openModal () &#123;</span><br><span class="line">    <span class="built_in">this</span>.memberBatchActionsServer.controlModal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>那怎么调用这个弹框组件呢？只需要在弹框组件中订阅弹框显隐状态和弹框类型就可以了。</p>
<ul>
<li>wy-layer-modal.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;app-wy-layer-modal&#x27;</span>,</span><br><span class="line">    templateUrl: <span class="string">&#x27;./wy-layer-modal.component.html&#x27;</span>,</span><br><span class="line">    styleUrls: [<span class="string">&#x27;./wy-layer-modal.component.less&#x27;</span>],</span><br><span class="line">    changeDetection: ChangeDetectionStrategy.OnPush,</span><br><span class="line">    animations: [trigger(<span class="string">&#x27;showHide&#x27;</span>, [</span><br><span class="line">        state(<span class="string">&#x27;show&#x27;</span>, style(&#123; <span class="attr">transform</span>: <span class="string">&#x27;scale(1)&#x27;</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)),</span><br><span class="line">        state(<span class="string">&#x27;hide&#x27;</span>, style(&#123; <span class="attr">transform</span>: <span class="string">&#x27;scale(0)&#x27;</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">        transition(<span class="string">&#x27;show&lt;=&gt;hide&#x27;</span>, animate(<span class="string">&#x27;0.1s&#x27;</span>))</span><br><span class="line">    ])]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WyLayerModalComponent</span> <span class="title">implements</span> <span class="title">OnInit</span>, <span class="title">AfterViewInit</span> </span>&#123;</span><br><span class="line">    showModal = <span class="string">&#x27;hide&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    private visible = <span class="literal">false</span>;  <span class="comment">// 弹窗显隐</span></span><br><span class="line">    private currentModalType = ModalTypes.Default; <span class="comment">//  当前弹窗模式</span></span><br><span class="line"></span><br><span class="line">    private overlayRef: OverlayRef;</span><br><span class="line">    private scrollStrategy: BlockScrollStrategy;</span><br><span class="line"></span><br><span class="line">    private resizehandler: <span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    private overlayContainerEl: HTMLElement;</span><br><span class="line"></span><br><span class="line">    @ViewChild(<span class="string">&#x27;modalContainer&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) private modalRef: ElementRef;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        @Inject(DOCUMENT) private doc: Document,</span><br><span class="line">        private store$: Store&lt;AppStoreModule&gt;,</span><br><span class="line">        private overlay: Overlay,</span><br><span class="line">        private elementRef: ElementRef,</span><br><span class="line">        private overlayKeyboardDispatcher: OverlayKeyboardDispatcher,</span><br><span class="line">        private cdr: ChangeDetectorRef,</span><br><span class="line">        private memberBatchActionsServer: MemberBatchActionsService,</span><br><span class="line">        private rd: Renderer2,</span><br><span class="line">        private overlayContainerServe: OverlayContainer,</span><br><span class="line">    ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    ngOnInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> appStore$ = <span class="built_in">this</span>.store$.pipe(select(getMember));</span><br><span class="line">        appStore$.pipe(select(getModalVisible)).subscribe(<span class="function"><span class="params">visible</span> =&gt;</span> <span class="built_in">this</span>.watchModalVisible(visible));</span><br><span class="line">        appStore$.pipe(select(getModalType)).subscribe(<span class="function"><span class="params">modalType</span> =&gt;</span> <span class="built_in">this</span>.watchModalType(modalType));</span><br><span class="line">        <span class="built_in">this</span>.createOverlay();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngAfterViewInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.overlayContainerEl = <span class="built_in">this</span>.overlayContainerServe.getContainerElement();</span><br><span class="line">        <span class="built_in">this</span>.listenResizeToCenter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private createOverlay () &#123;</span><br><span class="line">        <span class="built_in">this</span>.overlayRef = <span class="built_in">this</span>.overlay.create(&#123; <span class="attr">hasBackdrop</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">        <span class="built_in">this</span>.overlayRef.overlayElement.appendChild(<span class="built_in">this</span>.elementRef.nativeElement);</span><br><span class="line">        <span class="built_in">this</span>.overlayRef.keydownEvents().subscribe(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.keydownListener(e));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听弹窗内的点击</span></span><br><span class="line">    private keydownListener (eve: KeyboardEvent) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;keydown&#x27;</span>, eve);</span><br><span class="line">        <span class="keyword">if</span> (eve.key === <span class="string">&#x27;Escape&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hide()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听弹窗显隐</span></span><br><span class="line">    private watchModalVisible (visible: boolean) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.visible !== visible) &#123;</span><br><span class="line">            <span class="built_in">this</span>.visible = visible;</span><br><span class="line">            <span class="built_in">this</span>.handleVisibleChange(visible);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听弹窗模式 </span></span><br><span class="line">    private watchModalType (type: ModalTypes) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.currentModalType !== type) &#123;</span><br><span class="line">            <span class="built_in">this</span>.currentModalType = type;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理弹窗回调</span></span><br><span class="line">    private handleVisibleChange (visible: boolean) &#123;</span><br><span class="line">        <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">            <span class="built_in">this</span>.showModal = <span class="string">&#x27;show&#x27;</span>;</span><br><span class="line">            <span class="built_in">this</span>.scrollStrategy.enable();</span><br><span class="line">            <span class="built_in">this</span>.overlayKeyboardDispatcher.add(<span class="built_in">this</span>.overlayRef);</span><br><span class="line">            <span class="built_in">this</span>.listenResizeToCenter();</span><br><span class="line">            <span class="built_in">this</span>.changePointerEvents(<span class="string">&#x27;auto&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.showModal = <span class="string">&#x27;hide&#x27;</span>;</span><br><span class="line">            <span class="built_in">this</span>.scrollStrategy.disable();</span><br><span class="line">            <span class="built_in">this</span>.overlayKeyboardDispatcher.remove(<span class="built_in">this</span>.overlayRef);</span><br><span class="line">            <span class="built_in">this</span>.resizehandler();</span><br><span class="line">            <span class="built_in">this</span>.changePointerEvents(<span class="string">&#x27;none&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private changePointerEvents (type: <span class="string">&#x27;none&#x27;</span> | <span class="string">&#x27;auto&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.overlayContainerEl) &#123;</span><br><span class="line">            <span class="built_in">this</span>.overlayContainerEl.style.pointerEvents = type</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭弹框</span></span><br><span class="line">    hide () &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberBatchActionsServer.controlModal(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弹窗动态居中</span></span><br><span class="line">    private listenResizeToCenter () &#123;</span><br><span class="line">        <span class="keyword">const</span> modal = <span class="built_in">this</span>.modalRef.nativeElement;</span><br><span class="line">        <span class="keyword">const</span> modalSize = <span class="built_in">this</span>.getHideDomSize(modal);</span><br><span class="line">        <span class="built_in">this</span>.keepCenter(modal, modalSize);</span><br><span class="line">        <span class="built_in">this</span>.resizehandler = <span class="built_in">this</span>.rd.listen(<span class="string">&#x27;window&#x27;</span>, <span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.keepCenter(modal, modalSize);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 居中</span></span><br><span class="line">    private keepCenter (modal: HTMLElement, <span class="attr">size</span>: &#123; <span class="attr">w</span>: number, <span class="attr">h</span>: number &#125;) &#123;</span><br><span class="line">        <span class="keyword">const</span> left = (<span class="built_in">this</span>.getWindowSize().w - size.w) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> top = (<span class="built_in">this</span>.getWindowSize().h - size.h) / <span class="number">2</span>;</span><br><span class="line">        modal.style.left = left + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">        modal.style.top = top + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取弹框长宽</span></span><br><span class="line">    private getHideDomSize (dom: HTMLElement) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            w: dom.offsetWidth,</span><br><span class="line">            h: dom.offsetHeight</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取窗口的宽高</span></span><br><span class="line">    private getWindowSize () &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            w: <span class="built_in">window</span>.innerWidth || <span class="built_in">this</span>.doc.documentElement.clientWidth || <span class="built_in">this</span>.doc.body.offsetWidth,</span><br><span class="line">            h: <span class="built_in">window</span>.innerHeight || <span class="built_in">this</span>.doc.documentElement.clientHeight || <span class="built_in">this</span>.doc.body.offsetHeight</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>在组件初始化时，先订阅弹框显隐和弹框的类型，在监听弹窗模式 回调中会修改当前的弹窗模式；在监听弹窗显隐时如果是显示就会修改当前的显隐，并且触发回调，弹框弹起时就会进入if，此时会触发动画，动画转场向着‘show’，然后会阻止滚动条的作用。为了防止浮层下的其他点击事件，在添加一个蒙层，之后调用弹框居中的回调，根据窗口和浮层的长宽来计算浮层的位置，并为窗口添加一个重新计算大小的事件。然后禁用浮层穿透，防止触发下面的事件。</strong></p>
<p><strong>然后就可以添加浮层和门户了。这个和搜索组件的浮层还不一样，因为搜索组件的浮层是要和搜索框一起存在的，并没有嵌套关系，所以使用了浮层的attach方法。但是弹框的渲染页是变化的，所以需要有嵌套关系，因此要使用appendchild的方法。要使浮层显示之后可以使用ESC来关闭，就可以监听键盘，当其输入的KEY是’Escape’就再次调用action服务，将弹框显隐设置为false。</strong></p>
<p><strong>当其订阅到弹框显隐变化为false时，就会触发动画转场为hide，并且显示滚动条，移除蒙层，解绑弹窗动态居中。</strong></p>
<ul>
<li>wy-layer-modal.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> </span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">&quot;m-layer&quot;</span>    </span></span><br><span class="line"><span class="tag">#<span class="attr">modalContainer</span></span></span><br><span class="line"><span class="tag">[@<span class="attr">showHide</span>]=<span class="string">&quot;showModal&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">draggable</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">cdkDrag</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;zbar&quot;</span> <span class="attr">cdkDragHandle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;zttl f-thide&quot;</span>&gt;</span>这是标题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-content</span> #<span class="attr">name</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;zcls&quot;</span> <span class="attr">title</span>=<span class="string">&quot;关闭&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;hide()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h2 id="浮层拖拽"><a href="#浮层拖拽" class="headerlink" title="浮层拖拽"></a>浮层拖拽</h2><p>可以使用material的拖放指令，只需要导入需要的包就可以。</p>
<ul>
<li>wy-layer.module.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">    declarations: [WyLayerModalComponent, WyLayerDefaultComponent],</span><br><span class="line">    imports: [</span><br><span class="line">        CommonModule,</span><br><span class="line">        NzButtonModule,</span><br><span class="line">        DragDropModule,</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">exports</span>: [WyLayerModalComponent, WyLayerDefaultComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WyLayerModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>在允许拖拽的元素上添加 ==cdkDrag==与==cdkDragHandle==即可</p>
<blockquote>
<p><strong>注意：cdkDrag不可以放在cdkDragHandle里边</strong></p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>关于ngrx的使用确实是很方便，但是始终是不太明白运行的原理，官方文档也不是很理解，而且有关功能的实现有很多是组件库的作用，其实拖拽完全可以手写，但是尝试了一次之后失败了，关于这个原理还是有点模糊。将angular升级到最新后导包总是会出现报错，但大多数重启服务就可以了，不知道是不是配置的问题，之前就能够实时更新文件的，，，加油吧，坚持到底</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/a98f20ea/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/a98f20ea/" class="post-title-link" itemprop="url">【Angular网易云】--24、动画</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-08 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-08T17:23:38+08:00">2021-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h1><p>在基本实现了底部播放面板的显示之后就可以为面板做一层动画，来实现底部面板的显隐。底部就只会显示一个小按钮<br><img data-src="https://img-blog.csdnimg.cn/20210111162832873.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="angular动画"><a href="#angular动画" class="headerlink" title="angular动画"></a>angular动画</h1><p>这里就要提到强大的<a target="_blank" rel="noopener" href="https://angular.cn/guide/animations">angular动画</a>了，关于更详细的教程可以去angular官网去搜索动画教程。</p>
<blockquote>
<p>动画用于提供运动的幻觉：HTML 元素随着时间改变样式。精心设计的动画可以让你的应用更有趣，更易用，但它们不仅仅是装饰性的。动画可以通过几种方式改善你的应用和用户体验：</p>
<ul>
<li>没有动画，Web 页面的转场就会显得突兀、不协调。</li>
<li>运动能极大地提升用户体验，因此动画可以让用户察觉到应用对他们的操作做出了响应。</li>
<li>良好的动画可以直观的把用户的注意力吸引到要留意的地方。</li>
</ul>
</blockquote>
<blockquote>
<p>典型的动画会涉及多种随时间变化的转换。HTML 元素可以移动、变换颜色、增加或缩小、隐藏或从页面中滑出。 这些变化可以同时发生或顺序发生。你可以控制每次转换的持续时间。</p>
</blockquote>
<blockquote>
<p>Angular 的动画系统是基于 CSS 功能构建的，这意味着你可以 “动” 浏览器认为可动的任何属性。包括位置、大小、变形、颜色、边框等。W3C 在它的 CSS Transitions（转场） 页中维护了一个可动属性的列表。</p>
</blockquote>
<hr>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>当我们将鼠标悬浮到底部时，面板自下而上显示，当离开面板区域时，面板自上而下隐藏。同时也要为小按钮添加锁定面板的功能。</p>
<h3 id="定义动画"><a href="#定义动画" class="headerlink" title="定义动画"></a>定义动画</h3><ul>
<li>wy-player.component.html<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;app-wy-player&#x27;</span>,</span><br><span class="line">    templateUrl: <span class="string">&#x27;./wy-player.component.html&#x27;</span>,</span><br><span class="line">    styleUrls: [<span class="string">&#x27;./wy-player.component.less&#x27;</span>],</span><br><span class="line">    animations: [trigger(<span class="string">&#x27;showHide&#x27;</span>, [</span><br><span class="line">        state(<span class="string">&#x27;show&#x27;</span>, style(&#123; <span class="attr">bottom</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">        state(<span class="string">&#x27;hide&#x27;</span>, style(&#123; <span class="attr">bottom</span>: <span class="number">-71</span> &#125;)),</span><br><span class="line">        transition(<span class="string">&#x27;show=&gt;hide&#x27;</span>, [animate(<span class="string">&#x27;0.3s&#x27;</span>)]),</span><br><span class="line">        transition(<span class="string">&#x27;hide=&gt;show&#x27;</span>, [animate(<span class="string">&#x27;0.1s&#x27;</span>)])</span><br><span class="line">    ])]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">    showPlayer = <span class="string">&#x27;hide&#x27;</span>; <span class="comment">// 动画初始状态</span></span><br><span class="line">    isLocked = <span class="literal">false</span>; <span class="comment">// 面板是否被锁</span></span><br><span class="line">    animating = <span class="literal">false</span>; <span class="comment">// 是否正在动画</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 面板动画</span></span><br><span class="line">    togglePlayer (type: string) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isLocked &amp;&amp; !<span class="built_in">this</span>.animating) &#123;</span><br><span class="line">            <span class="built_in">this</span>.showPlayer = type;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>angular 要求在组件的 @Component() 装饰器中，添加一个名叫 animations: 的元数据属性。 你可以把用来定义动画的触发器放进 animations 元数据属性中。</strong></p>
<p><strong>使用trigger来为当前动画添加触发器，第一个参数为触发器的名称，第二个参数用数组来包装所用的状态和转场。state声明状态，第一个参数是状态名称，第二个参数是样式对象。transition表示转场动画，其中第一个参数表示状态指向变化，第二个参数表示动画元数据animate</strong></p>
<blockquote>
<p><strong>动画元数据</strong><br>animate() 函数（作为转场函数的第二个参数）可以接受 timings 和 styles 参数。timings 参数接受一个由三部分组成的字符串。</p>
<ul>
<li>animate (‘duration delay easing’)</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>第一部分 duration（持续时间）是必须的。这个持续时间可以表示成一个不带引号的纯数字（表示毫秒），或一个带引号的有单位的时间（表示秒数）。比如，0.1 秒的持续时间有如下表示方式：<blockquote>
<ul>
<li>作为纯数字，毫秒为单位：100</li>
<li>作为字符串，毫秒为单位：’100ms’</li>
<li>作为字符串，秒为单位：’0.1s’</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<blockquote>
<p>第二个参数 delay 的语法和 duration 一样。比如：</p>
<blockquote>
<ul>
<li>等待 100 毫秒，然后运行 200 毫秒表示为：’0.2s 100ms’</li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p>第三个参数 easing 控制动画在运行期间如何进行加速和减速。比如 ease-in 表示动画开始时很慢，然后逐渐加速。</p>
<blockquote>
<ul>
<li>等待 100 毫秒，运行 200 毫秒。按照减速曲线运动，快速启动并逐渐减速，直到静止：’0.2s 100ms ease-out’</li>
<li>运行 200 毫秒，不等待。按照标准曲线运动，开始很慢，中间加速，最后逐渐减速：’0.2s ease-in-out’</li>
<li>立即开始，运行 200 毫秒。按照加速曲线运动，开始很慢，最后达到全速：’0.2s ease-in’</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="使用动画"><a href="#使用动画" class="headerlink" title="使用动画"></a>使用动画</h3><p>为组件定义好这些动画触发器之后，你可以给触发器名称加上 @ 前缀并包在方括号里，来把它附加到组件模板中的元素上。然后，你可以使用 Angular 的标准属性绑定语法，来把这个触发器绑定到模板表达式上。这里的 showHide就是触发器的名称，而 showPlayer的求值结果是前面定义过的动画状态之一。</p>
<ul>
<li>wy-player.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-player&quot;</span> </span></span><br><span class="line"><span class="tag">    [@<span class="attr">showHide</span>]=<span class="string">&quot;showPlayer&quot;</span></span></span><br><span class="line"><span class="tag">     (<span class="attr">mouseenter</span>)=<span class="string">&quot;togglePlayer(&#x27;show&#x27;)&quot;</span></span></span><br><span class="line"><span class="tag">     (<span class="attr">mouseleave</span>)=<span class="string">&quot;togglePlayer(&#x27;hide&#x27;)&quot;</span></span></span><br><span class="line"><span class="tag">     (@<span class="attr">showHide.start</span>)=<span class="string">&quot;animating = true&quot;</span></span></span><br><span class="line"><span class="tag">     (@<span class="attr">showHide.done</span>)=<span class="string">&quot;animating = false&quot;</span></span></span><br><span class="line"><span class="tag">     &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img data-src="https://img-blog.csdnimg.cn/20210111165513502.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<p>当鼠标滑过时就会触发mouseenter，此时就会改变面板的默认状态，触发器就会执行 <strong>‘hide =&gt; show’</strong> 的动画。关于动画的改变是根据底部面板的高度来决定的，改变元素底边缘的值实现显隐。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/8dec73e7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/8dec73e7/" class="post-title-link" itemprop="url">【Angular网易云】--23、搜索组件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-02 17:23:38" itemprop="dateCreated datePublished" datetime="2021-01-02T17:23:38+08:00">2021-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="搜索组件"><a href="#搜索组件" class="headerlink" title="搜索组件"></a>搜索组件</h1><p>首页顶部的搜索框要开始实现了。使用场景很明确，就是去根据关键字去调用专用的接口拿到返回值后渲染到组件中。<br><img data-src="https://img-blog.csdnimg.cn/20210110205531383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<hr>
<p>为了方便维护，将搜索框封装成单独的模块</p>
<h2 id="创建search模块"><a href="#创建search模块" class="headerlink" title="创建search模块"></a>创建search模块</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在wy-ui下执行</span></span><br><span class="line">	ng g m wy-search</span><br><span class="line">	ng g c wy-search</span><br></pre></td></tr></table></figure>
<p><strong>为了避免循环引用shareModule，所以要在WySearchModule中逐个引用。</strong></p>
<hr>
<h2 id="自定义组件"><a href="#自定义组件" class="headerlink" title="自定义组件"></a>自定义组件</h2><p>使用ng-container和ng-template标签灵活创建组件渲染的内容</p>
<ul>
<li>wy-search.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">default</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;search&quot;</span> #<span class="attr">search</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nz-input-group</span> <span class="attr">nzSuffixIcon</span>=<span class="string">&quot;search&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">nz-input</span> #<span class="attr">nzInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;歌单/歌手&quot;</span>  /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nz-input-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngTemplateOutlet</span>=<span class="string">&quot;default&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>app.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-wy-search</span>  (<span class="attr">onSearch</span>)=<span class="string">&quot;onSearch($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-search</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-search.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(<span class="string">&#x27;nzInput&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) private nzInput: ElementRef;</span><br><span class="line">@Output() onSearch = <span class="keyword">new</span> EventEmitter&lt;string&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//  发射输入框的值</span></span><br><span class="line">  ngAfterViewInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">       fromEvent(<span class="built_in">this</span>.nzInput.nativeElement, <span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">           .pipe(</span><br><span class="line">               debounceTime(<span class="number">300</span>), <span class="comment">// 防抖</span></span><br><span class="line">               distinctUntilChanged(), <span class="comment">// 去重</span></span><br><span class="line">               pluck(<span class="string">&#x27;target&#x27;</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">           ).subscribe(<span class="function">(<span class="params">input: string</span>) =&gt;</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.onSearch.emit(input);</span><br><span class="line">           &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>当试图渲染完成之后就去绑定输入框，将每次的输入值经过防抖和去重后发射给父组件。</p>
</li>
</ul>
<p>这里的自定义体现在app模块可以自己定义一个templateref类型的内容，然后通过引用类型将值传给子组件。</p>
<hr>
<h2 id="调用接口"><a href="#调用接口" class="headerlink" title="调用接口"></a>调用接口</h2><ul>
<li><p>search.service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取关键字搜索内容</span></span><br><span class="line"> search (keywords: string): Observable&lt;SearchResult&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;keywords&#x27;</span>, keywords);</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;search/suggest&#x27;</span>, &#123; params &#125;).pipe(</span><br><span class="line">           map(<span class="function">(<span class="params">res: &#123; result: SearchResult &#125;</span>) =&gt;</span> res.result)</span><br><span class="line">       )</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>因为目前只做了歌手，歌单和歌曲模块，所以searchResult类型的属性就只定义这三个。</p>
</li>
<li><p>common.type.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关键字返回值</span></span><br><span class="line"><span class="keyword">export</span> type SearchResult = &#123;</span><br><span class="line">    artists?: Singer[],</span><br><span class="line">    playlists?: SongSheet[],</span><br><span class="line">    songs?: Song[],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h2><ul>
<li>app.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(private searchServe: SearchService ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">onSearch (keywords: string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (keywords) &#123;</span><br><span class="line">        <span class="built_in">this</span>.searchServe.search(keywords).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.searchResult = <span class="built_in">this</span>.highlightKeyWords(keywords, res);;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.searchResult = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键字高亮</span></span><br><span class="line">private highlightKeyWords (kewwords: string, <span class="attr">result</span>: SearchResult): SearchResult &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEmptyObject(result)) &#123;</span><br><span class="line">        <span class="keyword">const</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(kewwords, <span class="string">&#x27;ig&#x27;</span>);</span><br><span class="line">        [<span class="string">&#x27;artists&#x27;</span>, <span class="string">&#x27;playlists&#x27;</span>, <span class="string">&#x27;songs&#x27;</span>].forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (result[type]) &#123;</span><br><span class="line">                result[type].forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">                    item.name = item.name.replace(reg, <span class="string">&#x27;&lt;span class=&quot;highlight&quot;&gt;$&amp;&lt;/span&gt;&#x27;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
页面中接到子组件传来的关键字后经过searchServer后拿到数据的返回值，额外的需求是将返回值中含有的参数高亮，所以在经过一个回调即可。回调高亮的逻辑也很清晰，通过传来的关键字和返回值，通过对关键字进行正则匹配后，将匹配到的关键字加上特有的类就可以在页面上使用 <strong>innerHtml</strong>来渲染。</li>
</ul>
<hr>
<h2 id="实现浮层"><a href="#实现浮层" class="headerlink" title="实现浮层"></a>实现浮层</h2><p>浮层的使用是<a target="_blank" rel="noopener" href="https://material.angular.cn/cdk/overlay/overview">Material</a>组件库下的<strong>overlay（浮层）</strong>。</p>
<blockquote>
<p>是用的逻辑很简单，主要分为三步：<br>   1、创建浮层<br>2、创建门户<br>3、为浮层添加门户</p>
</blockquote>
<p>创建之后就可以为浮层添加配置，从而就可以实现最终效果。</p>
<h3 id="创建浮层组件"><a href="#创建浮层组件" class="headerlink" title="创建浮层组件"></a>创建浮层组件</h3><p>在wy-search目录下创建wy-search-panel组件，这个组件仅是展示内容，关于浮层和门户的创建都是在search下实现的。</p>
<ul>
<li><p>wy-search-panel.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;search-panel&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-wrap&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-item clearfix&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!searchResult?.songs&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico ico-song&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>单曲<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;ellipsis&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of searchResult?.songs&quot;</span> (<span class="attr">mousedown</span>)=<span class="string">&quot;toInfo([&#x27;/songInfo&#x27;, item.id])&quot;</span> [<span class="attr">innerHTML</span>]=<span class="string">&quot;item.name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-item clearfix&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!searchResult?.artists&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico ico-singer&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>歌手<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;ellipsis&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of searchResult?.artists&quot;</span> (<span class="attr">mousedown</span>)=<span class="string">&quot;toInfo([&#x27;/singer&#x27;, item.id])&quot;</span> [<span class="attr">innerHTML</span>]=<span class="string">&quot;item.name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-item clearfix&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!searchResult?.playlists&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico ico-sheet&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>歌单<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;ellipsis&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of searchResult?.playlists&quot;</span> (<span class="attr">mousedown</span>)=<span class="string">&quot;toInfo([&#x27;/sheetInfo&#x27;, item.id])&quot;</span> [<span class="attr">innerHTML</span>]=<span class="string">&quot;item.name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-search-panel.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">searchResult: SearchResult;</span><br><span class="line">  <span class="keyword">constructor</span>(private router: Router) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跳转</span></span><br><span class="line">  toInfo (path: [string, number]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (path[<span class="number">1</span>]) &#123;</span><br><span class="line">          <span class="built_in">this</span>.router.navigate(path);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>当浮层拿到返回值后，就可以渲染当前值，通过点击渲染的值将路由和ID传给回调，实现跳转页面。</p>
</li>
</ul>
<h3 id="浮层实现"><a href="#浮层实现" class="headerlink" title="浮层实现"></a>浮层实现</h3><p>当点击输入框并输入值后，app模块会将带着高亮的返回值传给search组件。search组件将会实时监听返回值的变化，不为空时就会显示浮层，否则就会关上。在打开浮层的回调中实现组件库的引用。</p>
<ul>
<li>wy-search.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">   @Input() searchResult: SearchResult; <span class="comment">// 关键字返回值</span></span><br><span class="line">   @Input() connectedRef: ElementRef;</span><br><span class="line"></span><br><span class="line">   @ViewChild(<span class="string">&#x27;search&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) private defaultRef: ElementRef;</span><br><span class="line">   private overlayRef: OverlayRef;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">constructor</span>(</span><br><span class="line">       private overlay: Overlay,</span><br><span class="line">       private viewContainerRef: ViewContainerRef,</span><br><span class="line">   ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 搜索值监听</span></span><br><span class="line">   ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (changes.searchResult &amp;&amp; !changes.searchResult.firstChange) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!isEmptyObject(<span class="built_in">this</span>.searchResult)) &#123;</span><br><span class="line">               <span class="built_in">this</span>.showOverlayPanel();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.hideOverlayPanel();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚焦</span></span><br><span class="line">   onFocus () &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.searchResult &amp;&amp; !isEmptyObject(<span class="built_in">this</span>.searchResult)) &#123;</span><br><span class="line">           <span class="built_in">this</span>.showOverlayPanel();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 失焦</span></span><br><span class="line">   onBlur () &#123;</span><br><span class="line">       <span class="built_in">this</span>.hideOverlayPanel();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 添加浮层</span></span><br><span class="line">   showOverlayPanel () &#123;</span><br><span class="line">       <span class="built_in">this</span>.hideOverlayPanel();</span><br><span class="line">       <span class="keyword">const</span> positionStrategy = <span class="built_in">this</span>.overlay.position()</span><br><span class="line">           .flexibleConnectedTo(<span class="built_in">this</span>.connectedRef || <span class="built_in">this</span>.defaultRef)</span><br><span class="line">           .withPositions([&#123;</span><br><span class="line">               originX: <span class="string">&#x27;start&#x27;</span>,</span><br><span class="line">               originY: <span class="string">&#x27;bottom&#x27;</span>,</span><br><span class="line">               overlayX: <span class="string">&#x27;start&#x27;</span>,</span><br><span class="line">               overlayY: <span class="string">&#x27;top&#x27;</span>,</span><br><span class="line">           &#125;]).withLockedPosition(<span class="literal">true</span>);</span><br><span class="line">       <span class="built_in">this</span>.overlayRef = <span class="built_in">this</span>.overlay.create(&#123;</span><br><span class="line">           <span class="comment">// hasBackdrop: true,</span></span><br><span class="line">           positionStrategy,</span><br><span class="line">           scrollStrategy: <span class="built_in">this</span>.overlay.scrollStrategies.reposition(),</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">const</span> panelPortal = <span class="keyword">new</span> ComponentPortal(WySearchPanelComponent, <span class="built_in">this</span>.viewContainerRef);</span><br><span class="line">       <span class="keyword">const</span> panelRef = <span class="built_in">this</span>.overlayRef.attach(panelPortal);</span><br><span class="line">       panelRef.instance.searchResult = <span class="built_in">this</span>.searchResult;</span><br><span class="line">       <span class="built_in">this</span>.overlayRef.backdropClick().subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.hideOverlayPanel();</span><br><span class="line">       &#125;)</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 移除浮层</span></span><br><span class="line">   hideOverlayPanel () &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.overlayRef &amp;&amp; <span class="built_in">this</span>.overlayRef.hasAttached) &#123;</span><br><span class="line">           <span class="built_in">this</span>.overlayRef.dispose();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
先声明浮层操作类和浮层，然后使用overlay去create一个浮层，而create里边的参数都是配置。之后实例化的是门户，传了两个参数，一个是要显示的组件类，另一个是作为位置参照的ref类型。然后就可以用overlay的attach方法将门户添加到浮层上了，去除浮层可以用dispose方法。</li>
</ul>
<p>其中参数的选择上使用了定位策略和滚动策略。第一个参数是定位。</p>
<blockquote>
<p>定位策略<br>positionStrategy 配置项决定了浮层在屏幕上的定位方式。本库内置了两种定位策略： GlobalPositionStrategy 和 ConnectedPositionStrategy。</p>
</blockquote>
<blockquote>
<p>GlobalPositionStrategy 用于需要定位在视口中特定位置的浮层，位置与别的元素无关。这通常用于模态对话框和应用级通知。</p>
</blockquote>
<blockquote>
<p>ConnectedPositionStrategy 用于相对于页面中其它 “origin”（原点）元素进行定位的浮层。这通常用于菜单、选择器和工具提示。当使用这种连接策略时，会提供一组首选位置，然后根据浮层在视口中的适合程度来选出一个“最佳”位置。</p>
</blockquote>
<blockquote>
<p>FlexibleConnectedPositionStrategy 扩展了 ConnectedPositionStrategy 的功能，增加了更高级的功能，它还能相对于页面上的另一个元素定位一个浮层。其特性包括能让浮层在其内容到达视口边缘时变得可滚动；能够在浮层和视口边缘之间配置一个边距；如果浮层不适合任何一个首选位置，还能把它推入到视口中；还可以配置在打开浮层时，其大小是否会增长。这种灵活的定位策略还允许使用 withTransformOriginOn 来基于当前位置设置浮层内元素的 transform-origin。当浮层中有动画，且动画开始于其原点元素的位置时，这很有用。</p>
</blockquote>
<p>查阅文档时有一层逻辑一直很绕，如果使用 <strong>FlexibleConnectedPositionStrategy</strong>定位策略就要使用<strong>flexibleConnectedTo</strong>方法，因为该方法返回值是这个类型，而这个方法属于<strong>OverlayPositionBuilder</strong>类型，所以要使用<strong>Overlay</strong>类型下的<strong>position</strong>方法，因为该方法返回builder类型，所以定义参数时就会有很长的一个函数流。</p>
<p>为了解决滚动时浮层不固定参照模板的问题，之后的参数便是滚动策略</p>
<blockquote>
<p>滚动策略<br>scrollStrategy 配置项决定了浮层如何响应浮层元素外部的滚动。本库内置了四种可用的滚动策略。</p>
</blockquote>
<blockquote>
<p>NoopScrollStrategy 是默认选项。该策略什么都不做。</p>
</blockquote>
<blockquote>
<p>CloseScrollStrategy 会在滚动时自动关闭浮层。</p>
</blockquote>
<blockquote>
<p>当浮层打开时，BlockScrollStrategy 会阻止页面滚动。注意，某些应用可能会实现特殊或自定义的页面滚动；如果BlockScrollStrategy 与这种情况冲突，可以通过重新提供带有自定义实现的 BlockScrollStrategy 来覆盖它。</p>
</blockquote>
<blockquote>
<p>RepositionScrollStrategy 会在滚动时重新定位浮层元素。注意，这会对滚动带来一些性能影响 - 用户应该在每个具体应用的上下文中权衡这种代价。</p>
</blockquote>
<p>当位置重新定位时为了能够固定浮层，可以使用withLockedPosition方法，因此前提是使用RepositionScrollStrategy 滚动策略。</p>
<p>关于search向浮层页传值，因为这个关键词返回值是动态的，而且也没有父子组件嵌套关系,在打印了componentRef类型的门户中可以发现其中的instance属性是wySearchPanelcomponent类型，因此可以直接调用其中的searchResult变量来赋值。<br><img data-src="https://img-blog.csdnimg.cn/20210110232302393.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>关于使用material组件库，其中的难点在于api的不熟悉以及对angular指令化的不理解，关于这个浮层的实现，除了使用这个组件库，关于ngrx插件中的一些方法也不熟悉，但是用了之后是真香！还有就是关于angular的升级，当时导入组件库的时候怎么都报错，根据提示升级后整个项目就炸了，，先是一些引用的报错其次就是一些方法的弃用，到目前为止，项目能跑起来，但总觉得有些数据是不对的，包括方法的使用也是不合适的，等后期总结修改吧！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/72e17053/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/72e17053/" class="post-title-link" itemprop="url">【Angular网易云】--22、歌曲详情</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-30 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-30T17:23:38+08:00">2020-12-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="歌曲详情"><a href="#歌曲详情" class="headerlink" title="歌曲详情"></a>歌曲详情</h1><p>歌曲的详情页面只是个展示页面，唯一的功能就是即时播放按钮。功能和逻辑都与之前的歌单详情一致。</p>
<ul>
<li><p>创建song-info组件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ng g m song-info --routing</span><br><span class="line">ngng c song-info</span><br></pre></td></tr></table></figure>
</li>
<li><p>song-info-routing.moduel.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;songInfo/:id&#x27;</span>, <span class="attr">component</span>: SongInfoComponent, <span class="attr">data</span>: &#123; <span class="attr">titel</span>: <span class="string">&#x27;歌曲详情&#x27;</span> &#125;, <span class="attr">resolve</span>: &#123; <span class="attr">songInfo</span>: SongInfoResolverService &#125; &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">    imports: [RouterModule.forChild(routes)],</span><br><span class="line">    <span class="built_in">exports</span>: [RouterModule],</span><br><span class="line">    providers: [SongInfoResolverService]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>在路由守卫中就有些不一样了，因为获取歌曲详情的API中并没有歌曲的歌词，所以守卫中就需要同时获得选中歌曲的信息以及选中歌曲的歌词</p>
<ul>
<li><p>song-info-resolver.service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>( private songeServe: SongService ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  resolve (route: ActivatedRouteSnapshot): Observable&lt;SongDataModel&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> id = route.paramMap.get(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span> forkJoin([</span><br><span class="line">          <span class="built_in">this</span>.songeServe.getSongDetail(id),</span><br><span class="line">          <span class="built_in">this</span>.songeServe.getLyric(<span class="built_in">Number</span>(id))</span><br><span class="line">      ]).pipe(first())</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sing-info.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;song-info wrap feature-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-wrap6&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-info clearfix&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cover&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">&quot;song.al.picUrl&quot;</span> [<span class="attr">alt</span>]=<span class="string">&quot;song.name&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mask&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cnt&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cntc&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd clearfix&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;f-pr&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tit&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;f-ff2 f-brk&quot;</span>&gt;</span>&#123;&#123;song.name&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user f-cb&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;singers clearfix&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span>&gt;</span>歌手：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clearfix&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let singer of song.ar; last as isLast&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/singer&#x27;, singer.id]&quot;</span>&gt;</span>&#123;&#123;singer.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> [<span class="attr">hidden</span>]=<span class="string">&quot;isLast&quot;</span>&gt;</span>/<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;al&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span>&gt;</span>所属专辑：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;al-name&quot;</span>&gt;</span>&#123;&#123;song.al.name&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;btns&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nz-button-group</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;play&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onAddSong(song,true)&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;play-circle&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>播放</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;add&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onAddSong(song)&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nz-button-group</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn like&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>收藏<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn share&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>分享<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;lyric-info f-brk&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;lyric-content&quot;</span> [<span class="attr">class.expand</span>]=<span class="string">&quot;controlLyric.isExpand&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;lyric-line&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of lyric&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;item.txt&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;item.txtCn&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;toggle-expand&quot;</span>  (<span class="attr">click</span>)=<span class="string">&quot;toggleLyric()&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;controlLyric.label&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> [<span class="attr">nzType</span>]=<span class="string">&quot;controlLyric.iconCls&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>sing-info.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 动态展开</span></span><br><span class="line">   controlLyric = &#123;</span><br><span class="line">       isExpand: <span class="literal">false</span>,</span><br><span class="line">       label: <span class="string">&#x27;展开&#x27;</span>,</span><br><span class="line">       iconCls: <span class="string">&#x27;down&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   song: Song;</span><br><span class="line">   lyric: BaseLyricLine[];</span><br><span class="line"></span><br><span class="line">   currentSong: Song;</span><br><span class="line"></span><br><span class="line">   private destroy$ = <span class="keyword">new</span> Subject&lt;<span class="keyword">void</span>&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">constructor</span>(</span><br><span class="line">       private route: ActivatedRoute,</span><br><span class="line">       private store$: Store&lt;AppStoreModule&gt;,</span><br><span class="line">       private songServe: SongService,</span><br><span class="line">       private message: NzMessageService,</span><br><span class="line">       private batchActionServe: BatchActionsService,</span><br><span class="line">   ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   ngOnInit () &#123;</span><br><span class="line">       <span class="built_in">this</span>.route.data.pipe(map(<span class="function"><span class="params">res</span> =&gt;</span> res.songInfo)).subscribe(<span class="function">(<span class="params">[song, lyric]</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.song = song;</span><br><span class="line">           <span class="built_in">this</span>.lyric = <span class="keyword">new</span> WyLyric(lyric).lines;</span><br><span class="line">           <span class="built_in">this</span>.listenCurrent();</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听当前歌曲变化，当页面销毁时解绑</span></span><br><span class="line">   listenCurrent () &#123;</span><br><span class="line">       <span class="built_in">this</span>.store$.pipe(select(getPlayer), select(getCurrentSong), takeUntil(<span class="built_in">this</span>.destroy$)).subscribe(<span class="function"><span class="params">song</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.currentSong = song;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 展开/折叠</span></span><br><span class="line">   toggleLyric () &#123;</span><br><span class="line">       <span class="built_in">this</span>.controlLyric.isExpand = !<span class="built_in">this</span>.controlLyric.isExpand;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.controlLyric.isExpand) &#123;</span><br><span class="line">           <span class="built_in">this</span>.controlLyric.label = <span class="string">&#x27;收起&#x27;</span>;</span><br><span class="line">           <span class="built_in">this</span>.controlLyric.iconCls = <span class="string">&#x27;up&#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.controlLyric.label = <span class="string">&#x27;展开&#x27;</span>;</span><br><span class="line">           <span class="built_in">this</span>.controlLyric.iconCls = <span class="string">&#x27;down&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加/播放歌曲</span></span><br><span class="line">   onAddSong (song: Song, isPlay = <span class="literal">false</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">this</span>.currentSong || <span class="built_in">this</span>.currentSong.id !== song.id) &#123;</span><br><span class="line">           <span class="built_in">this</span>.songServe.getSongList(song).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (res.length) &#123;</span><br><span class="line">                   <span class="built_in">this</span>.batchActionServe.insertSong(res[<span class="number">0</span>], isPlay);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="built_in">this</span>.message.error(<span class="string">&#x27;NO URL&#x27;</span>)</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ngOnDestroy (): <span class="keyword">void</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.destroy$.next();</span><br><span class="line">       <span class="built_in">this</span>.destroy$.complete();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>逻辑几乎与歌单列表一致，所以这个模块的难度在css样式上！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/b2759e10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/b2759e10/" class="post-title-link" itemprop="url">【Angular网易云】--21、歌单列表功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-27 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-27T17:23:38+08:00">2020-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="歌单"><a href="#歌单" class="headerlink" title="歌单"></a>歌单</h1><p>歌单的主要功能在列表中直接播放和添加歌曲到当前播放列表中以及收藏和分享，但收藏和分享目前是着手于会员功能，暂放，其余都是展示信息。<br><img data-src="https://img-blog.csdnimg.cn/2021010816363365.png"><br><img data-src="https://img-blog.csdnimg.cn/20210108163650641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<p>添加歌单时存在不同的功能，歌单信息中的 ==+== 是添加整个歌单，歌曲列表中的则是仅添加当前选中的。而且歌单信息中的播放不仅要添加还要播放当前歌单，歌曲列表中的播放图标仅播放当前选中的歌曲。</p>
<hr>
<h2 id="歌曲列表"><a href="#歌曲列表" class="headerlink" title="歌曲列表"></a>歌曲列表</h2><ul>
<li><p>sheet-info.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of basicTable.data; index as i&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;first-col&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;i + 1&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico play-song&quot;</span> [<span class="attr">class.current</span>]=<span class="string">&quot;currentIndex === i&quot;</span> <span class="attr">title</span>=<span class="string">&quot;播放&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onAddSong(item,true)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;song-name&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">a</span>&gt;</span> &#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;time-col&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;item.dt / 1000 | formatTime&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;icons&quot;</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico add&quot;</span> <span class="attr">title</span>=<span class="string">&quot;添加&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onAddSong(item)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico like&quot;</span> <span class="attr">title</span>=<span class="string">&quot;收藏&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico share&quot;</span> <span class="attr">title</span>=<span class="string">&quot;分享&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let singer of item.ar; last as isLast&quot;</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">a</span>&gt;</span>&#123;&#123;singer.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">em</span> [<span class="attr">hidden</span>]=<span class="string">&quot;isLast&quot;</span>&gt;</span>/<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.al.name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出，添加和播放用同样的回调，根据传参的不通来决定后续的流程，这样可以增加方法的复用性。</p>
</li>
<li><p>sheet-info.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">   sheetInfo: SongSheet; <span class="comment">// 歌单列表</span></span><br><span class="line">   currentSong: Song; <span class="comment">// 当前歌曲</span></span><br><span class="line">   currentIndex = <span class="number">-1</span>; <span class="comment">// 当前歌曲索引</span></span><br><span class="line">   private destroy$ = <span class="keyword">new</span> Subject&lt;<span class="keyword">void</span>&gt;(); <span class="comment">// 发射流</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">constructor</span>(</span><br><span class="line">       private route: ActivatedRoute,</span><br><span class="line">       private store$: Store&lt;AppStoreModule&gt;,</span><br><span class="line">       private barchActionServe: BatchActionsService</span><br><span class="line">   ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   ngOnInit () &#123;</span><br><span class="line">       <span class="built_in">this</span>.route.data.pipe(map(<span class="function"><span class="params">res</span> =&gt;</span> res.sheetInfo)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.sheetInfo = res;</span><br><span class="line">           <span class="keyword">if</span> (res.description) &#123;</span><br><span class="line">               <span class="built_in">this</span>.changeDesc(res.description)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="built_in">this</span>.listenCurrent();</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 监听当前歌曲</span></span><br><span class="line">   private listenCurrent () &#123;</span><br><span class="line">       <span class="built_in">this</span>.store$.pipe(select(getPlayer), select(getCurrentSong), takeUntil(<span class="built_in">this</span>.destroy$)).subscribe(<span class="function"><span class="params">song</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.currentSong = song;</span><br><span class="line">           <span class="keyword">if</span> (song) &#123;</span><br><span class="line">               <span class="built_in">this</span>.currentIndex = findIndex(<span class="built_in">this</span>.sheetInfo.tracks, song);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.currentIndex = <span class="number">-1</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 添加一首歌曲</span></span><br><span class="line">   onAddSong (song: Song, isPlay = <span class="literal">false</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">this</span>.currentSong || <span class="built_in">this</span>.currentSong.id !== song.id) &#123;</span><br><span class="line">           <span class="built_in">this</span>.barchActionServe.insertSong(song, isPlay);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加歌单</span></span><br><span class="line">   onAddSongs (songs: Song[], isPlay = <span class="literal">false</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (songs.length) &#123;</span><br><span class="line">           <span class="keyword">if</span> (isPlay) &#123;</span><br><span class="line">               <span class="built_in">this</span>.barchActionServe.selectPlayList(&#123; <span class="attr">list</span>: songs, <span class="attr">index</span>: <span class="number">0</span> &#125;)</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.barchActionServe.insertSongs(<span class="built_in">this</span>.sheetInfo.tracks);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ngOnDestroy (): <span class="keyword">void</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.destroy$.next();</span><br><span class="line">       <span class="built_in">this</span>.destroy$.complete();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在初始化页面处理歌单信息后会使用Store来监听当前歌曲的变化直到页面销毁时解绑。当点击了添加时，首先判断当前歌曲是否存在或者当前歌曲的ID与选中歌曲的ID是否相同，不相同则会将选中的歌曲封装的批量处理歌曲类来向当前播放列表和歌单列表中添加选中的歌曲。</p>
</li>
<li><p>batch-actions.service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加歌曲</span></span><br><span class="line">insertSong (song: Song, <span class="attr">isPlay</span>: boolean) &#123;</span><br><span class="line">    <span class="keyword">const</span> songList = <span class="built_in">this</span>.playState.songList.slice();</span><br><span class="line">    <span class="keyword">const</span> playList = <span class="built_in">this</span>.playState.playList.slice();</span><br><span class="line">    <span class="keyword">let</span> insertIndex = <span class="built_in">this</span>.playState.currentIndex;</span><br><span class="line">    <span class="keyword">const</span> pIndex = findIndex(playList, song);</span><br><span class="line">    <span class="keyword">if</span> (pIndex &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 歌曲已经存在</span></span><br><span class="line">        <span class="keyword">if</span> (isPlay) &#123;</span><br><span class="line">            insertIndex = pIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        songList.push(song);</span><br><span class="line">        playList.push(song);</span><br><span class="line">        <span class="keyword">if</span> (isPlay) &#123;</span><br><span class="line">            insertIndex = songList.length - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList &#125;));</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (insertIndex !== <span class="built_in">this</span>.playState.currentIndex) &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; <span class="attr">currentIndex</span>: insertIndex &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果点了列表中播放图标，则会多传递一个isPlay来判断当前选中的歌曲是否播放。如果选中的歌曲不在当前列表中，则会更新当前歌曲索引并将索引值传递过去，从而直接播放选中歌曲。</p>
</li>
</ul>
<hr>
<h2 id="歌单详情"><a href="#歌单详情" class="headerlink" title="歌单详情"></a>歌单详情</h2><p>歌单详情部分的播放和添加就是以歌单为单位进行处理。</p>
<ul>
<li>sheet-info.component.html<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;nz-button-group <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;btn&quot;</span>&gt;</span><br><span class="line">	&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;play&quot;</span> nz-button nzType=<span class="string">&quot;primary&quot;</span> (click)=<span class="string">&quot;onAddSongs(sheetInfo.tracks, true)&quot;</span>&gt;</span><br><span class="line">    	&lt;i nz-icon nzType=<span class="string">&quot;play-circle&quot;</span> nzTheme=<span class="string">&quot;outline&quot;</span>&gt;&lt;/i&gt;播放</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">    &lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;add&quot;</span> nz-button nzType=<span class="string">&quot;primary&quot;</span> (click)=<span class="string">&quot;onAddSongs(sheetInfo.tracks)&quot;</span>&gt;+&lt;/button&gt;</span><br><span class="line">&lt;/nz-button-group&gt;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>sheet-info.component.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加歌单</span></span><br><span class="line"> onAddSongs (songs: Song[], isPlay = <span class="literal">false</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (songs.length) &#123;</span><br><span class="line">           <span class="keyword">if</span> (isPlay) &#123;</span><br><span class="line">               <span class="built_in">this</span>.barchActionServe.selectPlayList(&#123; <span class="attr">list</span>: songs, <span class="attr">index</span>: <span class="number">0</span> &#125;)</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.barchActionServe.insertSongs(<span class="built_in">this</span>.sheetInfo.tracks);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>batch-action.service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  添加歌单</span></span><br><span class="line"> insertSongs (songs: Song[]) &#123;</span><br><span class="line">       <span class="keyword">const</span> songList = <span class="built_in">this</span>.playState.songList.slice();</span><br><span class="line">       <span class="keyword">const</span> playList = <span class="built_in">this</span>.playState.playList.slice();</span><br><span class="line">       songs.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">const</span> pIndex = findIndex(playList, item);</span><br><span class="line">           <span class="keyword">if</span> (pIndex === <span class="number">-1</span>) &#123;</span><br><span class="line">               songList.push(item)</span><br><span class="line">               playList.push(item)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList &#125;));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同歌单列表中的处理一样，都是选择复用回调，而实参的变化也仅是歌单和歌曲。</p>
</li>
</ul>
<hr>
<p>关于之前修改的获取完整信息的API，总是出现实际的歌单列表与获取渲染的歌曲列表不相符的问题，我想应该找到了。在拼接URL这一环节中，会将ID相对应的歌曲进行拼接，而有的歌曲是没有URL的，估计是和版权受限有关，所以在迭代列表的时候就会将一些没有URL的歌曲给筛选掉了。这个歌曲列表的数据能够完成目前的调试，为了追进度，所以现在选择暂时不去理会这个bug，再挖一个坑！！！！！！！！！！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Luck_SUN"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Luck_SUN</p>
  <div class="site-description" itemprop="description">凛冬散尽，星河长明</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/sunwenwei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sunwenwei" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sunWorkOne@163.com" title="E-Mail → mailto:sunWorkOne@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6411331687?is_all=1" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6411331687?is_all&#x3D;1" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/sungoodluck666" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sungoodluck666" rel="noopener" target="_blank"><i class="fa fa-eye fa-fw"></i>CSDN</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Luck_SUN</span>
    <span class="post-meta-divider"><br/></span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">184k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:47</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://lucksun.work/',]
      });
      });
  </script>

</body>
<script type="text/javascript" src="/js/click_show_text.js"></script>
</html>
