<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
<meta name="baidu-site-verification" content="code-ULv5esGRN0" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lucksun.work","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="凛冬散尽，星河长明">
<meta property="og:type" content="website">
<meta property="og:title" content="Luck_SUN">
<meta property="og:url" content="http://lucksun.work/page/2/index.html">
<meta property="og:site_name" content="Luck_SUN">
<meta property="og:description" content="凛冬散尽，星河长明">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Luck_SUN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://lucksun.work/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Luck_SUN</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6cbaa2e8cde5f381abcb1a50f8cdfc86";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Luck_SUN" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Luck_SUN</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">43</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">7</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/sunwenwei" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/7c02564b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/7c02564b/" class="post-title-link" itemprop="url">【Angular网易云】--20、歌单详情</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-21 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-21T17:23:38+08:00">2020-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="歌单详情"><a href="#歌单详情" class="headerlink" title="歌单详情"></a>歌单详情</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在首页和歌单列表页，点击歌单图片能够查看当前歌单的详细信息，包括歌单内的歌曲</p>
<h2 id="创建新模块"><a href="#创建新模块" class="headerlink" title="创建新模块"></a>创建新模块</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ng g m sheet-info --routing</span><br><span class="line">ng g c sheet-info</span><br></pre></td></tr></table></figure>
<p>api接口是之前就写好的，所以api不会有什么变化，但是需要使用路由守卫来拦截数据。</p>
<ul>
<li><p>sheet.service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取歌单详情</span></span><br><span class="line">   getSongSheetDetail (id: number): Observable&lt;SongSheet&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;id&#x27;</span>, id.toString());</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.url + <span class="string">&quot;playlist/detail&quot;</span>, &#123; params &#125;)</span><br><span class="line">           .pipe(map(<span class="function">(<span class="params">res: &#123; playlist: SongSheet &#125;</span>) =&gt;</span> res.playlist));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sheet-info-resolver.service.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SheetInfoResolverService <span class="keyword">implements</span> Resolve&lt;SongSheet&gt;&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> sheetServer: SheetService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    resolve (route: ActivatedRouteSnapshot): Observable&lt;SongSheet&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.sheetServer.getSongSheetDetail(<span class="built_in">Number</span>(route.paramMap.get(<span class="string">&#x27;id&#x27;</span>)))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在跳转到歌单详情页面时会先通过路由守卫，守卫此时会调取api获得歌单的信息，组件就能直接使用守卫的返回值，所以在路由配置的时候就要把守卫配进去</p>
</li>
</ul>
<hr>
<ul>
<li><p>sheet-info-routing.moduel.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;sheetInfo/:id&#x27;</span>, <span class="attr">component</span>: SheetInfoComponent, <span class="attr">data</span>: &#123; <span class="attr">titel</span>: <span class="string">&#x27;歌单详情&#x27;</span> &#125;, <span class="attr">resolve</span>: &#123; <span class="attr">sheetInfo</span>: SheetInfoResolverService &#125; &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<hr>
</li>
<li><p>sheet-info.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sheet-info wrap feature-wrap&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-wrap6&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 头部歌单信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-info clearfix&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cover&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">&quot;sheetInfo.coverImgUrl&quot;</span> [<span class="attr">alt</span>]=<span class="string">&quot;sheetInfo.name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mask&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cnt&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cntc&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd clearfix&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;f-pr&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tit&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;f-ff2&quot;</span>&gt;</span>&#123;&#123;sheetInfo.name&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user f-cb&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;face&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!sheetInfo.creator&quot;</span> [<span class="attr">href</span>]=<span class="string">&quot;&#x27;//music.163.com/artist?id=&#x27; + sheetInfo.userId&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">&quot;sheetInfo.creator?.avatarUrl&quot;</span> [<span class="attr">alt</span>]=<span class="string">&quot;sheetInfo.creator?.nickname&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> [<span class="attr">href</span>]=<span class="string">&quot;&#x27;//music.163.com/artist?id=&#x27; + sheetInfo.userId&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">&quot;s-fc7&quot;</span>&gt;</span>&#123;&#123;sheetInfo.creator?.nickname&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;time s-fc4&quot;</span>&gt;</span>&#123;&#123;sheetInfo.createTime | date: &#x27;yyyy-MM-dd&#x27;&#125;&#125;创建<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;btns&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-button-group</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;play&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> <span class="attr">nzType</span>=<span class="string">&quot;play-circle&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>播放</span><br><span class="line">              <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;add&quot;</span> <span class="attr">nz-button</span> <span class="attr">nzType</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-button-group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn like&quot;</span> <span class="attr">nz-button</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>收藏<span class="tag">&lt;/<span class="name">span</span>&gt;</span>(&#123;&#123;sheetInfo.subscribedCount&#125;&#125;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn share&quot;</span> <span class="attr">nz-button</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>分享<span class="tag">&lt;/<span class="name">span</span>&gt;</span>(&#123;&#123;sheetInfo.shareCount&#125;&#125;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tags clearfix&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>标签<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tag-wrap&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">nz-tag</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of sheetInfo.tags&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">nz-tag</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;intr f-brk&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;controlDesc.isExpand&quot;</span> [<span class="attr">innerHTML</span>]=<span class="string">&quot;description.long&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!controlDesc.isExpand&quot;</span> [<span class="attr">innerHTML</span>]=<span class="string">&quot;description.short&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;expand&quot;</span> *<span class="attr">ngIf</span>=<span class="string">&quot;description.long&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;toggleDesc()&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;controlDesc.label&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">nz-icon</span> [<span class="attr">nzType</span>]=<span class="string">&quot;controlDesc.iconCls&quot;</span> <span class="attr">nzTheme</span>=<span class="string">&quot;outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 歌单列表信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wy-sec&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;u-title wy-sec-wrap clearfix&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;wy-sec-tit&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;f-ff2&quot;</span>&gt;</span>歌曲列表<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;sub s-fc3&quot;</span>&gt;</span></span><br><span class="line">          &#123;&#123;sheetInfo.tracks.length&#125;&#125;首歌</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;more s-fc3&quot;</span>&gt;</span></span><br><span class="line">          播放：</span><br><span class="line">          <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">&quot;s-fc6&quot;</span>&gt;</span>&#123;&#123;sheetInfo.playCount&#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">          次</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 表格信息 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nz-table</span> <span class="attr">class</span>=<span class="string">&quot;wy-table&quot;</span> #<span class="attr">basicTable</span> [<span class="attr">nzData</span>]=<span class="string">&quot;sheetInfo.tracks&quot;</span> [<span class="attr">nzFrontPagination</span>]=<span class="string">&quot;false&quot;</span> <span class="attr">nzBordered</span></span></span><br><span class="line"><span class="tag">        <span class="attr">nzNoResult</span>=<span class="string">&quot;暂无音乐!&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">nzWidth</span>=<span class="string">&quot;80px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">nzWidth</span>=<span class="string">&quot;120px&quot;</span>&gt;</span>时长<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">nzWidth</span>=<span class="string">&quot;80px&quot;</span>&gt;</span>歌手<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span>&gt;</span>专辑<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of basicTable.data; index as i&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;first-col&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;i + 1&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico play-song&quot;</span> <span class="attr">title</span>=<span class="string">&quot;播放&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;song-name&quot;</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">a</span>&gt;</span> &#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;time-col&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;item.dt / 1000 | formatTime&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;icons&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico add&quot;</span> <span class="attr">title</span>=<span class="string">&quot;添加&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico like&quot;</span> <span class="attr">title</span>=<span class="string">&quot;收藏&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico share&quot;</span> <span class="attr">title</span>=<span class="string">&quot;分享&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let singer of item.ar; last as isLast&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span>&gt;</span>&#123;&#123;singer.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">em</span> [<span class="attr">hidden</span>]=<span class="string">&quot;isLast&quot;</span>&gt;</span>/<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                  &#123;&#123;item.al.name&#125;&#125;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nz-table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>sheet-info.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">sheetInfo: SongSheet; <span class="comment">// 歌单列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 歌单描述</span></span><br><span class="line">description = &#123;</span><br><span class="line">    short: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    long: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态展开</span></span><br><span class="line">controlDesc = &#123;</span><br><span class="line">    isExpand: <span class="literal">false</span>,</span><br><span class="line">    label: <span class="string">&#x27;展开&#x27;</span>,</span><br><span class="line">    iconCls: <span class="string">&#x27;down&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">constructor</span>( private route: ActivatedRoute) &#123; &#125;</span><br><span class="line"></span><br><span class="line">ngOnInit () &#123;</span><br><span class="line">    <span class="built_in">this</span>.route.data.pipe(map(<span class="function"><span class="params">res</span> =&gt;</span> res.sheetInfo)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sheetInfo = res;</span><br><span class="line">        <span class="keyword">if</span> (res.description) &#123;</span><br><span class="line">            <span class="built_in">this</span>.changeDesc(res.description)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理歌单描述</span></span><br><span class="line">private changeDesc (desc: string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (desc.length &lt; <span class="number">99</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = &#123;</span><br><span class="line">            short: <span class="built_in">this</span>.replaceBr(<span class="string">&#x27;&lt;b&gt;介绍： &lt;/b&gt;&#x27;</span> + desc),</span><br><span class="line">            long: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = &#123;</span><br><span class="line">            short: <span class="built_in">this</span>.replaceBr(<span class="string">&#x27;&lt;b&gt;介绍： &lt;/b&gt;&#x27;</span> + desc.slice(<span class="number">0</span>, <span class="number">99</span>)) + <span class="string">&#x27;...&#x27;</span>,</span><br><span class="line">            long: <span class="built_in">this</span>.replaceBr(<span class="string">&#x27;&lt;b&gt;介绍： &lt;/b&gt;&#x27;</span> + desc)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换换行符</span></span><br><span class="line">private replaceBr (str: string): string &#123;</span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="regexp">/\n/g</span>, <span class="string">&#x27;&lt;br /&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 展开折叠</span></span><br><span class="line">toggleDesc () &#123;</span><br><span class="line">    <span class="built_in">this</span>.controlDesc.isExpand = !<span class="built_in">this</span>.controlDesc.isExpand;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.controlDesc.isExpand) &#123;</span><br><span class="line">        <span class="built_in">this</span>.controlDesc.label = <span class="string">&#x27;收起&#x27;</span>;</span><br><span class="line">        <span class="built_in">this</span>.controlDesc.iconCls = <span class="string">&#x27;up&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.controlDesc.label = <span class="string">&#x27;展开&#x27;</span>;</span><br><span class="line">        <span class="built_in">this</span>.controlDesc.iconCls = <span class="string">&#x27;down&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
点击列表图片，将会获取到歌单的ID，此时在跳向详情页之前通过路由守卫得到当前歌单的信息，之后再将直观的信息渲染到页面。</li>
</ul>
<p>在歌单描述的字段上，关于展开折叠的数据显示并是使用ngIf指令来动态显示。</p>
<hr>
<p>我以为获取歌单信息不用改，看了返回数据后才发现之前用的也是改后的，所以使用视频里边的数据是不行的，tracks是不够的，仅有三条，所以还是要用trackIDs来获取所有的数据然后在用。</p>
<ul>
<li><p>sheet,service.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 临时更改数据源（获取歌单详情）</span></span><br><span class="line">  <span class="keyword">async</span> getSongSheetDetail2 (id: number) &#123;</span><br><span class="line">      <span class="keyword">const</span> tempSheet = <span class="built_in">this</span>.getSongSheetDetail(id).toPromise();</span><br><span class="line">      <span class="keyword">const</span> tempTracks = <span class="built_in">this</span>.playSheet(id).toPromise();</span><br><span class="line">      (<span class="keyword">await</span> tempSheet).tracks = (<span class="keyword">await</span> tempTracks);</span><br><span class="line">      <span class="keyword">return</span> tempSheet;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sheet-info-resolver.server.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(</span><br><span class="line">       private sheetServer: SheetService,</span><br><span class="line">   ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   resolve (route: ActivatedRouteSnapshot) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.sheetServer.getSongSheetDetail2(<span class="built_in">Number</span>(route.paramMap.get(<span class="string">&#x27;id&#x27;</span>)))</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p><img data-src="https://img-blog.csdnimg.cn/20210107171000374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<p>写的有问题，数据还是拿不全，trackids内的数据和渲染的数据是不对的，这个问题之前就有，一直搞不明白为什么，这个promise的用法估计也是错的，但是照目前的接口来用的话，数据是可以达到正常的分页量的，这个坑我能挖穿！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/9df84b40/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/9df84b40/" class="post-title-link" itemprop="url">【Angular网易云】--19、歌单列表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-18 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-18T17:23:38+08:00">2020-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="系列文章目录"><a href="#系列文章目录" class="headerlink" title="系列文章目录"></a>系列文章目录</h1><p>点击热门推荐部分，根据歌单标签去进入相应的歌单列表页。<br><img data-src="https://img-blog.csdnimg.cn/20210106185507464.png"><br>在pages目录下新建歌单列表模块</p>
<blockquote>
<p>ng g m sheet-list –routing<br>ng g c sheet-list</p>
</blockquote>
<ul>
<li>sheet.service.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 歌单参数类型</span></span><br><span class="line"><span class="keyword">export</span> type SheetParams = &#123;</span><br><span class="line">    offset: number, <span class="comment">// 偏移数量 , 用于分页 , 如 :( 评论页数 -1)*50, 其中 50 为 limit 的值</span></span><br><span class="line">    limit: number, <span class="comment">// 取出歌单数量 </span></span><br><span class="line">    order: <span class="string">&#x27;new&#x27;</span> | <span class="string">&#x27;hot&#x27;</span>, <span class="comment">// 最新和最热</span></span><br><span class="line">    cat: string, <span class="comment">// 歌单标签</span></span><br><span class="line">&#125;</span><br><span class="line">   <span class="comment">// 获取歌单列表</span></span><br><span class="line">    getSheets (args: SheetParams): Observable&lt;SheetList&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromString</span>: queryString.stringify(args) &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.url + <span class="string">&#x27;top/playList&#x27;</span>, &#123; params &#125;).pipe(map(<span class="function"><span class="params">res</span> =&gt;</span> res <span class="keyword">as</span> SheetList))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>common.types.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 歌单列表</span></span><br><span class="line"><span class="keyword">export</span> type SheetList = &#123;</span><br><span class="line">    playlists: SongSheet[],</span><br><span class="line">    total: number,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>sheet-list.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sheet warp feature-warp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-r&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 头部 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;top&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cat&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;listParams.cat&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nz-radio-group</span> <span class="attr">nzButtonStyle</span>=<span class="string">&quot;solid&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;orderValue&quot;</span> (<span class="attr">ngModelChange</span>)=<span class="string">&quot;onOrderChange($event)&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">nz-radio-button</span> <span class="attr">nzValue</span>=<span class="string">&quot;hot&quot;</span>&gt;</span>热门<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">nz-radio-button</span> <span class="attr">nzValue</span>=<span class="string">&quot;new&quot;</span>&gt;</span>最新<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">nz-radio-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 列表 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">app-single-sheet</span></span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">&quot;sheet-item&quot;</span></span></span><br><span class="line"><span class="tag">                *<span class="attr">ngFor</span>=<span class="string">&quot;let item of sheets?.playlists&quot;</span></span></span><br><span class="line"><span class="tag">                [<span class="attr">sheet</span>]=<span class="string">&quot;item&quot;</span></span></span><br><span class="line"><span class="tag">                (<span class="attr">onPlay</span>)=<span class="string">&quot;onPlaySheet($event);&quot;</span></span></span><br><span class="line"><span class="tag">            &gt;</span><span class="tag">&lt;/<span class="name">app-single-sheet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 分页 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nz-pagination</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;pagination&quot;</span></span></span><br><span class="line"><span class="tag">            [<span class="attr">nzPageIndex</span>]=<span class="string">&quot;listParams.offset&quot;</span></span></span><br><span class="line"><span class="tag">            [<span class="attr">nzPageSize</span>]=<span class="string">&quot;listParams.limit&quot;</span></span></span><br><span class="line"><span class="tag">            [<span class="attr">nzTotal</span>]=<span class="string">&quot;sheets?.total&quot;</span></span></span><br><span class="line"><span class="tag">            (<span class="attr">nzPageIndexChange</span>)=<span class="string">&quot;onPageChange($event)&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">nz-pagination</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
其中使用了 <strong><a target="_blank" rel="noopener" href="https://ng-zorro.gitee.io/components/overview/zh">ng-zorro</a></strong> 组件库中的单选按钮组和分页器。</li>
</ul>
<hr>
<ul>
<li>sheet-list.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取歌单的参数</span></span><br><span class="line">   listParams: SheetParams = &#123;</span><br><span class="line">       cat: <span class="string">&#x27;全部&#x27;</span>,</span><br><span class="line">       order: <span class="string">&#x27;hot&#x27;</span>,</span><br><span class="line">       offset: <span class="number">1</span>,</span><br><span class="line">       limit: <span class="number">15</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   sheets: SheetList; <span class="comment">// 歌单列表</span></span><br><span class="line">   orderValue = <span class="string">&#x27;hot&#x27;</span>; <span class="comment">// 歌单标签</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">constructor</span>(</span><br><span class="line">       private route: ActivatedRoute,</span><br><span class="line">       private SheetServe: SheetService,</span><br><span class="line">       private batchActionsServe: BatchActionsService</span><br><span class="line">   ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   ngOnInit () &#123;</span><br><span class="line">   	<span class="comment">// 通过路由获取参数</span></span><br><span class="line">       <span class="built_in">this</span>.listParams.cat = <span class="built_in">this</span>.route.snapshot.queryParamMap.get(<span class="string">&#x27;cat&#x27;</span>) || <span class="string">&#x27;全部&#x27;</span>;</span><br><span class="line">       <span class="built_in">this</span>.getList();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取歌单列表</span></span><br><span class="line">   private getList () &#123;</span><br><span class="line">       <span class="built_in">this</span>.SheetServe.getSheets(<span class="built_in">this</span>.listParams).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">this</span>.sheets = res);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 播放</span></span><br><span class="line">   onPlaySheet (id: number) &#123;</span><br><span class="line">       <span class="built_in">this</span>.SheetServe.playSheet(id).subscribe(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.batchActionsServe.selectPlayList(&#123; list, <span class="attr">index</span>: <span class="number">0</span> &#125;)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 更改最新和最热</span></span><br><span class="line">   onOrderChange (order: <span class="string">&#x27;new&#x27;</span> | <span class="string">&#x27;hot&#x27;</span>) &#123;</span><br><span class="line">       <span class="built_in">this</span>.listParams.order = order;</span><br><span class="line">       <span class="built_in">this</span>.listParams.offset = <span class="number">1</span>;</span><br><span class="line">       <span class="built_in">this</span>.getList();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 分页</span></span><br><span class="line">   onPageChange (offset: number) &#123;</span><br><span class="line">       <span class="built_in">this</span>.listParams.offset = offset;</span><br><span class="line">       <span class="built_in">this</span>.getList();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<img data-src="https://img-blog.csdnimg.cn/20210106191507571.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这一部分倒是很简单，使用了组件库就可以用组件库中的各个API，倒是很方便。这一节也涉及到了传参的知识点，也是总结一下比较好。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/380c5f41/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/380c5f41/" class="post-title-link" itemprop="url">【Angular网易云】--18、面板优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-14 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-14T17:23:38+08:00">2020-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="封装Actions"><a href="#封装Actions" class="headerlink" title="封装Actions"></a>封装Actions</h2><blockquote>
<p>将重复使用到的功能封装成单独的类来降低系统的耦合性</p>
</blockquote>
<h3 id="在Store目录下新增服务类"><a href="#在Store目录下新增服务类" class="headerlink" title="在Store目录下新增服务类"></a>在Store目录下新增服务类</h3><ul>
<li>batch-actions.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g s batch-actions</span><br></pre></td></tr></table></figure>
<h3 id="注入Store并且订阅动作"><a href="#注入Store并且订阅动作" class="headerlink" title="注入Store并且订阅动作"></a>注入Store并且订阅动作</h3></li>
<li>batch-actions.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private playState: PlayState;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">      private store$: Store&lt;AppStoreModule&gt;,</span><br><span class="line">  ) &#123;</span><br><span class="line">      <span class="built_in">this</span>.store$.pipe(select(getPlayer)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">this</span>.playState = res)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="添加回调"><a href="#添加回调" class="headerlink" title="添加回调"></a>添加回调</h3><ul>
<li>batch-actions.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 播放列表</span></span><br><span class="line">   selectPlayList (&#123; list, index &#125;: &#123; <span class="attr">list</span>: Song[], <span class="attr">index</span>: number &#125;) &#123;</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; <span class="attr">songList</span>: list &#125;));</span><br><span class="line">       <span class="keyword">let</span> trueIndex = index;</span><br><span class="line">       <span class="keyword">let</span> trueList = list.slice();</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.playState.playMode.type === <span class="string">&quot;random&quot;</span>) &#123;</span><br><span class="line">           trueList = shuffle(list || []);</span><br><span class="line">           trueIndex = findIndex(trueList, list[trueIndex]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; <span class="attr">playList</span>: trueList &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; <span class="attr">currentIndex</span>: trueIndex &#125;));</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 删除当前歌曲</span></span><br><span class="line">   deleteSong (song: Song) &#123;</span><br><span class="line">       <span class="keyword">const</span> songList = <span class="built_in">this</span>.playState.songList.slice();</span><br><span class="line">       <span class="keyword">const</span> playList = <span class="built_in">this</span>.playState.playList.slice();</span><br><span class="line">       <span class="keyword">let</span> currentIndex = <span class="built_in">this</span>.playState.currentIndex;</span><br><span class="line">       <span class="keyword">const</span> sIndex = findIndex(songList, song);</span><br><span class="line">       songList.splice(sIndex, <span class="number">1</span>);</span><br><span class="line">       <span class="keyword">const</span> pIndex = findIndex(playList, song);</span><br><span class="line">       playList.splice(pIndex, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (currentIndex &gt; pIndex || currentIndex === playList.length) &#123;</span><br><span class="line">           currentIndex--;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex &#125;));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 清空歌曲</span></span><br><span class="line">   clearSong () &#123;</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; <span class="attr">songList</span>: [] &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; <span class="attr">playList</span>: [] &#125;));</span><br><span class="line">       <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; <span class="attr">currentIndex</span>: <span class="number">-1</span> &#125;));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="在原来的调用上更改调用方法"><a href="#在原来的调用上更改调用方法" class="headerlink" title="在原来的调用上更改调用方法"></a>在原来的调用上更改调用方法</h3><ul>
<li>home.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击歌单，获取歌单信息</span></span><br><span class="line"> onPlaySheet (id: number) &#123;</span><br><span class="line">     <span class="built_in">this</span>.sheetServe.playSheet(id).subscribe(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>.batchActionsServer.selectPlayList(&#123; list, <span class="attr">index</span>: <span class="number">0</span> &#125;);</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>wy-player.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除当前歌曲</span></span><br><span class="line"> onDeleteSong (song: Song) &#123;</span><br><span class="line">     <span class="built_in">this</span>.batchActionsServer.deleteSong(song);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 清空歌曲</span></span><br><span class="line"> onClearSong () &#123;</span><br><span class="line">     <span class="built_in">this</span>.nzModalServer.confirm(&#123;</span><br><span class="line">         nzTitle: <span class="string">&quot;确认清空列表？&quot;</span>,</span><br><span class="line">         nzOnOk: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">             <span class="built_in">this</span>.batchActionsServer.clearSong();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="使用指令更改面板绑定"><a href="#使用指令更改面板绑定" class="headerlink" title="使用指令更改面板绑定"></a>使用指令更改面板绑定</h2><p>将绑定与解绑封装为单独的指令文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g d clickoutside</span><br></pre></td></tr></table></figure>

<ul>
<li>wy-player.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-player&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">appClickoutside</span></span></span><br><span class="line"><span class="tag">     (<span class="attr">onClickOutSide</span>)=<span class="string">&quot;onClickOutSide()&quot;</span></span></span><br><span class="line"><span class="tag">     [<span class="attr">bindFlag</span>]=<span class="string">&quot;bindFlag&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>wy-player.component.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> bindFlag = <span class="literal">false</span>; <span class="comment">//  是否绑定 document click事件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击面板外部</span></span><br><span class="line"> onClickOutSide () &#123;</span><br><span class="line">     <span class="built_in">this</span>.showVolumePanel = <span class="literal">false</span>;</span><br><span class="line">     <span class="built_in">this</span>.showPanel = <span class="literal">false</span>;</span><br><span class="line">     <span class="built_in">this</span>.bindFlag = <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 控制音量面板</span></span><br><span class="line"> toggleVolPanel () &#123;</span><br><span class="line">     <span class="built_in">this</span>.togglePanel(<span class="string">&#x27;showVolumePanel&#x27;</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 控制列表面板</span></span><br><span class="line"> toggleListPanel () &#123;</span><br><span class="line">     <span class="built_in">this</span>.togglePanel(<span class="string">&#x27;showPanel&#x27;</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 面板回调</span></span><br><span class="line"> togglePanel (<span class="keyword">type</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">     <span class="built_in">this</span>[<span class="keyword">type</span>] = !<span class="built_in">this</span>[<span class="keyword">type</span>];</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.showVolumePanel || <span class="built_in">this</span>.showPanel) &#123;</span><br><span class="line">         <span class="built_in">this</span>.bindFlag = <span class="literal">true</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>.bindFlag = <span class="literal">false</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<ul>
<li>clickoutside.directive.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; DOCUMENT &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Directive, ElementRef, EventEmitter, Inject, Input, OnChanges, Output, Renderer2, SimpleChanges &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Directive(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;[appClickoutside]&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickoutsideDirective</span> <span class="title">implements</span> <span class="title">OnChanges</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private handleClick: <span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    @Output() onClickOutSide = <span class="keyword">new</span> EventEmitter&lt;<span class="keyword">void</span>&gt;(); <span class="comment">// 发射解绑</span></span><br><span class="line">    @Input() bindFlag = <span class="literal">false</span>; <span class="comment">// 是否需要绑定</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        private el: ElementRef, // dom</span><br><span class="line">        private rd: Renderer2, // DOM渲染器，用来操作DOM</span><br><span class="line">        @Inject(DOCUMENT) private doc: Document</span><br><span class="line">    ) &#123;&#125;</span><br><span class="line">    <span class="comment">// 监听钩子</span></span><br><span class="line">    ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes.bindFlag &amp;&amp; !changes.bindFlag.firstChange) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.bindFlag) &#123;</span><br><span class="line">                <span class="built_in">this</span>.handleClick = <span class="built_in">this</span>.rd.listen(<span class="built_in">this</span>.doc, <span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="params">fun</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> isContain = <span class="built_in">this</span>.el.nativeElement.contains(fun.target)</span><br><span class="line">                    <span class="keyword">if</span> (!isContain) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.onClickOutSide.emit();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.handleClick();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
第一次进入首页之后，点击面板和面板之外的地方不会有任何操作，当点击歌单列表面板和音量面板，此时会触发回调，根据歌单面板和音量面板的显隐来给bindFlag赋值，然后将bindFlag传给指令文件。</li>
</ul>
<p><strong>点击面板按钮触发面板显示之后，bindFlag此时为true，此时使用angular渲染器将为面板DOM添加click事件，判断当前点击的节点是否被面板节点包含，从而决定是否关闭面板并解绑。</strong></p>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000010326100">《Angular Renderer (渲染器)》</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/ad82e9e3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/ad82e9e3/" class="post-title-link" itemprop="url">【Angular网易云】--17、删除和清空歌曲</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-12 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-12T17:23:38+08:00">2020-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p>完善列表面板上的其他功能，实现单条歌曲的删除以及整个列表歌曲的清空。<br><img data-src="https://img-blog.csdnimg.cn/20210104135903254.png"></p>
<hr>
<h2 id="删除列表歌曲"><a href="#删除列表歌曲" class="headerlink" title="删除列表歌曲"></a>删除列表歌曲</h2><p>在点击删除图标时，传递当前点击歌曲，在播放列表中查找并删除，同时有关索引的变化也要考虑进去。</p>
<ul>
<li><p>wy-player-panel.componet.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico trush&quot;</span> <span class="attr">title</span>=<span class="string">&quot;删除&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onDeleteSong.emit(item)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player-panel.componet.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Output</span>() onDeleteSong = <span class="keyword">new</span> EventEmitter&lt;Song&gt;();  <span class="comment">// 删除选中歌曲</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">	 <span class="comment">// 监听歌单列表</span></span><br><span class="line">        <span class="keyword">if</span> (changes.songList) &#123;</span><br><span class="line">        	<span class="comment">// 更新当前歌曲索引</span></span><br><span class="line">            <span class="built_in">this</span>.updateCurrentIndex();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 更新当前歌曲索引</span></span><br><span class="line">    <span class="keyword">private</span> updateCurrentIndex () &#123;</span><br><span class="line">        <span class="built_in">this</span>.currentIndex = findIndex(<span class="built_in">this</span>.songList, <span class="built_in">this</span>.currentSong);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 播放面板 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">app-wy-player-panel</span> </span></span><br><span class="line"><span class="tag">           (<span class="attr">onDeleteSong</span>)=<span class="string">&quot;onDeleteSong($event)&quot;</span></span></span><br><span class="line"><span class="tag">         &gt;</span><span class="tag">&lt;/<span class="name">app-wy-player-panel</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除当前歌曲</span></span><br><span class="line">  onDeleteSong (song: Song) &#123;</span><br><span class="line">      <span class="keyword">const</span> songList = <span class="built_in">this</span>.songList.slice();</span><br><span class="line">      <span class="keyword">const</span> playList = <span class="built_in">this</span>.playList.slice();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> currentIndex = <span class="built_in">this</span>.currentIndex;</span><br><span class="line">      <span class="keyword">const</span> sIndex = findIndex(songList, song);</span><br><span class="line">      songList.splice(sIndex, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">const</span> pIndex = findIndex(playList, song);</span><br><span class="line">      playList.splice(pIndex, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 判断当前索引是否需要改变</span></span><br><span class="line">      <span class="keyword">if</span> (currentIndex &gt; pIndex || currentIndex === playList.length) &#123;</span><br><span class="line">          currentIndex--;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 重新赋值</span></span><br><span class="line">      <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList &#125;));</span><br><span class="line">      <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList &#125;));</span><br><span class="line">      <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex &#125;));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>当选中当前歌曲后，面板便会将当前歌曲发送给父组件，父组件通过回调，先寻找当前歌曲在播放列表和歌曲列表中寻找其索引，然后删掉。再删掉之后便会有一个索引值改变的情况： <strong>当删除的歌曲的索引小于当前播放歌曲的索引以及删除最后一首歌的时候便会更新当前歌曲索引减一</strong></p>
<hr>
<h2 id="清空列表"><a href="#清空列表" class="headerlink" title="清空列表"></a>清空列表</h2><p>清空列表操作动作比较大，借助nz模态框做一个再次确认的动作<br><img data-src="https://img-blog.csdnimg.cn/20210104141514247.png"></p>
<ul>
<li><p>wy-player-panel.componet.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clear-all&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon trush&quot;</span> <span class="attr">title</span>=<span class="string">&quot;清除全部&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onClearSong.emit()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>清除全部</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player-panel.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Output</span>() onClearSong = <span class="keyword">new</span> EventEmitter&lt;<span class="built_in">void</span>&gt;()  <span class="comment">// 清空歌曲列表</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 播放面板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-wy-player-panel</span> </span></span><br><span class="line"><span class="tag">	(<span class="attr">onClearSong</span>)=<span class="string">&quot;onClearSong()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-wy-player-panel</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> nzModalServer: NzModalService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空歌曲</span></span><br><span class="line">   onClearSong () &#123;</span><br><span class="line">       <span class="built_in">this</span>.nzModalServer.confirm(&#123;</span><br><span class="line">           nzTitle: <span class="string">&quot;确认清空列表？&quot;</span>,</span><br><span class="line">           nzOnOk: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList: [] &#125;));</span><br><span class="line">               <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList: [] &#125;));</span><br><span class="line">               <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex: <span class="number">-1</span> &#125;));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img data-src="https://img-blog.csdnimg.cn/2021010414241327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>目前的代码中有很多重复的提交项，可以提取成单独的类，可优化的空间还是很大的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/e1e87ab0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/e1e87ab0/" class="post-title-link" itemprop="url">【Angular网易云】--16、歌词滚动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-10 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-10T17:23:38+08:00">2020-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="歌词滚动"><a href="#歌词滚动" class="headerlink" title="歌词滚动"></a>歌词滚动</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在获取到歌词并渲染到面板之后，就要实现歌词和歌曲相对应，在实现歌词的高亮的同时还要实现歌词的滚动状态。</p>
<blockquote>
<ul>
<li>监听当前歌曲的值变化的时候就要实现歌词的变化</li>
<li>拿到歌词之后通过歌词前面的时间戳来判断当前应该显示哪一条歌词</li>
<li>在显示的歌词上加上高亮的效果</li>
</ul>
</blockquote>
<ul>
<li>wy-player-panel.component.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Input</span>() playing: <span class="built_in">boolean</span>; <span class="comment">// 歌曲播放状态</span></span><br><span class="line">   <span class="meta">@ViewChildren</span>(WyScrollComponent) <span class="keyword">private</span> wyScroll: QueryList&lt;WyScrollComponent&gt;  <span class="comment">// 滚动条</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> startLine = <span class="number">2</span>; <span class="comment">// 需要滚动的行数</span></span><br><span class="line"></span><br><span class="line">   currentLyric: BaseLyricLine[]; <span class="comment">// 当前歌词</span></span><br><span class="line">   currentLineNum: <span class="built_in">number</span>; <span class="comment">// 当前歌词行数</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> lyric: WyLyric; <span class="comment">// 更改的歌词</span></span><br><span class="line">   <span class="keyword">private</span> lyricRefs: NodeList; <span class="comment">// 歌词节点集合</span></span><br><span class="line">   <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">       <span class="keyword">private</span> songServe: SongService,</span></span><br><span class="line"><span class="params">   </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 数据监听</span></span><br><span class="line">   ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">       <span class="comment">// 根据播放状态监听歌词变化</span></span><br><span class="line">       <span class="keyword">if</span> (changes.playing) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!changes.playing.firstChange) &#123;</span><br><span class="line">               <span class="built_in">this</span>.lyric &amp;&amp; <span class="built_in">this</span>.lyric.togglePlay(<span class="built_in">this</span>.playing);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 监听当前歌曲变化</span></span><br><span class="line">       <span class="keyword">if</span> (changes.currentSong) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">               <span class="built_in">this</span>.currentIndex = findIndex(<span class="built_in">this</span>.songList, <span class="built_in">this</span>.currentSong);</span><br><span class="line">               <span class="built_in">this</span>.updateLyric();</span><br><span class="line">               <span class="keyword">if</span> (<span class="built_in">this</span>.show) &#123;</span><br><span class="line">                   <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">this</span>.resetLyric();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 监听面板显隐</span></span><br><span class="line">       <span class="keyword">if</span> (changes.show) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!changes.show.firstChange &amp;&amp; <span class="built_in">this</span>.show) &#123;</span><br><span class="line">               <span class="built_in">this</span>.wyScroll.first.refreshScroll()</span><br><span class="line">               <span class="built_in">this</span>.wyScroll.last.refreshScroll()</span><br><span class="line">               timer(<span class="number">80</span>).subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">                       <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 更新歌词</span></span><br><span class="line">   <span class="keyword">private</span> updateLyric () &#123;</span><br><span class="line">       <span class="built_in">this</span>.resetLyric();</span><br><span class="line">       <span class="built_in">this</span>.songServe.getLyric(<span class="built_in">this</span>.currentSong.id).subscribe(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.lyric = <span class="keyword">new</span> WyLyric(res);</span><br><span class="line">           <span class="built_in">this</span>.currentLyric = <span class="built_in">this</span>.lyric.lines;</span><br><span class="line">           <span class="built_in">this</span>.startLine = res.tlyric ? <span class="number">1</span> : <span class="number">3</span>;</span><br><span class="line">           <span class="built_in">this</span>.handlerLyric();</span><br><span class="line">           <span class="comment">// 歌词重置到顶部</span></span><br><span class="line">           <span class="built_in">this</span>.wyScroll.last.scrollTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.playing) &#123;</span><br><span class="line">               <span class="built_in">this</span>.lyric.play();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 滚动歌词</span></span><br><span class="line">   <span class="keyword">private</span> handlerLyric () &#123;</span><br><span class="line">       <span class="built_in">this</span>.lyric.handler.subscribe(<span class="function">(<span class="params">&#123; lineNum &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">this</span>.lyricRefs) &#123;</span><br><span class="line">               <span class="built_in">this</span>.lyricRefs = <span class="built_in">this</span>.wyScroll.last.el.nativeElement.querySelectorAll(<span class="string">&#x27;ul li&#x27;</span>)</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&#x27;li&#x27;</span>, <span class="built_in">this</span>.lyricRefs)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.lyricRefs.length) &#123;</span><br><span class="line">               <span class="built_in">this</span>.currentLineNum = lineNum;</span><br><span class="line">               <span class="keyword">if</span> (lineNum &gt; <span class="built_in">this</span>.startLine) &#123;</span><br><span class="line">                   <span class="keyword">const</span> targetLine = <span class="built_in">this</span>.lyricRefs[lineNum - <span class="built_in">this</span>.startLine];</span><br><span class="line">                   <span class="keyword">if</span> (targetLine) &#123;</span><br><span class="line">                       <span class="built_in">this</span>.wyScroll.last.scrollToElement(targetLine, <span class="number">300</span>, <span class="literal">false</span>, <span class="literal">false</span>)</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="built_in">this</span>.wyScroll.last.scrollTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 重置歌词</span></span><br><span class="line">   <span class="keyword">private</span> resetLyric () &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.lyric) &#123;</span><br><span class="line">           <span class="built_in">this</span>.lyric.stop();</span><br><span class="line">           <span class="built_in">this</span>.lyric = <span class="literal">null</span>;</span><br><span class="line">           <span class="built_in">this</span>.currentLyric = [];</span><br><span class="line">           <span class="built_in">this</span>.currentLineNum = <span class="number">0</span>;</span><br><span class="line">           <span class="built_in">this</span>.lyricRefs = <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 移动滚动条</span></span><br><span class="line">   <span class="keyword">private</span> scrollToCurrent () &#123;</span><br><span class="line">       <span class="keyword">const</span> songListRefs = <span class="built_in">this</span>.wyScroll.first.el.nativeElement.querySelectorAll(<span class="string">&#x27;ul li&#x27;</span>);</span><br><span class="line">       <span class="keyword">if</span> (songListRefs.length) &#123;</span><br><span class="line">           <span class="keyword">const</span> currentLi = songListRefs[<span class="built_in">this</span>.currentIndex || <span class="number">0</span>] <span class="keyword">as</span> HTMLElement;</span><br><span class="line">           <span class="keyword">const</span> offsetTop = currentLi.offsetTop;</span><br><span class="line">           <span class="keyword">const</span> offsetHeight = currentLi.offsetHeight;</span><br><span class="line">           <span class="keyword">if</span> (offsetTop - <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.scrollY) &gt; offsetHeight * <span class="number">5</span> || offsetTop &lt; <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.scrollY)) &#123;</span><br><span class="line">               <span class="built_in">this</span>.wyScroll.first.scrollToElement(currentLi, <span class="number">300</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>当数据监听到当前歌曲有变化时，会通过api查找到当前歌曲的歌词，通过实例化wy-lyric类得到包含原译文和时间的数组数据。</p>
<ul>
<li>wy-lyric.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> BaseLyricLine &#123;</span><br><span class="line">    txt: <span class="built_in">string</span>;</span><br><span class="line">    txtCn: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> LyricLine <span class="keyword">extends</span> BaseLyricLine &#123;</span><br><span class="line">    time: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> Handler <span class="keyword">extends</span> BaseLyricLine &#123;</span><br><span class="line">    lineNum: <span class="built_in">number</span> <span class="comment">// 当前歌词索引</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> timeExp = <span class="regexp">/\[(\d&#123;1,2&#125;):(\d&#123;2&#125;)(?:\.(\d&#123;2,3&#125;))?\]/</span>; <span class="comment">//正值-匹配 [00:34.910] 类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> playing = <span class="literal">false</span>; <span class="comment">// 播放状态</span></span><br><span class="line">    <span class="keyword">private</span> curNum: <span class="built_in">number</span>; <span class="comment">// 当前第几行歌词</span></span><br><span class="line">    <span class="keyword">private</span> startStamp: <span class="built_in">number</span>; <span class="comment">// 歌词时间戳</span></span><br><span class="line">    <span class="keyword">private</span> pauseStamp: <span class="built_in">number</span>; <span class="comment">// 歌曲暂停时的时间戳</span></span><br><span class="line">    <span class="keyword">private</span> timer: <span class="built_in">any</span>;</span><br><span class="line">    handler = <span class="keyword">new</span> Subject&lt;Handler&gt;();</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 歌词播放回调</span></span><br><span class="line">   play (startTime = <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">this</span>.lines.length) &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">this</span>.playing) &#123;</span><br><span class="line">           <span class="built_in">this</span>.playing = <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">this</span>.curNum = <span class="built_in">this</span>.findCurNum(startTime);</span><br><span class="line">       <span class="built_in">this</span>.startStamp = <span class="built_in">Date</span>.now() - startTime;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.curNum &lt; <span class="built_in">this</span>.lines.length) &#123;</span><br><span class="line">           <span class="built_in">clearTimeout</span>(<span class="built_in">this</span>.timer);</span><br><span class="line">           <span class="built_in">this</span>.playReset();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 持续播放歌词</span></span><br><span class="line">   <span class="keyword">private</span> playReset () &#123;</span><br><span class="line">       <span class="keyword">let</span> line = <span class="built_in">this</span>.lines[<span class="built_in">this</span>.curNum];</span><br><span class="line">       <span class="keyword">const</span> delay = line.time - (<span class="built_in">Date</span>.now() - <span class="built_in">this</span>.startStamp);</span><br><span class="line">       <span class="comment">// const temp = this.lines[this.curNum + 1].time - this.lines[this.curNum].time;</span></span><br><span class="line">       <span class="comment">// console.log(&#x27;delay&#x27;, temp);</span></span><br><span class="line">       <span class="built_in">this</span>.timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.callHandler(<span class="built_in">this</span>.curNum++);</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.curNum &lt; <span class="built_in">this</span>.lines.length &amp;&amp; <span class="built_in">this</span>.playing) &#123;</span><br><span class="line">               <span class="built_in">this</span>.playReset();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, delay)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 发送当前歌词</span></span><br><span class="line">   <span class="keyword">private</span> callHandler (i: <span class="built_in">number</span>) &#123;</span><br><span class="line">       <span class="built_in">this</span>.handler.next(&#123;</span><br><span class="line">           txt: <span class="built_in">this</span>.lines[i].txt,</span><br><span class="line">           txtCn: <span class="built_in">this</span>.lines[i].txtCn,</span><br><span class="line">           lineNum: i,</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 根据时间戳查找当亲歌词所在行数</span></span><br><span class="line">   <span class="keyword">private</span> findCurNum (time: <span class="built_in">number</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> index = <span class="built_in">this</span>.lines.findIndex(<span class="function"><span class="params">item</span> =&gt;</span> time &lt;= item.time);</span><br><span class="line">       <span class="keyword">return</span> index === <span class="number">-1</span> ? <span class="built_in">this</span>.lines.length - <span class="number">1</span> : index;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 歌词播放</span></span><br><span class="line">   togglePlay (playing: <span class="built_in">boolean</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">       <span class="built_in">this</span>.playing = playing;</span><br><span class="line">       <span class="keyword">if</span> (playing) &#123;</span><br><span class="line">           <span class="keyword">const</span> startTime = (<span class="built_in">this</span>.pauseStamp || now) - (<span class="built_in">this</span>.startStamp || now)</span><br><span class="line">           <span class="built_in">this</span>.play(startTime);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.stop();</span><br><span class="line">           <span class="built_in">this</span>.pauseStamp = now;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 暂停</span></span><br><span class="line">   stop () &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.playing) &#123;</span><br><span class="line">           <span class="built_in">this</span>.playing = <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">clearTimeout</span>(<span class="built_in">this</span>.timer);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>父组件在获取歌词后就要将当前相对应的歌词部分通过插件滚动到合适的地方，所以通过subject多播的方式拿到当前歌词节点并通过scrollToElement滚动。</p>
<p>在处理歌词停留时间处，也可以用当前行+1歌词的时间减去当前行歌词的时间来获取停留的时间戳。</p>
<h2 id="拖拽"><a href="#拖拽" class="headerlink" title="拖拽"></a>拖拽</h2><p>点击进度条时也要实现定位到当前歌词。在点击进度条时拿到点击的时间戳，通过面板组件，将新的时间传给歌词子组件，然后重新寻找当前时间所在的歌词行数。</p>
<ul>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@ViewChild</span>(WyPlayerPanelComponent, &#123; <span class="keyword">static</span>: <span class="literal">false</span> &#125;) <span class="keyword">private</span> playPanel: WyPlayerPanelComponent;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 滑动播放条</span></span><br><span class="line"> onPercentChange (e: <span class="built_in">number</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">         <span class="keyword">const</span> currentTime = <span class="built_in">this</span>.duration * (e / <span class="number">100</span>);</span><br><span class="line">         <span class="built_in">this</span>.audioEl.currentTime = currentTime;</span><br><span class="line">         <span class="keyword">if</span> (<span class="built_in">this</span>.playPanel) &#123;</span><br><span class="line">             <span class="built_in">this</span>.playPanel.seekLyric(currentTime * <span class="number">1000</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// 单曲循环</span></span><br><span class="line"> <span class="keyword">private</span> loop () &#123;</span><br><span class="line">     <span class="built_in">this</span>.audioEl.currentTime = <span class="number">0</span>;</span><br><span class="line">     <span class="built_in">this</span>.play()</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.playPanel) &#123;</span><br><span class="line">         <span class="built_in">this</span>.playPanel.seekLyric(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player-panel.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">seekLyric (time: <span class="built_in">number</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.lyric) &#123;</span><br><span class="line">          <span class="built_in">this</span>.lyric.seek(time);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-lyric.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 歌词播放</span></span><br><span class="line"> play (startTime = <span class="number">0</span>, skip = <span class="literal">false</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">this</span>.lines.length) &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">this</span>.playing) &#123;</span><br><span class="line">         <span class="built_in">this</span>.playing = <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="built_in">this</span>.curNum = <span class="built_in">this</span>.findCurNum(startTime);</span><br><span class="line">     <span class="built_in">this</span>.startStamp = <span class="built_in">Date</span>.now() - startTime;</span><br><span class="line">     <span class="keyword">if</span> (!skip) &#123;</span><br><span class="line">         <span class="built_in">this</span>.callHandler(<span class="built_in">this</span>.curNum - <span class="number">1</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.curNum &lt; <span class="built_in">this</span>.lines.length) &#123;</span><br><span class="line">         <span class="built_in">clearTimeout</span>(<span class="built_in">this</span>.timer);</span><br><span class="line">         <span class="built_in">this</span>.playReset();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">seek (time: <span class="built_in">number</span>) &#123;</span><br><span class="line">     <span class="built_in">this</span>.play(time);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>同时在单曲模式下也要对歌词重置为起始位置。</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这里的逻辑有些绕，关于组件间传值仍然不是很熟练，还有angular的一些依赖项都也是不明白其含义，导致使用的时候不知道具体怎么用。这些视频一遍一遍的看，资料也是一点点的查，也崩溃过几次，压力之下总是能收货一些的，撑下去！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/8f3a274f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/8f3a274f/" class="post-title-link" itemprop="url">【你不知道的JS--上】——1、作用域</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-08 10:53:40" itemprop="dateCreated datePublished" datetime="2020-12-08T10:53:40+08:00">2020-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-09 14:33:34" itemprop="dateModified" datetime="2020-12-09T14:33:34+08:00">2020-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JS%E5%B0%8F%E9%BB%84%E4%B9%A6/" itemprop="url" rel="index"><span itemprop="name">JS小黄书</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>648</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><font color=#999AAA >
这个分栏用于记录最近在看的《你不知道的JavaScript》系列的笔记内容，更接近于理论篇，所以为了加深记忆，会摘抄书上我认为重要的部分，也会尽可能的用自己的理解去重载内容
</font>

<hr>
<h1 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h1><h2 id="分词-词法分析（Tokenizing-Lexing）"><a href="#分词-词法分析（Tokenizing-Lexing）" class="headerlink" title="分词/词法分析（Tokenizing/Lexing）"></a>分词/词法分析（Tokenizing/Lexing）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">   字符串 --&gt; 代码块: 分解</span><br><span class="line">   代码块 --&gt; 词法单元: 解析</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/8f3a274f/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/6efe822a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/6efe822a/" class="post-title-link" itemprop="url">【Angular网易云】--15、歌词渲染</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-07 17:23:38" itemprop="dateCreated datePublished" datetime="2020-12-07T17:23:38+08:00">2020-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="歌词"><a href="#歌词" class="headerlink" title="歌词"></a>歌词</h1><h2 id="歌词初始化"><a href="#歌词初始化" class="headerlink" title="歌词初始化"></a>歌词初始化</h2><p>播放面板左侧展示歌单歌曲，右侧展示当前歌曲歌词，并且实现和左侧相通的滚动条。因此要根据ID获取当前歌曲歌词。<br><img data-src="https://img-blog.csdnimg.cn/20201221221351484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="歌词API"></p>
<ul>
<li>song.service.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据ID获取歌曲歌词</span></span><br><span class="line"> getLyric (id: <span class="built_in">number</span>): Observable&lt;Lyric&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;id&#x27;</span>, id.toString());</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.uri + <span class="string">&#x27;lyric&#x27;</span>, &#123; params &#125;)</span><br><span class="line">         .pipe(map((res: &#123;</span><br><span class="line">             [key: <span class="built_in">string</span>]: &#123; lyric: <span class="built_in">string</span>; &#125;</span><br><span class="line">         &#125;) =&gt; &#123;</span><br><span class="line">             <span class="keyword">return</span> &#123;</span><br><span class="line">                 lyric: res.lrc.lyric,</span><br><span class="line">                 tlyric: res.tlyric.lyric,</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>common.types.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 歌词</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Lyric = &#123;</span><br><span class="line">    lyric: <span class="built_in">string</span>, <span class="comment">// 原文</span></span><br><span class="line">    tlyric: <span class="built_in">string</span> <span class="comment">// 译文</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
根据api获取当前歌曲需要的部分，并且在common.types.ts中声明Lyric类型，将返回值res处理成需要的键值对格式。</li>
</ul>
<h2 id="处理歌词"><a href="#处理歌词" class="headerlink" title="处理歌词"></a>处理歌词</h2><h3 id="单语歌词"><a href="#单语歌词" class="headerlink" title="单语歌词"></a>单语歌词</h3><p>当监听当前歌曲值发生变化时，不仅要重新获取当前歌曲索引还有获取当前歌曲歌词。</p>
<ul>
<li>wy-player-panel.component.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  currentLyric: BaseLyricLine[]; <span class="comment">// 歌词</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据监听</span></span><br><span class="line">  ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">      <span class="comment">// 监听当前歌曲变化</span></span><br><span class="line">      <span class="keyword">if</span> (changes[<span class="string">&#x27;currentSong&#x27;</span>]) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">              <span class="built_in">this</span>.currentIndex = findIndex(<span class="built_in">this</span>.songList, <span class="built_in">this</span>.currentSong);</span><br><span class="line">              <span class="built_in">this</span>.updateLyric();</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.show) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; </span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据ID获取歌词</span></span><br><span class="line">  <span class="keyword">private</span> updateLyric () &#123;</span><br><span class="line">      <span class="built_in">this</span>.songServe.getLyric(<span class="built_in">this</span>.currentSong.id).subscribe(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> lyric = <span class="keyword">new</span> WyLyric(res);</span><br><span class="line">          <span class="built_in">this</span>.currentLyric = lyric.lines;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li>wy-lyric.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Lyric &#125; <span class="keyword">from</span> <span class="string">&quot;src/app/services/data-types/common.types&quot;</span>;</span><br><span class="line"><span class="comment">// 歌词基类</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> BaseLyricLine &#123;</span><br><span class="line">    txt: <span class="built_in">string</span>;</span><br><span class="line">    txtCn: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 歌词派生类</span></span><br><span class="line"><span class="keyword">interface</span> LyricLine <span class="keyword">extends</span> BaseLyricLine &#123;</span><br><span class="line">    time: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeExp = <span class="regexp">/\[(\d&#123;2&#125;):(\d&#123;2&#125;)\.(\d&#123;2,3&#125;)\]/</span>;  <span class="comment">//正值-匹配 [00:34.910] 类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> WyLyric &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> lrc: Lyric; <span class="comment">// 暂存传来的歌词</span></span><br><span class="line">    lines: LyricLine[] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params">lrc: Lyric</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.lrc = lrc;</span><br><span class="line">        <span class="built_in">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> init () &#123;</span><br><span class="line">        <span class="comment">// 判断是否是外语歌曲</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lrc.tlyric) &#123;</span><br><span class="line">            <span class="built_in">this</span>.generTLyric();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.generLyric();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析单语歌词</span></span><br><span class="line">    <span class="keyword">private</span> generLyric () &#123;</span><br><span class="line">        <span class="keyword">const</span> lines = <span class="built_in">this</span>.lrc.lyric.split(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        lines.forEach(<span class="function"><span class="params">line</span> =&gt;</span> <span class="built_in">this</span>.makeLine(line))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析双语歌词</span></span><br><span class="line">    <span class="keyword">private</span> generTLyric () &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理单行歌词</span></span><br><span class="line">    <span class="keyword">private</span> makeLine (line: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = timeExp.exec(line);</span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="keyword">const</span> txt = line.replace(timeExp, <span class="string">&#x27;&#x27;</span>).trim();</span><br><span class="line">            <span class="keyword">const</span> txtCn = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (txt) &#123;</span><br><span class="line">                <span class="keyword">const</span> thirdResult = result[<span class="number">3</span>] || <span class="string">&#x27;00&#x27;</span>;</span><br><span class="line">                <span class="keyword">const</span> len = thirdResult.length;</span><br><span class="line">                <span class="keyword">const</span> _thirdResult = len &gt; <span class="number">2</span> ? <span class="built_in">parseInt</span>(thirdResult) : <span class="built_in">parseInt</span>(thirdResult) * <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">const</span> time = <span class="built_in">Number</span>(result[<span class="number">1</span>]) * <span class="number">60</span> * <span class="number">1000</span> + <span class="built_in">Number</span>(result[<span class="number">2</span>]) * <span class="number">60</span> + _thirdResult;</span><br><span class="line">                <span class="built_in">this</span>.lines.push(&#123; txt, txtCn, time &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
当实例化歌词类的时候先暂存传来的歌词，然后判断当前歌词是否是双语，当仅为单语时会将歌词中string类型的原文转为数组，因为每一行歌词前都会有时间提示，所以要通过makeLine方法单独处理每一行。<br><img data-src="https://img-blog.csdnimg.cn/20201221223504617.png"><br>在处理单行歌词时使用了正则表达式来匹配字符串格式的参数。</li>
</ul>
<blockquote>
<p>RegExpObject.exec(string)<br>返回一个数组，其中存放匹配的结果。如果未找到匹配，则返回值为 null。</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">string</td>
<td align="center">必需。要检索的字符串。</td>
</tr>
</tbody></table>
<blockquote>
<p>如果 exec() 找到了匹配的文本，则返回一个结果数组。否则，返回 null。此数组的第 0 个元素是与正则表达式相匹配的文本，第 1 个元素是与 RegExpObject 的第 1 个子表达式相匹配的文本（如果有的话），第 2 个元素是与 RegExpObject 的第 2 个子表达式相匹配的文本（如果有的话），以此类推。除了数组元素和 length 属性之外，exec() 方法还返回两个属性。index 属性声明的是匹配文本的第一个字符的位置。input 属性则存放的是被检索的字符串 string。我们可以看得出，在调用非全局的 RegExp 对象的 exec() 方法时，返回的数组与调用方法 String.match() 返回的数组是相同的。</p>
</blockquote>
<p>在单行歌词中匹配”[分钟:秒.毫秒]”类型的字符串<br><img data-src="https://img-blog.csdnimg.cn/20201221225451752.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"><br>如果能匹配到，就在当前单行歌词中将匹配到的字符串置空并去空格，这样就能拿到实际渲染的歌词了。而在时间上是将分钟，秒转换为毫秒并存下来。</p>
<ul>
<li>wy-player-panel.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 歌词列表 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">app-wy-scroll</span> <span class="attr">class</span>=<span class="string">&quot; list-lyric&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let line of currentLyric&quot;</span>&gt;</span></span><br><span class="line">                   &#123;&#123;line.txt&#125;&#125; </span><br><span class="line">                   <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                   &#123;&#123;line?.txtCn&#125;&#125;   </span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">app-wy-scroll</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img data-src="https://img-blog.csdnimg.cn/20201221225815556.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></li>
</ul>
<hr>
<h3 id="双语歌词"><a href="#双语歌词" class="headerlink" title="双语歌词"></a>双语歌词</h3><p>在拿到国外歌曲的歌词时，会有翻译的文本，这时候就要将原文和译文一句句的对应起来。在WyLyric类中通过对传送进来的歌词类判断，来决定歌词处理的通道是走单语还是双语。</p>
<ul>
<li>wy-lyriv.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析双语歌词</span></span><br><span class="line">   <span class="keyword">private</span> generTLyric () &#123;</span><br><span class="line">   	<span class="comment">// 获取原文数组</span></span><br><span class="line">       <span class="keyword">const</span> lines = <span class="built_in">this</span>.lrc.lyric.split(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">       <span class="comment">// 获取译文数组</span></span><br><span class="line">       <span class="keyword">const</span> tLines = <span class="built_in">this</span>.lrc.tlyric.split(<span class="string">&#x27;\n&#x27;</span>).filter(<span class="function"><span class="params">item</span> =&gt;</span> timeExp.exec(item) != <span class="literal">null</span>);</span><br><span class="line">       <span class="comment">// 判断原文与译文的长度关系</span></span><br><span class="line">       <span class="keyword">const</span> moreLine = lines.length - tLines.length;</span><br><span class="line">       <span class="keyword">let</span> tempArr = [];</span><br><span class="line">       <span class="keyword">if</span> (moreLine &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">           tempArr = [lines, tLines];</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           tempArr = [tLines, lines];</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">// 获取短的歌词数组中的第一个时间部分</span></span><br><span class="line">       <span class="keyword">const</span> first = timeExp.exec(tempArr[<span class="number">1</span>][<span class="number">0</span>])[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">// 获取长的歌词数组需要跳过的索引</span></span><br><span class="line">       <span class="keyword">const</span> skipIndex = tempArr[<span class="number">0</span>].findIndex(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">const</span> exec = timeExp.exec(item);</span><br><span class="line">           <span class="keyword">if</span> (exec) &#123;</span><br><span class="line">               <span class="keyword">return</span> exec[<span class="number">0</span>] === first;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">	</span><br><span class="line">       <span class="keyword">const</span> _skip = skipIndex === <span class="number">-1</span> ? <span class="number">0</span> : skipIndex;</span><br><span class="line">       <span class="keyword">const</span> skipItems = tempArr[<span class="number">0</span>].slice(<span class="number">0</span>, _skip);</span><br><span class="line">       <span class="keyword">if</span> (skipItems.length) &#123;</span><br><span class="line">           skipItems.forEach(<span class="function"><span class="params">line</span> =&gt;</span> <span class="built_in">this</span>.makeLine(line));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> zipLines$;</span><br><span class="line">       <span class="keyword">if</span> (moreLine &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           zipLines$ = zip(<span class="keyword">from</span>(lines).pipe(skip(_skip)), <span class="keyword">from</span>(tLines));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           zipLines$ = zip(<span class="keyword">from</span>(lines), <span class="keyword">from</span>(tLines).pipe(skip(_skip)));</span><br><span class="line">       &#125;</span><br><span class="line">       zipLines$.subscribe(<span class="function">(<span class="params">[line, tLine]</span>) =&gt;</span> <span class="built_in">this</span>.makeLine(line, tLine))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 处理单行歌词</span></span><br><span class="line">   <span class="keyword">private</span> makeLine (line: <span class="built_in">string</span>, tLine = <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> result = timeExp.exec(line);</span><br><span class="line">       <span class="keyword">if</span> (result) &#123;</span><br><span class="line">           <span class="keyword">const</span> txt = line.replace(timeExp, <span class="string">&#x27;&#x27;</span>).trim();</span><br><span class="line">           <span class="keyword">const</span> txtCn = tLine ? tLine.replace(timeExp, <span class="string">&#x27;&#x27;</span>).trim() : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">           <span class="keyword">if</span> (txt) &#123;</span><br><span class="line">               <span class="keyword">const</span> thirdResult = result[<span class="number">3</span>] || <span class="string">&#x27;00&#x27;</span>;</span><br><span class="line">               <span class="keyword">const</span> len = thirdResult.length;</span><br><span class="line">               <span class="keyword">const</span> _thirdResult = len &gt; <span class="number">2</span> ? <span class="built_in">parseInt</span>(thirdResult) : <span class="built_in">parseInt</span>(thirdResult) * <span class="number">10</span>;</span><br><span class="line">               <span class="keyword">const</span> time = <span class="built_in">Number</span>(result[<span class="number">1</span>]) * <span class="number">60</span> * <span class="number">1000</span> + <span class="built_in">Number</span>(result[<span class="number">2</span>]) * <span class="number">60</span> + _thirdResult;</span><br><span class="line">               <span class="built_in">this</span>.lines.push(&#123; txt, txtCn, time &#125;)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
在通过获取双语歌词回调中，声明局部变量lines和tLines来保存传递过来的歌词的原文和译文部分，api数据中观察到原文和译文可能不对应，因此译文部分要经过一个空值筛选。因为二者不一 一对应，但是在渲染的时候要达到一句原文一句译文，所以需要判断。为了方便取值，声明一个装有原文译文数组的数组，当原文的长度大于等于译文，将原文放在索引0，反之放在索引1。<blockquote>
<p>原文和译文长度可能不同，原文中可能含有一些版权声明和作词作曲介绍，这时候译文可能没有翻译，所以长度不同，这时的逻辑就是一是要全部显示原文歌词，但是还要将原文译文相对应。</p>
</blockquote>
</li>
</ul>
<p>此时用正则获取短的歌词数组中第一条数据的时间部分，然后用findIndex在长的歌词数组中寻找该时间部分等于短的歌词数组中的一条的时间部分，拿到索引。</p>
<blockquote>
<p>findIndex()</p>
<ul>
<li>返回传入一个测试条件（函数）符合条件的数组第一个元素位置。</li>
<li>为数组中的每个元素都调用一次函数执行：当数组中的元素在测试条件时返回 true 时, 返回符合条件的元素的索引位置，之后的值不会再调用执行函数。<strong>如果没有符合条件的元素返回 -1</strong></li>
</ul>
<p><strong>注意: findIndex() 对于空数组，函数是不会执行的。其并没有改变数组的原始值。</strong> </p>
</blockquote>
<p>所以此时要将返回-1的时候转为0，即原文和译文长度相等，此时不用截取任何数据。截取数据不为空时，在将截取的数据单独提前push到渲染的歌词中。之后便是要处理一一对应的歌词了。</p>
<p>此时判断原文和译文的长度关系，如果原文长，就将原文跳过获取的索引，然后通过zip()来得到一个 <strong>[ 原文， 译文 ]observable类型的数组</strong>。译文长就将译文跳过获取的索引。然后在将得到的数据订阅处理单行歌词的回调。<strong>此时要将之前写死的单条译文写一个判断</strong></p>
<p><img data-src="https://img-blog.csdnimg.cn/20210101222126661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>其中使用了正则表达式，很显然是一块短板，而且在使用zip()时提示方法不再支持，而是建议使用map来操作，目前为了理解没有修改，后续来调整这一方面！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/2ac17ac2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2ac17ac2/" class="post-title-link" itemprop="url">【Angular网易云】--14、底部信息与功能（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-06 10:23:38" itemprop="dateCreated datePublished" datetime="2020-12-06T10:23:38+08:00">2020-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="播放面板"><a href="#播放面板" class="headerlink" title="播放面板"></a>播放面板</h1><p>底部除了播放歌曲时的显示信息，还要显示当前的播放列表，对于播放列表选择提取成单独的子组件，这也涉及到父子组件的通信。</p>
<hr>
<h2 id="歌曲列表"><a href="#歌曲列表" class="headerlink" title="歌曲列表"></a>歌曲列表</h2><ul>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--歌曲面板图标--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;open&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;toggleListPanel()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 播放面板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-wy-player-panel</span> </span></span><br><span class="line"><span class="tag">  [<span class="attr">songList</span>]=<span class="string">&quot;songList&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">currentSong</span>]=<span class="string">&quot;currentSong&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">currentIndex</span>]=<span class="string">&quot;currentIndex&quot;</span> </span></span><br><span class="line"><span class="tag">  [<span class="attr">show</span>]=<span class="string">&quot;showPanel&quot;</span></span></span><br><span class="line"><span class="tag">  (<span class="attr">onClose</span>)=<span class="string">&quot;showPanel = false&quot;</span></span></span><br><span class="line"><span class="tag">  (<span class="attr">onChangeSong</span>)=<span class="string">&quot;onChangeSong($event)&quot;</span></span></span><br><span class="line"><span class="tag"> &gt;</span><span class="tag">&lt;/<span class="name">app-wy-player-panel</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当打开该面板的时候，左侧需要显示当前的歌曲列表以及当前的歌曲，所以会像子组件传songList 与 currentSong，而在当前歌曲前要显示小图标，所以将当前歌曲的索引也传给子组件。</p>
</li>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">  songList: Song[]; <span class="comment">// 歌曲列表</span></span><br><span class="line">  currentIndex: <span class="built_in">number</span>; <span class="comment">// 当前歌曲下标</span></span><br><span class="line">  currentSong: Song; <span class="comment">// 当前歌曲</span></span><br><span class="line">  showVolumePanel = <span class="literal">false</span>; <span class="comment">// 是否显示音量面板</span></span><br><span class="line">  showPanel = <span class="literal">false</span>; <span class="comment">// 是否显示列表面板</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制音量面板</span></span><br><span class="line">  toggleVolPanel () &#123;</span><br><span class="line">      <span class="built_in">this</span>.togglePanel(<span class="string">&#x27;showVolumePanel&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制列表面板</span></span><br><span class="line">  toggleListPanel () &#123;</span><br><span class="line">      <span class="built_in">this</span>.togglePanel(<span class="string">&#x27;showPanel&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 面板回调</span></span><br><span class="line">  togglePanel (<span class="keyword">type</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>[<span class="keyword">type</span>] = !<span class="built_in">this</span>[<span class="keyword">type</span>];</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.showVolumePanel || <span class="built_in">this</span>.showPanel) &#123;</span><br><span class="line">          <span class="built_in">this</span>.bindDocumentClickListener();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.unbindDocumentClickListener();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 绑定音量事件</span></span><br><span class="line">  <span class="keyword">private</span> bindDocumentClickListener () &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;win&#x27;</span>, <span class="built_in">this</span>.winClick);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.winClick) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;self&#x27;</span>, <span class="built_in">this</span>.selfClick);</span><br><span class="line">          <span class="built_in">this</span>.winClick = fromEvent(<span class="built_in">this</span>.doc, <span class="string">&#x27;click&#x27;</span>).subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (!<span class="built_in">this</span>.selfClick) &#123; <span class="comment">// 说明点击了播放器以外的地方</span></span><br><span class="line">                  <span class="built_in">console</span>.log(<span class="string">&#x27;self&#x27;</span>, <span class="built_in">this</span>.selfClick);</span><br><span class="line">                  <span class="built_in">this</span>.showVolumePanel = <span class="literal">false</span>;</span><br><span class="line">                  <span class="built_in">this</span>.showPanel = <span class="literal">false</span>;</span><br><span class="line">                  <span class="built_in">this</span>.unbindDocumentClickListener();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="built_in">this</span>.selfClick = <span class="literal">false</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解绑音量事件</span></span><br><span class="line">  <span class="keyword">private</span> unbindDocumentClickListener () &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;win&#x27;</span>, <span class="built_in">this</span>.winClick);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.winClick) &#123;</span><br><span class="line">          <span class="built_in">this</span>.winClick.unsubscribe();</span><br><span class="line">          <span class="built_in">this</span>.winClick = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当点击图标时，触发toggleListPanel（）,此时将会触发回调，将 ‘showPanel’ 传给togglePanel（）回调。回调中根据type的类型来更改面板的显隐。当两个面板其中一个为true时，将会绑定下一次的点击事件，否则解绑事件。</p>
</li>
<li><p>wy-player-panel.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 歌曲列表面板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;play-panel &quot;</span> [<span class="attr">class.show</span>]=<span class="string">&quot;show&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hdc&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h4</span>&gt;</span>播放列表(<span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;songList?.length&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>)<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;add-all&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">title</span>=<span class="string">&quot;收藏全部&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>收藏全部</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;line&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clear-all&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon trush&quot;</span> <span class="attr">title</span>=<span class="string">&quot;清除全部&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>清除全部</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;playing-name&quot;</span>&gt;</span>&#123;&#123;currentSong?.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon close&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onClose.emit()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;msk&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-wrap&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of songList; index as i&quot;</span> [<span class="attr">class.current</span>]=<span class="string">&quot;currentIndex === i&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onChangeSong.emit(item)&quot;</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;col arrow&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col name ellipsis&quot;</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col icons&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico like&quot;</span> <span class="attr">title</span>=<span class="string">&quot;收藏&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico share&quot;</span> <span class="attr">title</span>=<span class="string">&quot;分享&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ico trush&quot;</span> <span class="attr">title</span>=<span class="string">&quot;删除&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;singers clearfix ellipsis&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;singer-item&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let singer of item.ar last as isLast&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span>  <span class="attr">class</span>=<span class="string">&quot;col ellipsis&quot;</span>&gt;</span>&#123;&#123;singer.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> [<span class="attr">hidden</span>]=<span class="string">&quot;isLast&quot;</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col duration&quot;</span>&gt;</span>&#123;&#123;item.dt / 1000 | formatTime&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col link&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>wy-player-panel.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Input</span>() songList: Song[];</span><br><span class="line"><span class="meta">@Input</span>() currentSong: Song;</span><br><span class="line"><span class="meta">@Input</span>() currentIndex: <span class="built_in">number</span>;</span><br><span class="line"><span class="meta">@Input</span>() show: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Output</span>() onClose = <span class="keyword">new</span> EventEmitter</span><br><span class="line"><span class="meta">@Output</span>() onChangeSong = <span class="keyword">new</span> EventEmitter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (changes[<span class="string">&#x27;songList&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;songList&#x27;</span>, <span class="built_in">this</span>.songList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (changes[<span class="string">&#x27;currentSong&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;currentSong&#x27;</span>, <span class="built_in">this</span>.currentSong);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当列表面板开启时，接受父组件传来的歌曲列表songList，当前歌曲currentSong，当前歌曲索引currentIndex。将歌曲列表渲染到DOM中，当点击列表中其他歌曲的时候，将歌曲广播给父组件，父组件接收到后将会更新当前歌曲，实现选择切歌的效果</p>
</li>
<li><p>wy-player.componetn.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改变当前歌曲</span></span><br><span class="line"> onChangeSong (song: Song) &#123;</span><br><span class="line">     <span class="built_in">this</span>.updateCurrentIndex(<span class="built_in">this</span>.playList, song);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="列表滚动"><a href="#列表滚动" class="headerlink" title="列表滚动"></a>列表滚动</h2><p>歌曲渲染之后但无法滑动，歌单内的歌曲也无法全部展示出来，因此需要添加滚动条，此时借助<a target="_blank" rel="noopener" href="https://better-scroll.github.io/docs/zh-CN/guide/">betterScroll</a>插件来实现这个功能。</p>
<blockquote>
<p>BetterScroll 是一款重点解决移动端（已支持 PC）各种滚动场景需求的插件。它的核心是借鉴的 iscroll 的实现，它的 API 设计基本兼容 <a target="_blank" rel="noopener" href="https://github.com/cubiq/iscroll">iscroll</a>，在 iscroll 的基础上又扩展了一些 feature 以及做了一些性能优化。BetterScroll 是使用纯 JavaScript 实现的，这意味着它是无依赖的。</p>
</blockquote>
<p> <img data-src="https://img-blog.csdnimg.cn/20201219160731841.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="核心滚动"></p>
<p>主要步骤是先安装插件，在需要使用的地方导入包，然后声明一下插件即可。 创建新组建wy-scroll增加插件复用性</p>
<ul>
<li>wy-scroll.compoent.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, ChangeDetectionStrategy, Component, ElementRef, Input, OnChanges, SimpleChanges, ViewChild, ViewEncapsulation &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> BScroll <span class="keyword">from</span> <span class="string">&#x27;@better-scroll/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ScrollBar <span class="keyword">from</span> <span class="string">&#x27;@better-scroll/scroll-bar&#x27;</span></span><br><span class="line"><span class="keyword">import</span> MouseWheel <span class="keyword">from</span> <span class="string">&#x27;@better-scroll/mouse-wheel&#x27;</span></span><br><span class="line">BScroll.use(ScrollBar);</span><br><span class="line">BScroll.use(MouseWheel);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">    selector: <span class="string">&#x27;app-wy-scroll&#x27;</span>,</span><br><span class="line">    template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;wy-scroll&quot; #wrap&gt;</span></span><br><span class="line"><span class="string">      &lt;ng-content&gt;&lt;/ng-content&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">    styles: [<span class="string">`.wy-scroll&#123; width: 100%; height: 100%; overflow: hidden &#125;`</span>],</span><br><span class="line">    encapsulation: ViewEncapsulation.None,</span><br><span class="line">    changeDetection: ChangeDetectionStrategy.OnPush</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> WyScrollComponent <span class="keyword">implements</span> AfterViewInit, OnChanges &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Input</span>() refreshDelay = <span class="number">50</span>; <span class="comment">// 刷新插件延迟时间</span></span><br><span class="line">    <span class="meta">@Input</span>() data: <span class="built_in">any</span>[];	<span class="comment">// 父组件传递列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> bs: BScroll; <span class="comment">// 声明插件</span></span><br><span class="line">    <span class="meta">@ViewChild</span>(<span class="string">&#x27;wrap&#x27;</span>, &#123; <span class="keyword">static</span>: <span class="literal">true</span> &#125;) <span class="keyword">private</span> wrapRef: ElementRef</span><br><span class="line"></span><br><span class="line">	<span class="comment">// </span></span><br><span class="line">    ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes[<span class="string">&#x27;data&#x27;</span>]) &#123;</span><br><span class="line">            <span class="built_in">this</span>.refreshScroll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngAfterViewInit (): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bs = <span class="keyword">new</span> BScroll(<span class="built_in">this</span>.wrapRef.nativeElement, &#123;</span><br><span class="line">            <span class="comment">// 滚动条</span></span><br><span class="line">            scrollbar: &#123;</span><br><span class="line">                interactive: <span class="literal">true</span> <span class="comment">// 滚动条可以交互</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 鼠标滚轮</span></span><br><span class="line">            mouseWheel: &#123;</span><br><span class="line">                speed: <span class="number">20</span>, <span class="comment">// 滚轮速度</span></span><br><span class="line">                invert: <span class="literal">false</span>, <span class="comment">// 滚轮方向</span></span><br><span class="line">                easeTime: <span class="number">300</span> <span class="comment">// 动画缓动时长</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 刷新插件回调</span></span><br><span class="line">    <span class="keyword">private</span> refresh () &#123;</span><br><span class="line">        <span class="built_in">this</span>.bs.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 刷新插件</span></span><br><span class="line">    refreshScroll () &#123;</span><br><span class="line">    	<span class="comment">// 设置定时器，等待DOM渲染后执行</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.refresh()</span><br><span class="line">        &#125;, <span class="built_in">this</span>.refreshDelay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
在陆续安装完Scroll（滚动条）和MouseWheel（鼠标滚轮）之后使用use完成引用。按照文档属性设置相应的参数。<br><img data-src="https://img-blog.csdnimg.cn/20201219184251248.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="效果图"></li>
</ul>
<hr>
<p>在实现滚动条之后，要实现切歌时高亮图标能跟着切歌的当前歌曲，在点击上一曲和下一曲的时候能实时切换，并且在播放歌曲的时候，打开歌曲列表面板能够及时滚动到当前歌曲。</p>
<blockquote>
<p>点击上一曲或者下一曲的时候，会改变当前的歌曲，此时在ngOnChanges钩子处监听当前歌曲的变化和歌曲列表面板的显隐变化，如果当前歌曲有变化或者面板变为显示就将滚动条滑向当前歌曲处</p>
</blockquote>
<ul>
<li>wy-player-panel.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">  @Input() songList: Song[]; <span class="comment">// 歌曲列表</span></span><br><span class="line">  @Input() currentSong: Song; <span class="comment">// 当前歌曲</span></span><br><span class="line">  @Input() currentIndex: number; <span class="comment">// 当前歌曲索引</span></span><br><span class="line">  @Input() show: boolean; <span class="comment">// 面板显隐</span></span><br><span class="line"></span><br><span class="line">  @Output() onClose = <span class="keyword">new</span> EventEmitter <span class="comment">// 面板是否关闭</span></span><br><span class="line">  @Output() onChangeSong = <span class="keyword">new</span> EventEmitter  <span class="comment">// 改变当前歌曲为选中的列表歌曲</span></span><br><span class="line"></span><br><span class="line">  @ViewChildren(WyScrollComponent) private wyScroll: QueryList&lt;WyScrollComponent&gt;  <span class="comment">// 滚动条</span></span><br><span class="line"></span><br><span class="line">  scrollY = <span class="number">0</span>;  <span class="comment">// 滚动条Y轴偏移量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据监听</span></span><br><span class="line">  ngOnChanges (changes: SimpleChanges): <span class="keyword">void</span> &#123;</span><br><span class="line">  	 <span class="comment">// 监听歌单列表</span></span><br><span class="line">      <span class="keyword">if</span> (changes[<span class="string">&#x27;songList&#x27;</span>]) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;songList&#x27;</span>, <span class="built_in">this</span>.songList);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 监听当前歌曲变化</span></span><br><span class="line">      <span class="keyword">if</span> (changes[<span class="string">&#x27;currentSong&#x27;</span>]) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.show) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 监听面板显隐</span></span><br><span class="line">      <span class="keyword">if</span> (changes[<span class="string">&#x27;show&#x27;</span>]) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;refresh&#x27;</span>);</span><br><span class="line">          <span class="keyword">if</span> (!changes[<span class="string">&#x27;show&#x27;</span>].firstChange &amp;&amp; <span class="built_in">this</span>.show) &#123;</span><br><span class="line">              <span class="built_in">this</span>.wyScroll.first.refreshScroll()</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">                  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">                          <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;, <span class="number">80</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 移动滚动条</span></span><br><span class="line">  private scrollToCurrent () &#123;</span><br><span class="line">      <span class="keyword">const</span> songListRefs = <span class="built_in">this</span>.wyScroll.first.el.nativeElement.querySelectorAll(<span class="string">&#x27;ul li&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (songListRefs.length) &#123;</span><br><span class="line">          <span class="keyword">const</span> currentLi = songListRefs[<span class="built_in">this</span>.currentIndex || <span class="number">0</span>] <span class="keyword">as</span> HTMLElement;</span><br><span class="line">          <span class="keyword">const</span> offsetTop = currentLi.offsetTop;</span><br><span class="line">          <span class="keyword">const</span> offsetHeight = currentLi.offsetHeight;</span><br><span class="line">          <span class="keyword">if</span> (offsetTop - <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.scrollY) &gt; offsetHeight * <span class="number">5</span> || offsetTop &lt; <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.scrollY)) &#123;</span><br><span class="line">              <span class="built_in">this</span>.wyScroll.first.scrollToElement(currentLi, <span class="number">300</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li>wy-scroll.component.ts<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(readonly el: ElementRef) &#123; &#125;</span><br><span class="line">	</span><br><span class="line">ngAfterViewInit (): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.bs = <span class="keyword">new</span> BScroll(<span class="built_in">this</span>.wrapRef.nativeElement, &#123;</span><br><span class="line">        scrollbar: &#123;</span><br><span class="line">            interactive: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        mouseWheel: &#123;</span><br><span class="line">            speed: <span class="number">20</span>,</span><br><span class="line">            invert: <span class="literal">false</span>,</span><br><span class="line">            easeTime: <span class="number">300</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.bs.on(<span class="string">&#x27;scrollEnd&#x27;</span>, <span class="function">(<span class="params">&#123; y &#125;</span>) =&gt;</span> <span class="built_in">this</span>.onScrollEnd.emit(y));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
先获取滚动条插件节点中所有的li，如果长度不为0即表示存在当前歌曲，此时根据当前歌曲索引拿到当前歌曲的节点，并且声明当前节点距离顶部的偏移量以及每个节点的高度。并且在初始化视图之后添加对滚动条插件的滚动结束触发机制，来将当前以滚动的距离广播给父组件。</li>
</ul>
<p><img data-src="https://img-blog.csdnimg.cn/2020121922330566.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"><br>此时要判断当前歌曲是否在可视范围内，如果在就不需要调整滚动条。当歌曲节点距离顶部的偏移量大于滚动条的Y轴偏移量以及当前节点距离顶部的偏移量小于滚动条的Y轴偏移量即表示脱离可视范围，此时就要调用插件的scrollToElement方法，将会滚动到指定的目标元素处。</p>
<p><img data-src="https://img-blog.csdnimg.cn/2020121922423385.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<hr>
<p>当点击歌单播放歌曲时，此时点击播放模式为随机后切换歌曲并打开面板将会出现当前歌曲与列表歌曲不匹配的问题。原因是播放歌曲后调整为随机模式并切换歌曲时，此时的当前歌曲索引为父组件传来的值，并没有进行更新索引。</p>
<ul>
<li>wy-player-panel.component.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> currentIndex: <span class="built_in">number</span>; <span class="comment">// 取消传入，计算当前歌曲索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据监听</span></span><br><span class="line"> ngOnChanges (changes: SimpleChanges): <span class="built_in">void</span> &#123;</span><br><span class="line">     <span class="comment">// 监听当前歌曲变化</span></span><br><span class="line">    <span class="keyword">if</span> (changes[<span class="string">&#x27;currentSong&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">            <span class="built_in">this</span>.currentIndex =  findIndex(<span class="built_in">this</span>.songList, <span class="built_in">this</span>.currentSong);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.show) &#123;</span><br><span class="line">                <span class="built_in">this</span>.scrollToCurrent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>array.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查找当前歌曲在列表中的索引</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">findIndex</span>(<span class="params">list: Song[], currentSong: Song</span>): <span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> list.findIndex(<span class="function"><span class="params">item</span> =&gt;</span> item.id === currentSong.id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
当前歌曲发生变化后，将会重新查找当前歌曲在歌曲列表中的索引。</li>
</ul>
<hr>
<p>更改完成后，刷新页面，先将模式调整为随机，此时播放歌单并点击下一曲，将会发现依然是顺序播放。原因是在首页渲染之后，点击歌单的回调中并没有判断当前播放模式。</p>
<ul>
<li>home-component.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">private</span> playState: PlayState; <span class="comment">// 当前播放模式</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.store$.pipe(select(getPlayer)).subscribe(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">this</span>.playState = res)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 点击歌单，获取歌单信息</span></span><br><span class="line">   onPlaySheet (id: <span class="built_in">number</span>) &#123;</span><br><span class="line">       <span class="built_in">this</span>.sheetServe.playSheet(id).subscribe(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList: list &#125;));</span><br><span class="line"></span><br><span class="line">           <span class="keyword">let</span> trueIndex = <span class="number">0</span>, trueList = list.slice();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.playState.playMode.type === <span class="string">&quot;random&quot;</span>) &#123;</span><br><span class="line">               trueList = shuffle(list || []);</span><br><span class="line">               trueIndex = findIndex(trueList, list[trueIndex]);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList: trueList &#125;));</span><br><span class="line">           <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex: trueIndex &#125;));</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
首页初始化时先订阅当前播放信息，在点击播放歌单时判断当前播放模式是否为随机，是则打乱歌单数组，重新计算当前歌曲的索引。 </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/e9e95ea6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/e9e95ea6/" class="post-title-link" itemprop="url">【Angular网易云】--13、底部信息与功能（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-04 11:23:38" itemprop="dateCreated datePublished" datetime="2020-12-04T11:23:38+08:00">2020-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:25:33" itemprop="dateModified" datetime="2021-01-17T16:25:33+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p>在点击播放音乐之后，歌曲的信息也要渲染到DOM中，其中关于歌曲的时长以及播放的时长也要添加上去。在信息渲染之后还要增加底部的功能，上/下一曲，播放/暂停，以及音量调节和播放模式等</p>
<hr>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="歌曲显示"><a href="#歌曲显示" class="headerlink" title="歌曲显示"></a>歌曲显示</h2><ul>
<li>wy-player.component.ts – 部分<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    duration: <span class="built_in">number</span>; <span class="comment">// 总时长</span></span><br><span class="line">    currentTime: <span class="built_in">number</span>; <span class="comment">// 当前已听时间</span></span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 监听当前歌曲</span></span><br><span class="line">    <span class="keyword">private</span> watchCurrentSong (song: Song) &#123;</span><br><span class="line">        <span class="keyword">if</span> (song) &#123;</span><br><span class="line">            <span class="built_in">this</span>.currentSong = song;</span><br><span class="line">            <span class="comment">// 返回值中的dt为毫秒，处理为秒</span></span><br><span class="line">            <span class="built_in">this</span>.duration = song.dt / <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 点击播放</span></span><br><span class="line">    onCanPlay () &#123;</span><br><span class="line">        <span class="built_in">this</span>.play();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 更新已播放时长</span></span><br><span class="line">    onTimeUpdate (e: Event) &#123;</span><br><span class="line">        <span class="built_in">this</span>.currentTime = (&lt;HTMLAudioElement&gt;e.target).currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 播放回调</span></span><br><span class="line">    <span class="keyword">private</span> play () &#123;</span><br><span class="line">        <span class="built_in">this</span>.audioEl.play();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 取值器-获取当前歌曲的小图标URL</span></span><br><span class="line">    get picUrl (): <span class="built_in">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.currentSong ? <span class="built_in">this</span>.currentSong.al.picUrl : <span class="string">&#x27;http://s4.music.126.net/style/web2/img/default/default_album.jpg&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>wy-player.component.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-player&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;head&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">&quot;picUrl&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;mask&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;play&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;words clearfix  &quot;</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;ellipsis margin-bottom-none&quot;</span>&gt;</span>&#123;&#123;currentSong?.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>  <span class="attr">class</span>=<span class="string">&quot;songs clearfix margin-bottom-none &quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of currentSong?.ar; last as isLast&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> [<span class="attr">hidden</span>]=<span class="string">&quot;isLast&quot;</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bar&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123;currentTime | formatTime&#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span> / &#123;&#123;duration |  formatTime&#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">audio</span> #<span class="attr">audio</span> [<span class="attr">src</span>]=<span class="string">&quot;currentSong?.url&quot;</span> (<span class="attr">canplay</span>)=<span class="string">&quot;onCanPlay()&quot;</span> (<span class="attr">timeupdate</span>)=<span class="string">&quot;onTimeUpdate($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
将src和歌名等信息使用插值的方式渲染进去，其中有做处理的是时间的显示，用管道做了格式化。</li>
</ul>
<hr>
<ul>
<li>format-time.pipe.ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">transform (time: <span class="built_in">number</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (time) &#123;</span><br><span class="line">        <span class="keyword">const</span> temp = time | <span class="number">0</span>; <span class="comment">// 创建临时变量存取参数，并向下取整</span></span><br><span class="line">        <span class="keyword">const</span> minute = temp / <span class="number">60</span> | <span class="number">0</span>; <span class="comment">// 计算分钟</span></span><br><span class="line">        <span class="keyword">const</span> second = (temp % <span class="number">60</span>).toString().padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>); <span class="comment">// 计算秒,转为字符是为了如果秒为个位，可在前边补0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;minute&#125;</span>:<span class="subst">$&#123;second&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;00:00&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>padStart():<br>用另一个字符串填充当前字符串(如果需要的话，会重复多次)，以便产生的字符串达到给定的长度。从当前字符串的左侧开始填充。<br><img data-src="https://img-blog.csdnimg.cn/20201212182828446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"><br>与之成对的是padEnd()，用法类似，后置填补。</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="切歌"><a href="#切歌" class="headerlink" title="切歌"></a>切歌</h2><p><img data-src="https://img-blog.csdnimg.cn/20201213160115124.png" alt="在这里插入图片描述"><br>在按钮上添加点击事件</p>
<ul>
<li><p>wy-player,componentn.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;btns&quot;</span>&gt;</span><br><span class="line">         &lt;i <span class="keyword">class</span>=<span class="string">&quot;prev&quot;</span> (click)=<span class="string">&quot;onPrev(currentIndex - 1)&quot;</span>&gt;&lt;/i&gt;</span><br><span class="line">         &lt;i <span class="keyword">class</span>=<span class="string">&quot;toggle&quot;</span> [<span class="keyword">class</span>.playing]=<span class="string">&quot;playing&quot;</span> (click)=<span class="string">&quot;onToggle()&quot;</span>&gt;&lt;/i&gt;</span><br><span class="line">         &lt;i <span class="keyword">class</span>=<span class="string">&quot;next&quot;</span> (click)=<span class="string">&quot;onNext(currentIndex + 1)&quot;</span>&gt;&lt;/i&gt;  </span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.html</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 播放-暂停</span></span><br><span class="line">onToggle () &#123;</span><br><span class="line">    <span class="comment">// 刚初始化的时候，有播放列表，但是当前播放歌曲不存在</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.currentSong) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.playList.length) &#123;</span><br><span class="line">            <span class="comment">// 刚切换歌曲，songReady未准备好</span></span><br><span class="line">            <span class="built_in">this</span>.updateIndex(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.songReady) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playing = !<span class="built_in">this</span>.playing;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.playing) &#123;</span><br><span class="line">                <span class="built_in">this</span>.audioEl.play()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.audioEl.pause()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上一曲</span></span><br><span class="line">onPrev (index: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.songReady) &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.playList.length === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.loop();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> newIndex = index &lt; <span class="number">0</span> ? <span class="built_in">this</span>.songList.length - <span class="number">1</span> : index;</span><br><span class="line">        <span class="built_in">this</span>.updateIndex(newIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下一曲</span></span><br><span class="line">onNext (index: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.songReady) &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.playList.length === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.loop();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;palyList&#x27;</span>, <span class="built_in">this</span>.playList, index);</span><br><span class="line">        <span class="keyword">const</span> newIndex = index &gt;= <span class="built_in">this</span>.playList.length ? <span class="number">0</span> : index;</span><br><span class="line">        <span class="built_in">this</span>.updateIndex(newIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单曲循环</span></span><br><span class="line"><span class="keyword">private</span> loop () &#123;</span><br><span class="line">	<span class="comment">// 设置当前播放位置为初始值</span></span><br><span class="line">    <span class="built_in">this</span>.audioEl.currentTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.play()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 切歌回调</span></span><br><span class="line"><span class="keyword">private</span> updateIndex (index: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex: index &#125;));</span><br><span class="line">    <span class="built_in">this</span>.songReady = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放事件</span></span><br><span class="line">onCanPlay () &#123;</span><br><span class="line">    <span class="built_in">this</span>.songReady = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">this</span>.play();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新已听时间</span></span><br><span class="line">onTimeUpdate (e: Event) &#123;</span><br><span class="line">    <span class="built_in">this</span>.currentTime = (&lt;HTMLAudioElement&gt;e.target).currentTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放回调</span></span><br><span class="line"><span class="keyword">private</span> play () &#123;</span><br><span class="line">    <span class="built_in">this</span>.audioEl.play();</span><br><span class="line">    <span class="built_in">this</span>.playing = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击图标，触发onNext(index： number)下一曲事件，方法中先判断歌曲是否能听，能则判断当前歌曲列表是否只有一首歌，是则循环播放，否则更改歌曲下标，播放下一首歌曲。而暂停与播放则是调用audio的原生属性。</p>
</li>
</ul>
<hr>
<h2 id="缓冲条与进度条"><a href="#缓冲条与进度条" class="headerlink" title="缓冲条与进度条"></a>缓冲条与进度条</h2><ul>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-wy-slider</span> [<span class="attr">bufferOffset</span>]=<span class="string">&quot;bufferPercent&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;percent&quot;</span> (<span class="attr">wyOnAfterChange</span>)=<span class="string">&quot;onPercentChange($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-slider</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> #<span class="attr">audio</span> [<span class="attr">src</span>]=<span class="string">&quot;currentSong?.url&quot;</span> (<span class="attr">canplay</span>)=<span class="string">&quot;onCanPlay()&quot;</span> (<span class="attr">timeupdate</span>)=<span class="string">&quot;onTimeUpdate($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新进度条</span></span><br><span class="line">  onTimeUpdate (e: Event) &#123;</span><br><span class="line">  	<span class="comment">// 当前已听时间</span></span><br><span class="line">      <span class="built_in">this</span>.currentTime = (&lt;HTMLAudioElement&gt;e.target).currentTime;</span><br><span class="line">      <span class="comment">// 进度条百分比</span></span><br><span class="line">      <span class="built_in">this</span>.percent = (<span class="built_in">this</span>.currentTime / <span class="built_in">this</span>.duration) * <span class="number">100</span>;</span><br><span class="line">      <span class="comment">// 已缓冲TimeRanges</span></span><br><span class="line">      <span class="keyword">const</span> buffered = <span class="built_in">this</span>.audioEl.buffered;</span><br><span class="line">      <span class="comment">// 先判断缓存条是否存在以及百分比是否小于100</span></span><br><span class="line">      <span class="keyword">if</span> (buffered.length &amp;&amp; <span class="built_in">this</span>.bufferPercent &lt; <span class="number">100</span>) &#123;</span><br><span class="line">      	<span class="comment">// 缓冲进度百分比</span></span><br><span class="line">          <span class="built_in">this</span>.bufferPercent = (buffered.end(<span class="number">0</span>) / <span class="built_in">this</span>.duration) * <span class="number">100</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img-blog.csdnimg.cn/2020121318030524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
<hr>
<h2 id="音量控制"><a href="#音量控制" class="headerlink" title="音量控制"></a>音量控制</h2><p>初始化网页时给与默认音量，音量按钮可以设置audio中volume的大小，另外一个需求就是音量小面板的显隐，在点击底部黑色框之外的地方使其隐藏。</p>
<ul>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;m-player&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;selfClick = true&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--音量图标--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;volume&quot;</span> <span class="attr">title</span>=<span class="string">&quot;音量&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;toggleVolPanel()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--音量组件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control-vol&quot;</span> [<span class="attr">hidden</span>]=<span class="string">&quot;!showVolumePanel&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">app-wy-slider</span> [<span class="attr">wyVertical</span>]=<span class="string">&quot;true&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;volume&quot;</span> (<span class="attr">ngModelChange</span>)=<span class="string">&quot;onVolumeChange($event)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-wy-slider</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>togglePanel()来触发面板的显隐，wyVertical来设置进度条的方向，volume绑定声音的初始值，onVolumeChange()做事件监听。</p>
</li>
<li><p>wy-player.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 滑动播放条</span></span><br><span class="line">onPercentChange (e: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.audioEl.currentTime = <span class="built_in">this</span>.duration * (e / <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置音量</span></span><br><span class="line">onVolumeChange (per: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.audioEl.volume = per / <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制音量面板</span></span><br><span class="line">toggleVolPanel () &#123;</span><br><span class="line">    <span class="built_in">this</span>.togglePanel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 音量回调</span></span><br><span class="line">togglePanel () &#123;</span><br><span class="line">    <span class="built_in">this</span>.showVolumePanel = !<span class="built_in">this</span>.showVolumePanel;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.showVolumePanel) &#123;</span><br><span class="line">        <span class="built_in">this</span>.bindDocumentClickListener();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.unbindDocumentClickListener();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定音量事件</span></span><br><span class="line"><span class="keyword">private</span> bindDocumentClickListener () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;win&#x27;</span>, <span class="built_in">this</span>.winClick);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.winClick) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;self&#x27;</span>, <span class="built_in">this</span>.selfClick);</span><br><span class="line">        <span class="built_in">this</span>.winClick = fromEvent(<span class="built_in">this</span>.doc, <span class="string">&#x27;click&#x27;</span>).subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.selfClick) &#123; <span class="comment">// 说明点击了播放器以外的地方</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;self&#x27;</span>, <span class="built_in">this</span>.selfClick);</span><br><span class="line">                <span class="built_in">this</span>.showVolumePanel = <span class="literal">false</span>;</span><br><span class="line">                <span class="built_in">this</span>.unbindDocumentClickListener();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.selfClick = <span class="literal">false</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解绑音量事件</span></span><br><span class="line"><span class="keyword">private</span> unbindDocumentClickListener () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;win&#x27;</span>, <span class="built_in">this</span>.winClick);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.winClick) &#123;</span><br><span class="line">        <span class="built_in">this</span>.winClick.unsubscribe();</span><br><span class="line">        <span class="built_in">this</span>.winClick = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>在点击音量按钮之后，触发toggleVolPanel 方法，进而触发回调，在togglePanel 中现更改面板的显隐，再根据显隐true或false来对下一次点击进行绑定或解绑。当第一次点击时，同时也会触发组件的click事件（”selfClick = true”），这时也会进行音量事件的绑定。此时subscript类型的winClick未赋值，将会为其订阅一个click事件，如果selfclick不存在即表示点击了底部面板之外的地方，此时会隐藏音量面板，selfclick取false，在将事件解绑–取消订阅并将subscript类型的winClick置空。</strong></p>
<ul>
<li>wy-slider-component,ts<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> onDragEnd () &#123;</span><br><span class="line">      <span class="built_in">this</span>.wyOnAfterChange.emit(<span class="built_in">this</span>.value);</span><br><span class="line">      <span class="built_in">this</span>.toggleDragMoving(<span class="literal">false</span>);</span><br><span class="line">      <span class="built_in">this</span>.cdr.markForCheck();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
还有一个小优化在滑动进度条的时候，未优化之前歌曲会随着进度条的滑动而播放，声音就会很嘈杂，优化在鼠标释放之后才会给组件传送滑动的值。</li>
</ul>
<hr>
<h2 id="播放模式"><a href="#播放模式" class="headerlink" title="播放模式"></a>播放模式</h2><p>播放模式有三种：随机播放、单曲循环和循环播放，关于三种模式只需要对其进项模式转换即可，在reducer中拿到的songlist进行操作。随机播放即将playList打乱即可。</p>
<ul>
<li><p>wy-player.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">i</span> [<span class="attr">ngClass</span>]=<span class="string">&quot;currentMode.type&quot;</span> [<span class="attr">title</span>]=<span class="string">&quot;currentMode.label&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;changeMode()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>图标样式和悬浮显示要随着mode的改变而动态改变。</p>
</li>
<li><p>wy-player.compoentn.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> modeTypes: PlayMode[] = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">&#x27;loop&#x27;</span>,</span><br><span class="line">        label: <span class="string">&#x27;循环&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">&#x27;random&#x27;</span>,</span><br><span class="line">        label: <span class="string">&#x27;随机&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">&#x27;singleLoop&#x27;</span>,</span><br><span class="line">        label: <span class="string">&#x27;单曲循环&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">    currentMode: PlayMode; <span class="comment">// 当前模式</span></span><br><span class="line">    modeCount = <span class="number">0</span>; <span class="comment">// 记录点击次数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听播放模式</span></span><br><span class="line">    <span class="keyword">private</span> watchPlayMode (mode: PlayMode) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;mode&#x27;</span>, mode);</span><br><span class="line">        <span class="built_in">this</span>.currentMode = mode;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.songList) &#123;</span><br><span class="line">            <span class="keyword">let</span> list = <span class="built_in">this</span>.songList.slice();</span><br><span class="line">            <span class="keyword">if</span> (mode.type === <span class="string">&#x27;random&#x27;</span>) &#123;</span><br><span class="line">                list = shuffle(<span class="built_in">this</span>.songList);</span><br><span class="line">                <span class="built_in">this</span>.updateCurrentIndex(list, <span class="built_in">this</span>.currentSong);</span><br><span class="line">                <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList: list &#125;))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;list&#x27;</span>, list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 顺序打乱之后更新当前歌曲在新数组中的索引</span></span><br><span class="line">    <span class="keyword">private</span> updateCurrentIndex (list: Song[], song: Song) &#123;</span><br><span class="line">        <span class="keyword">const</span> newIndex = list.findIndex(<span class="function"><span class="params">item</span> =&gt;</span> item.id === song.id);</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex: newIndex &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置播放模式</span></span><br><span class="line">    changeMode () &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetPlayMode(&#123; playMode: modeTypes[++<span class="built_in">this</span>.modeCount % <span class="number">3</span>] &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>在触发更改播放模式changeMode(）时，会根据点击的次数来从所有模式modeTypes中取到下一个模式。通过设置动作SetPlayMode将当前模式更改。此时将会触发模式的监听方法，DOM将会根据mode来更换图标和文字。然后进行判断，如果此时歌曲列表存在并且播放模式是随机，就会打乱当前播放列表数组并且更新当前歌曲所在数组的索引与播放列表。</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 打乱数组</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shuffle</span>&lt;<span class="title">T</span>&gt; (<span class="params">arr: T[]</span>): <span class="title">T</span>[] </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = arr.slice();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; result.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 0和1之间的一个随机数</span></span><br><span class="line">        <span class="keyword">const</span> j = getRandomInt([<span class="number">0</span>, <span class="number">1</span>]);</span><br><span class="line">        [result[i], result[j]] = [result[j], result[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 取[min, max]之间的一个随机数</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getRandomInt</span> (<span class="params">range: [<span class="built_in">number</span>, <span class="built_in">number</span>]</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * (range[<span class="number">1</span>] - range[<span class="number">0</span>] + <span class="number">1</span>) + range[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>代码到后期会对之前写的进行调整，可能会出现更改后遗漏更新的情况，所以在贴代码的时候会尽量跟clone下来的保持一致，而且api在现在这个版本中有一些变化，就单说获取歌单歌曲列表就有些许差异，但总体上不影响数据</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lucksun.work/posts/ad61347b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Luck_SUN">
      <meta itemprop="description" content="凛冬散尽，星河长明">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Luck_SUN">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/ad61347b/" class="post-title-link" itemprop="url">【Angular网易云】--获取完整数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-03 11:23:38" itemprop="dateCreated datePublished" datetime="2020-12-03T11:23:38+08:00">2020-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-17 16:08:40" itemprop="dateModified" datetime="2021-01-17T16:08:40+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CloudMusic/" itemprop="url" rel="index"><span itemprop="name">CloudMusic</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="现有问题"><a href="#现有问题" class="headerlink" title="现有问题"></a>现有问题</h1><p>根据playList/detail 的API拿到的数据是不完整的，tracks中只存在所有歌曲的前几条，因此要获取trackIds进而请求song/detail 的API。<br><img data-src="https://img-blog.csdnimg.cn/20201219104145174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<hr>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><ul>
<li><p>home.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--热门歌单开始--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;down&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;down-wrap&quot;</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">app-single-sheet</span></span></span><br><span class="line"><span class="tag">               <span class="attr">class</span>=<span class="string">&quot;sheet-item&quot;</span></span></span><br><span class="line"><span class="tag">               *<span class="attr">ngFor</span>=<span class="string">&quot;let item of songSheetList&quot;</span></span></span><br><span class="line"><span class="tag">               [<span class="attr">sheet</span>]=<span class="string">&quot;item&quot;</span></span></span><br><span class="line"><span class="tag">               (<span class="attr">onPlay</span>)=<span class="string">&quot;onPlaySheet($event)&quot;</span></span></span><br><span class="line"><span class="tag">             &gt;</span><span class="tag">&lt;/<span class="name">app-single-sheet</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--热门歌单结束--&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>single-sheet.component.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;cover&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">&quot;sheet.picUrl&quot;</span> [<span class="attr">alt</span>]=<span class="string">&quot;sheet.name&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;num&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon erji&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; sheet.playCount | playCount &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;icon play&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;playSheet(sheet.id)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;dec&quot;</span>&gt;</span>&#123;&#123; sheet.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>single-sheet.component.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Output</span>() onPlay = <span class="keyword">new</span> EventEmitter&lt;<span class="built_in">number</span>&gt;();</span><br><span class="line"> </span><br><span class="line">playSheet(id: <span class="built_in">number</span>)&#123;</span><br><span class="line">  <span class="built_in">this</span>.onPlay.emit(id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击子组件，触发playSheet回调，将拿到的歌单ID发送给父组件</p>
</li>
<li><p>home.componetn.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击歌单，获取歌单信息</span></span><br><span class="line">onPlaySheet (id: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.sheetServe.playSheet(id).subscribe(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetSongList(&#123; songList: list &#125;));</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetPlayList(&#123; playList: list &#125;));</span><br><span class="line">        <span class="built_in">this</span>.store$.dispatch(SetCurrentIndex(&#123; currentIndex: <span class="number">0</span> &#125;));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sheet.service.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 获取歌单详细信息</span></span><br><span class="line">playSheet (id: <span class="built_in">number</span>): Observable&lt;Song[]&gt; &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.getSongSheetDetail(id)</span><br><span class="line">         .pipe(</span><br><span class="line">             pluck(<span class="string">&#x27;trackIds&#x27;</span>),</span><br><span class="line">             switchMap(<span class="function"><span class="params">trackIds</span> =&gt;</span> <span class="built_in">this</span>.getAllSongDetail(trackIds))</span><br><span class="line">         )</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="comment">// 获取歌单详情</span></span><br><span class="line"> getSongSheetDetail (id: <span class="built_in">number</span>): Observable&lt;SongSheet&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;id&#x27;</span>, id.toString());</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.url + <span class="string">&quot;playlist/detail&quot;</span>, &#123; params &#125;)</span><br><span class="line">         .pipe(map(<span class="function">(<span class="params">res: &#123; playlist: SongSheet &#125;</span>) =&gt;</span> res.playlist));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 获取全部歌单详情</span></span><br><span class="line">    getAllSongDetail (trackIds: Song[]): Observable&lt;Song[]&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> songArr = <span class="built_in">Array</span>.isArray(trackIds) ? trackIds.slice() : [trackIds];</span><br><span class="line">     <span class="keyword">const</span> ids = songArr.map(<span class="function"><span class="params">item</span> =&gt;</span> item.id).join(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">     <span class="keyword">const</span> params = <span class="keyword">new</span> HttpParams().set(<span class="string">&#x27;ids&#x27;</span>, ids)</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.http.get(<span class="built_in">this</span>.url + <span class="string">&quot;song/detail&quot;</span>, &#123; params &#125;)</span><br><span class="line">         .pipe(map(<span class="function">(<span class="params">res: &#123; songs: Song[] &#125;</span>) =&gt;</span> res.songs), switchMap(<span class="function"><span class="params">songs</span> =&gt;</span> <span class="built_in">this</span>.songServe.getSongList(songs)))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>父组件调用playSheet()时将会先调用getSongSheetDetail 来获取API返回值中的playList属性，在管道中通过pluck拿到其中的trackIds，这时通过getAllSongDetail 方法将所有ids发给song/detailAPI，将拿到的数据给到获取URL的API中，再将其拼接在一起即可返回所有数据</p>
<p><img data-src="https://img-blog.csdnimg.cn/20201219140313741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bmdvb2RsdWNrNjY2,size_16,color_FFFFFF,t_70"></p>
<hr>
<p>这样虽然能拿到很多数据，但通过对比发现会缺少一些数据，对于里边的参数不是很清楚，而且关于获取所有数据正确与否也尚待验证。目前这个数据量只是为了验证使用betterScroll插件是否执行，所以在埋一个坑，后需调整吧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Luck_SUN"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Luck_SUN</p>
  <div class="site-description" itemprop="description">凛冬散尽，星河长明</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/sunwenwei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sunwenwei" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sunWorkOne@163.com" title="E-Mail → mailto:sunWorkOne@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6411331687?is_all=1" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6411331687?is_all&#x3D;1" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/sungoodluck666" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sungoodluck666" rel="noopener" target="_blank"><i class="fa fa-eye fa-fw"></i>CSDN</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Luck_SUN</span>
    <span class="post-meta-divider"><br/></span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">184k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:47</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://lucksun.work/page/2/',]
      });
      });
  </script>

</body>
<script type="text/javascript" src="/js/click_show_text.js"></script>
</html>
